{"StableSR_doc/README":{"slug":"StableSR_doc/README","filePath":"StableSR_doc/README.md","title":"README","links":[],"tags":[],"content":"StableSR_doc"},"StableSR_doc/ldm/models/diffusion/ddpm/DiffusionWrapper(pl.LightningModule)":{"slug":"StableSR_doc/ldm/models/diffusion/ddpm/DiffusionWrapper(pl.LightningModule)","filePath":"StableSR_doc/ldm/models/diffusion/ddpm/DiffusionWrapper(pl.LightningModule).md","title":"DiffusionWrapper(pl.LightningModule)","links":[],"tags":[],"content":"class DiffusionWrapper(pl.LightningModule):\n    def __init__(self, diff_model_config, conditioning_key):\n        super().__init__()\n        self.diffusion_model = instantiate_from_config(diff_model_config) # [[instantiate_from_config]]\n        self.conditioning_key = conditioning_key\n        assert self.conditioning_key in [None, &#039;concat&#039;, &#039;crossattn&#039;, &#039;hybrid&#039;, &#039;adm&#039;]\n \n    def forward(self, x, t, c_concat: list = None, c_crossattn: list = None, struct_cond=None, seg_cond=None):\n        if self.conditioning_key is None: # [[#noneæ— æ¡ä»¶æ‰©æ•£unconditional|Noneï¼šæ— æ¡ä»¶æ‰©æ•£ï¼ˆUnconditionalï¼‰]]\n            out = self.diffusion_model(x, t)\n        elif self.conditioning_key == &#039;concat&#039;: # [[#concaté€šé“æ‹¼æ¥channel-concat|concatï¼šé€šé“æ‹¼æ¥ï¼ˆChannel Concatï¼‰]]\n            xc = torch.cat([x] + c_concat, dim=1) \n            out = self.diffusion_model(xc, t)\n        elif self.conditioning_key == &#039;crossattn&#039;: # [[#crossattnäº¤å‰æ³¨æ„åŠ›cross-attention|crossattnï¼šäº¤å‰æ³¨æ„åŠ›ï¼ˆCross-Attentionï¼‰]]\n            cc = torch.cat(c_crossattn, 1)\n            if seg_cond is None:\n                out = self.diffusion_model(x, t, context=cc, struct_cond=struct_cond)\n            else:\n                out = self.diffusion_model(x, t, context=cc, struct_cond=struct_cond, seg_cond=seg_cond)\n        elif self.conditioning_key == &#039;hybrid&#039;: # [[#hybridé€šé“æ‹¼æ¥--äº¤å‰æ³¨æ„åŠ›concat--cross-attn|hybridï¼šé€šé“æ‹¼æ¥ + äº¤å‰æ³¨æ„åŠ›ï¼ˆConcat + Cross-Attnï¼‰]]\n            xc = torch.cat([x] + c_concat, dim=1)\n            cc = torch.cat(c_crossattn, 1)\n            out = self.diffusion_model(xc, t, context=cc)\n        elif self.conditioning_key == &#039;adm&#039;: # [[#admæ ‡ç­¾æ³¨å…¥classifier-free-guidance|admï¼šæ ‡ç­¾æ³¨å…¥ï¼ˆClassifier-free Guidanceï¼‰]]\n            cc = c_crossattn[0]\n            out = self.diffusion_model(x, t, y=cc)\n        else:\n            raise NotImplementedError()\n \n        return out\n \nDiffusionWrapper.forward() ä¸­ conditioning_key çš„äº”ç§æ¨¡å¼è§£æ\nåœ¨ StableSR æˆ– Latent Diffusion ä¸­ï¼Œconditioning_key å†³å®šäº†æ¡ä»¶ä¿¡æ¯å¦‚ä½•æ³¨å…¥åˆ°æ‰©æ•£æ¨¡å‹ï¼ˆé€šå¸¸æ˜¯ UNetï¼Œå¦‚ UNetModelDualConv2dï¼‰ä¸­ã€‚è¯¥å‚æ•°å½±å“çš„æ˜¯ DiffusionWrapper åœ¨ forward é˜¶æ®µå¦‚ä½•ç»„ç»‡è¾“å…¥ï¼Œå¹¶é€šè¿‡å“ªäº›é€šè·¯å°†æ¡ä»¶ä¿¡æ¯ä¼ é€’åˆ°æ‰©æ•£ç½‘ç»œã€‚\n\nNoneï¼šæ— æ¡ä»¶æ‰©æ•£ï¼ˆUnconditionalï¼‰\nout = self.diffusion_model(x, t)\n\nä¸ä½¿ç”¨ä»»ä½•æ¡ä»¶ä¿¡æ¯ï¼›\nè¾“å…¥ä»…ä¸ºå¸¦å™ªå›¾åƒ x å’Œæ—¶é—´æ­¥ tï¼›\né€šå¸¸ç”¨äºçº¯å›¾åƒå»ºæ¨¡ã€åˆæœŸè®­ç»ƒæˆ– unconditional generationã€‚\n\n\nconcatï¼šé€šé“æ‹¼æ¥ï¼ˆChannel Concatï¼‰\nxc = torch.cat([x] + c_concat, dim=1)\nout = self.diffusion_model(xc, t)\n\næ¡ä»¶ä»¥å›¾åƒå½¢å¼æä¾›ï¼ˆå¦‚ä½æ¸…å›¾ã€è¾¹ç¼˜å›¾ã€å°æ³¢å­å¸¦ï¼‰ï¼Œç›´æ¥æ‹¼æ¥åˆ° x ä¸Šï¼›\né€šé“ç»´åº¦å˜ä¸º C + C_condï¼›\næ˜¯ SR3 ä½¿ç”¨çš„å…¸å‹æ¡ä»¶æ³¨å…¥æ–¹æ³•ï¼›\næ˜¯ä¼ ç»Ÿsr3çš„æ–¹æ³•,ç®€å•é«˜æ•ˆï¼Œä½†çµæ´»æ€§è¾ƒå·®ã€‚\n\n\ncrossattnï¼šäº¤å‰æ³¨æ„åŠ›ï¼ˆCross-Attentionï¼‰\ncc = torch.cat(c_crossattn, 1)\nout = self.diffusion_model(x, t, context=cc, struct_cond=..., seg_cond=...)\n\næ¡ä»¶ä¿¡æ¯ï¼ˆå¦‚ç»“æ„å›¾ã€å°æ³¢å›¾ã€æ–‡æœ¬ï¼‰é€šè¿‡ cond_stage_model ç¼–ç ä¸º latent å‘é‡ï¼›\nè¿™äº› latent å‘é‡ä½œä¸º contextï¼Œä¼ å…¥ UNet å†…éƒ¨çš„ CrossAttention æ¨¡å—ï¼›\nå¯é€‰åœ°æ”¯æŒç»“æ„æ¡ä»¶ struct_cond å’Œè¯­ä¹‰æ¡ä»¶ seg_condï¼›\næ˜¯ç°ä»£æ¡ä»¶æ‰©æ•£ï¼ˆå¦‚ Stable Diffusionï¼‰æœ€å¸¸ç”¨ç­–ç•¥ï¼Œçµæ´»ä¸”è¡¨è¾¾åŠ›å¼ºã€‚\n\n\nhybridï¼šé€šé“æ‹¼æ¥ + äº¤å‰æ³¨æ„åŠ›ï¼ˆConcat + Cross-Attnï¼‰\nxc = torch.cat([x] + c_concat, dim=1)\ncc = torch.cat(c_crossattn, 1)\nout = self.diffusion_model(xc, t, context=cc)\n\nåŒæ—¶ä½¿ç”¨ concat å’Œ cross-attention ä¸¤ç§é€šè·¯æ³¨å…¥æ¡ä»¶ï¼›\né€šé“æ‹¼æ¥ä¼ é€’ä½çº§ä¿¡æ¯ï¼ˆç»†èŠ‚ã€è¾¹ç¼˜ï¼‰ï¼›\ncross-attn ä¼ é€’é«˜çº§è¯­ä¹‰ï¼ˆç»“æ„ latentã€å°æ³¢ latentï¼‰ï¼›\nåœ¨ StableSR ä¸­ï¼Œé€šå¸¸ä¸¤è·¯æ¡ä»¶ä¿¡æ¯éƒ½æ¥æºäºåŒä¸€ä¸ªç»“æ„å›¾ï¼Œåªæ˜¯ç»è¿‡ä¸åŒè·¯å¾„å¤„ç†ï¼›\nå¹³è¡¡å¼•å¯¼æ€§ä¸çµæ´»æ€§ï¼Œæ˜¯æ¨èæ¨¡å¼ä¹‹ä¸€ã€‚\n\n\nadmï¼šæ ‡ç­¾æ³¨å…¥ï¼ˆClassifier-free Guidanceï¼‰\ncc = c_crossattn[0]\nout = self.diffusion_model(x, t, y=cc)\n\nç”¨äºç±»åˆ«æˆ– token ä½œä¸ºæ ‡ç­¾æ¡ä»¶ï¼ˆå¦‚ ImageNet class labelï¼‰ï¼›\ny=cc è¡¨ç¤ºå°†æ¡ä»¶ä½œä¸ºç±»æ ‡ç­¾æ³¨å…¥ï¼›\néœ€è¦æ‰©æ•£æ¨¡å‹æ”¯æŒ y è¾“å…¥ï¼ˆå¦‚é€šè¿‡ ConditionalBatchNormã€embedding ç­‰ï¼‰ï¼›\nå¸¸è§äº ADM/DDPMv2 ç­‰åˆ†ç±»æ¡ä»¶ç”Ÿæˆåœºæ™¯ã€‚\n\n\næ€»ç»“\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nconditioning_keyæ¡ä»¶æ³¨å…¥æ–¹å¼å…¸å‹ç”¨é€”Noneæ— æ¡ä»¶çº¯å›¾åƒå»ºæ¨¡&#039;concat&#039;é€šé“æ‹¼æ¥SR3ã€ç»“æ„å›¾å¼•å¯¼&#039;crossattn&#039;äº¤å‰æ³¨æ„åŠ›Stable Diffusionã€ç»“æ„/æ–‡æœ¬å¼•å¯¼&#039;hybrid&#039;æ‹¼æ¥ + æ³¨æ„åŠ›StableSRã€å°æ³¢ + ç»“æ„è”åˆå¼•å¯¼&#039;adm&#039;æ ‡ç­¾è¾“å…¥åˆ†ç±»æ¡ä»¶ç”Ÿæˆï¼ˆå¦‚ class-conditional DDPMï¼‰\nå®é™…åº”ç”¨ä¸­ï¼Œå¯æ ¹æ®æ¡ä»¶ç±»å‹å’Œä»»åŠ¡ç›®æ ‡çµæ´»é€‰æ‹©æˆ–ç»„åˆè¿™äº›æ¨¡å¼ã€‚"},"StableSR_doc/ldm/models/diffusion/ddpm/Module_info":{"slug":"StableSR_doc/ldm/models/diffusion/ddpm/Module_info","filePath":"StableSR_doc/ldm/models/diffusion/ddpm/Module_info.md","title":"Module_info","links":["StableSR_doc/ldm/models/diffusion/ddpm/torch2img","StableSR_doc/ldm/models/diffusion/ddpm/cal_pca_components","StableSR_doc/ldm/models/diffusion/ddpm/visualize_fea","StableSR_doc/ldm/models/diffusion/ddpm/calc_mean_std","StableSR_doc/ldm/models/diffusion/ddpm/adaptive_instance_normalization","StableSR_doc/ldm/models/diffusion/ddpm/space_timesteps","StableSR_doc/ldm/models/diffusion/ddpm/disabled_train","StableSR_doc/ldm/models/diffusion/ddpm/uniform_on_device","StableSR_doc/ldm/models/diffusion/ddpm/class-DDPM/DDPM(pl.LightningModule)","LatentDiffusion(DDPM)","LatentDiffusionSRTextWT(DDPM)","LatentDiffusionSRTextWTFFHQ(LatentDiffusionSRTextWT)","StableSR_doc/ldm/models/diffusion/ddpm/DiffusionWrapper(pl.LightningModule)","Layout2ImgDiffusion(LatentDiffusion)"],"tags":[],"content":"\n\n                  \n                  UML å›¾è§£ï¼šddpm.pyæ–‡ä»¶ç»“æ„ \n                  \n                \n\n\n\nâ€˜ldm.models.diffusion.ddpmâ€™ ä¸­å„ä¸ªç±»çš„å…³ç³»ã€‚\n\n\n\nFunctions\ntorch2img\ncal_pca_components\nvisualize_fea\ncalc_mean_std\nadaptive_instance_normalization\nspace_timesteps\ndisabled_train\nuniform_on_device\nClasses\nDDPM(pl.LightningModule)\nLatentDiffusion(DDPM)\nLatentDiffusionSRTextWT(DDPM)\nLatentDiffusionSRTextWTFFHQ(LatentDiffusionSRTextWT)\nDiffusionWrapper(pl.LightningModule)\nLayout2ImgDiffusion(LatentDiffusion)"},"StableSR_doc/ldm/models/diffusion/ddpm/adaptive_instance_normalization":{"slug":"StableSR_doc/ldm/models/diffusion/ddpm/adaptive_instance_normalization","filePath":"StableSR_doc/ldm/models/diffusion/ddpm/adaptive_instance_normalization.md","title":"adaptive_instance_normalization","links":[],"tags":[],"content":""},"StableSR_doc/ldm/models/diffusion/ddpm/cal_pca_components":{"slug":"StableSR_doc/ldm/models/diffusion/ddpm/cal_pca_components","filePath":"StableSR_doc/ldm/models/diffusion/ddpm/cal_pca_components.md","title":"cal_pca_components","links":[],"tags":[],"content":""},"StableSR_doc/ldm/models/diffusion/ddpm/calc_mean_std":{"slug":"StableSR_doc/ldm/models/diffusion/ddpm/calc_mean_std","filePath":"StableSR_doc/ldm/models/diffusion/ddpm/calc_mean_std.md","title":"calc_mean_std","links":[],"tags":[],"content":""},"StableSR_doc/ldm/models/diffusion/ddpm/class-DDPM/DDPM(pl.LightningModule)":{"slug":"StableSR_doc/ldm/models/diffusion/ddpm/class-DDPM/DDPM(pl.LightningModule)","filePath":"StableSR_doc/ldm/models/diffusion/ddpm/class DDPM/DDPM(pl.LightningModule).md","title":"DDPM(pl.LightningModule)","links":["register_schedule","DDPM","_get_rows_from_list","configure_optimizers","forward","get_input","get_loss","get_v","StableSR_doc/ldm/models/diffusion/ddpm/class-DDPM/init_from_ckpt","on_train_batch_end","p_losses","p_mean_variance","predict_start_from_noise","predict_start_from_z_and_v","q_mean_variance","q_posterior","q_sample","q_sample_respace","shared_step","training_step"],"tags":[],"content":"Class: DDPM\nInheritance Tree (MRO):\n\nDDPM\nLightningModule\nABC\nDeviceDtypeModuleMixin\nHyperparametersMixin\nGradInformation\nModelIO\nModelHooks\nDataHooks\nCheckpointHooks\nModule\nobject\n\nInstance Attributes (from self.xxx assignments):\n\nparameterization (defined in: [[init]])\ncond_stage_model (defined in: [[init]])\nclip_denoised (defined in: [[init]])\nlog_every_t (defined in: [[init]])\nfirst_stage_key (defined in: [[init]])\nimage_size (defined in: [[init]])\nchannels (defined in: [[init]])\nuse_positional_encodings (defined in: [[init]])\nmodel (defined in: [[init]])\nuse_ema (defined in: [[init]])\nuse_scheduler (defined in: [[init]])\nv_posterior (defined in: [[init]])\noriginal_elbo_weight (defined in: [[init]])\nl_simple_weight (defined in: [[init]])\nloss_type (defined in: [[init]])\nlearn_logvar (defined in: [[init]])\nlogvar (defined in: [[init, init]])\nmodel_ema (defined in: [[init]])\nscheduler_config (defined in: [[init]])\nmonitor (defined in: [[init]])\nnum_timesteps (defined in: register_schedule)\nlinear_start (defined in: register_schedule)\nlinear_end (defined in: register_schedule)\n\nProject-defined Methods:\n\n[[init]]  â†  DDPM\n_get_rows_from_list  â†  DDPM\nconfigure_optimizers  â†  DDPM\nforward  â†  DDPM\nget_input  â†  DDPM\nget_loss  â†  DDPM\nget_v  â†  DDPM\ninit_from_ckpt  â†  DDPM\non_train_batch_end  â†  DDPM\np_losses  â†  DDPM\np_mean_variance  â†  DDPM\npredict_start_from_noise  â†  DDPM\npredict_start_from_z_and_v  â†  DDPM\nq_mean_variance  â†  DDPM\nq_posterior  â†  DDPM\nq_sample  â†  DDPM\nq_sample_respace  â†  DDPM\nregister_schedule  â†  DDPM\nshared_step  â†  DDPM\ntraining_step  â†  DDPM\n\nProject-defined Attributes:"},"StableSR_doc/ldm/models/diffusion/ddpm/class-DDPM/__init__":{"slug":"StableSR_doc/ldm/models/diffusion/ddpm/class-DDPM/__init__","filePath":"StableSR_doc/ldm/models/diffusion/ddpm/class DDPM/__init__.md","title":"__init__","links":["StableSR_doc/pytorch-lightning"],"tags":[],"content":"init å‡½æ•°ä»‹ç»\nclass DDPM(pl.LightningModule): # [[pytorch lightning#pllightningmoudule|pl.LightningMoudule]]\n    # classic DDPM with Gaussian diffusion, in image space\n    def __init__(self,\n                 unet_config,\n                 timesteps=1000,\n                 beta_schedule=&quot;linear&quot;,\n                 loss_type=&quot;l2&quot;,\n                 ckpt_path=None,\n                 ignore_keys=[],\n                 load_only_unet=False,\n                 monitor=&quot;val/loss&quot;,\n                 use_ema=True,\n                 first_stage_key=&quot;image&quot;,\n                 image_size=256,\n                 channels=3,\n                 log_every_t=100,\n                 clip_denoised=True,\n                 linear_start=1e-4,\n                 linear_end=2e-2,\n                 cosine_s=8e-3,\n                 given_betas=None,\n                 original_elbo_weight=0.,\n                 v_posterior=0.,  # weight for choosing posterior variance as sigma = (1-v) * beta_tilde + v * beta\n                 l_simple_weight=1.,\n                 conditioning_key=None,\n                 parameterization=&quot;eps&quot;,  # all assuming fixed variance schedules\n                 scheduler_config=None,\n                 use_positional_encodings=False,\n                 learn_logvar=False,\n                 logvar_init=0.,\n                 ):\n        super().__init__() \n        # [[#parameterization|parameterization]]\n        assert parameterization in [&quot;eps&quot;, &quot;x0&quot;, &quot;v&quot;], &#039;currently only supporting &quot;eps&quot; and &quot;x0&quot; and &quot;v&quot;&#039;\n        self.parameterization = parameterization\n        print(f&quot;{self.__class__.__name__}: Running in {self.parameterization}-prediction mode&quot;)\n        self.cond_stage_model = None\n        self.clip_denoised = clip_denoised\n        self.log_every_t = log_every_t\n        self.first_stage_key = first_stage_key\n        self.image_size = image_size  # try conv?\n        self.channels = channels\n        self.use_positional_encodings = use_positional_encodings\n        self.model = DiffusionWrapper(unet_config, conditioning_key) # [[DiffusionWrapper(pl.LightningModule)]]\n        count_params(self.model, verbose=True) # [[#line-45-to-57--ddpm__init__-ä¸­æ¨¡å‹ç®¡ç†è°ƒåº¦å™¨ä¸æŸå¤±æƒé‡éƒ¨åˆ†è§£æ|line 45 to 57 ğŸ”§ `DDPM.__init__` ä¸­æ¨¡å‹ç®¡ç†ã€è°ƒåº¦å™¨ä¸æŸå¤±æƒé‡éƒ¨åˆ†è§£æ]]\n        self.use_ema = use_ema\n        if self.use_ema:\n            self.model_ema = LitEma(self.model)\n            print(f&quot;Keeping EMAs of {len(list(self.model_ema.buffers()))}.&quot;)\n \n        self.use_scheduler = scheduler_config is not None\n        if self.use_scheduler:\n            self.scheduler_config = scheduler_config\n \n        self.v_posterior = v_posterior\n        self.original_elbo_weight = original_elbo_weight\n        self.l_simple_weight = l_simple_weight\n \n        if monitor is not None: # [[#-pytorch-lightning-ä¸­çš„-monitor-å‚æ•°ç®€æ|ğŸ“ˆ PyTorch Lightning ä¸­çš„ `monitor` å‚æ•°ç®€æ]]\n            self.monitor = monitor \n        if ckpt_path is not None: # åŠ è½½é¢„è®­ç»ƒæ¨¡å‹\n            self.init_from_ckpt(ckpt_path, ignore_keys=ignore_keys, only_model=load_only_unet) # [[init_from_ckpt]]\n\t\t# [[#line-64-to-end|line 64 to end]]\n\t\t# [[#1-æ³¨å†Œè°ƒåº¦è¡¨beta-schedule|1. æ³¨å†Œè°ƒåº¦è¡¨ï¼ˆbeta scheduleï¼‰]]\n        self.register_schedule(given_betas=given_betas, beta_schedule=beta_schedule, timesteps=timesteps,\n                               linear_start=linear_start, linear_end=linear_end, cosine_s=cosine_s)\n\t\t# [[#2-è®¾ç½®æŸå¤±å‡½æ•°ç±»å‹|2. è®¾ç½®æŸå¤±å‡½æ•°ç±»å‹]]\n        self.loss_type = loss_type\n\t\t# [[#logvar-åœ¨-ddpm-æ‰©æ•£æ¨¡å‹ä¸­çš„ä½œç”¨ä¸å®ç°|logvar åœ¨ DDPM æ‰©æ•£æ¨¡å‹ä¸­çš„ä½œç”¨ä¸å®ç°]]\n        self.learn_logvar = learn_logvar\n        self.logvar = torch.full(fill_value=logvar_init, size=(self.num_timesteps,))\n        if self.learn_logvar:\n            self.logvar = nn.Parameter(self.logvar, requires_grad=True)\n \nparameterization\n\nparameterization: æ‰©æ•£æ¨¡å‹çš„é¢„æµ‹ç›®æ ‡ï¼Œæœ‰ä¸‰ç§ï¼š\n\n&quot;eps&quot;: å™ªå£°é¢„æµ‹ï¼ˆæœ€å¸¸ç”¨ï¼‰\n&quot;x0&quot;: é¢„æµ‹åŸå§‹å›¾åƒ\n&quot;v&quot;: v-pred æ–¹æ¡ˆï¼Œå¹³è¡¡ä¸¤ä¸ªæç«¯\n\n\næ–­è¨€é™åˆ¶åªæ”¯æŒä¸Šè¿°ä¸‰ç§æ¨¡å¼\n\nline 45 to 57 ğŸ”§ DDPM.__init__ ä¸­æ¨¡å‹ç®¡ç†ã€è°ƒåº¦å™¨ä¸æŸå¤±æƒé‡éƒ¨åˆ†è§£æ\nè¿™éƒ¨åˆ†ä»£ç è´Ÿè´£æ‰©æ•£æ¨¡å‹è®­ç»ƒè¿‡ç¨‹ä¸­çš„å‡ ä¸ªé‡è¦åŠŸèƒ½ç»„ä»¶çš„é…ç½®ï¼ŒåŒ…æ‹¬å‚æ•°ç»Ÿè®¡ã€EMA å¹³æ»‘ã€è°ƒåº¦å™¨è®¾ç½®ï¼Œä»¥åŠæŸå¤±é¡¹çš„åŠ æƒç­–ç•¥ã€‚\n\nğŸ”¢ æ¨¡å‹å‚æ•°ç»Ÿè®¡ä¸æ‰“å°\ncount_params(self.model, verbose=True)\n\nè°ƒç”¨ count_params æ‰“å°æ¨¡å‹å‚æ•°æ•°é‡ï¼›\nself.model æ˜¯ä¹‹å‰åˆ›å»ºçš„ DiffusionWrapperï¼ˆåŒ…å« UNet å’Œæ¡ä»¶æ§åˆ¶ï¼‰ï¼›\nverbose=True è¡¨ç¤ºè¾“å‡ºè¯¦ç»†å±‚çº§å‚æ•°ç»Ÿè®¡ï¼Œæœ‰åŠ©äºæ¨¡å‹è°ƒè¯•ä¸è§„æ¨¡è¯„ä¼°ã€‚\n\n\nğŸ§® EMA æ¨¡å‹é…ç½®ï¼ˆExponential Moving Averageï¼‰\nself.use_ema = use_ema\nif self.use_ema:\n    self.model_ema = LitEma(self.model)\n    print(f&quot;Keeping EMAs of {len(list(self.model_ema.buffers()))}.&quot;)\n\nuse_ema: æ§åˆ¶æ˜¯å¦å¯ç”¨ EMAï¼›\nå¦‚æœå¯ç”¨ï¼Œå°†åˆ›å»º model_emaï¼Œç”¨äºåœ¨è®­ç»ƒä¸­å¯¹æ¨¡å‹å‚æ•°è¿›è¡Œæ»‘åŠ¨å¹³å‡ï¼›\nEMA å¯åœ¨æ¨ç†æ—¶æä¾›æ›´ç¨³å®šçš„ç»“æœï¼ˆå°¤å…¶è®­ç»ƒåæœŸï¼‰ï¼›\nLitEma æ˜¯ä¸€ä¸ªå†…éƒ¨å®ç°çš„ EMA å·¥å…·ç±»ï¼ˆæ¨¡ä»¿ PyTorch EMA å®ç°ï¼‰ï¼›\nbuffers() æä¾›äº†æ‰€æœ‰è¢« EMA è¿½è¸ªçš„å¼ é‡ï¼ˆé€šå¸¸æ˜¯æ¨¡å‹æƒé‡ï¼‰ã€‚\n\nPS. EMAç®€ä»‹\næŒ‡æ•°ç§»åŠ¨å¹³å‡ï¼ˆExponential Moving Averageï¼‰ä¹Ÿå«æƒé‡ç§»åŠ¨å¹³å‡ï¼ˆWeighted Moving Averageï¼‰ï¼Œæ˜¯ä¸€ç§ç»™äºˆè¿‘æœŸæ•°æ®æ›´é«˜æƒé‡çš„å¹³å‡æ–¹æ³•ã€‚\nğŸ“ˆ è®­ç»ƒè°ƒåº¦å™¨é…ç½®ï¼ˆå¦‚å­¦ä¹ ç‡è°ƒåº¦ï¼‰\nself.use_scheduler = scheduler_config is not None\nif self.use_scheduler:\n    self.scheduler_config = scheduler_config\n\nå¦‚æœæä¾›äº† scheduler_configï¼Œåˆ™å°†å…¶ä¿å­˜ï¼›\nåç»­åœ¨ configure_optimizers() æ–¹æ³•ä¸­ä¼šç”¨åˆ°è¯¥é…ç½®ï¼›\nå¯ç”¨äºå®šä¹‰å¦‚ä½™å¼¦é€€ç«ï¼ˆcosine annealingï¼‰ã€çº¿æ€§ warmup ç­‰å­¦ä¹ ç‡è°ƒåº¦ç­–ç•¥ã€‚\n\n\nâš–ï¸ æŸå¤±é¡¹æƒé‡è®¾ç½®\nself.v_posterior = v_posterior\nself.original_elbo_weight = original_elbo_weight\nself.l_simple_weight = l_simple_weight\nè¿™ä¸‰é¡¹å‚æ•°æ§åˆ¶æ‰©æ•£æŸå¤±çš„ç»„æˆï¼š\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nå‚æ•°åå«ä¹‰v_posterioråéªŒæ–¹å·®çš„åŠ æƒæ§åˆ¶é¡¹ã€‚ç”¨äºè®¾ç½®é¢„æµ‹æ–¹å·®çš„ç­–ç•¥ã€‚å…·ä½“è®¡ç®—å½¢å¼ä¸ºï¼šÏƒÂ² = (1 - v) * beta_tilde + v * betaï¼Œå…¶ä¸­ v å°±æ˜¯è¿™ä¸ªå‚æ•°ã€‚original_elbo_weightæ˜¯å¦åŠ å…¥åŸå§‹è®ºæ–‡ä¸­çš„ ELBO loss é¡¹ï¼ˆå¸¸ä¸º 0ï¼Œä»£è¡¨ä¸å¯ç”¨ï¼‰l_simple_weightL2 æˆ– L1 æŸå¤±çš„ä¸»æƒé‡ï¼Œç”¨äºç¨³å®šè®­ç»ƒ\n\nè¿™éƒ¨åˆ†æœ€ç»ˆå°†ä½œç”¨äº get_loss() æˆ– p_losses() ä¸­çš„æŸå¤±å‡½æ•°ç»„åˆï¼›\nå¯¹äºä¸åŒä»»åŠ¡ï¼ˆå¦‚å›¾åƒé‡å»º vs ç”Ÿæˆï¼‰ï¼Œå¯ä»¥é€šè¿‡è°ƒæ•´è¿™äº›å‚æ•°æ¥å¹³è¡¡ç”Ÿæˆè´¨é‡å’Œä¿çœŸåº¦ã€‚\n\n\nâœ… å°ç»“\nè¿™ä¸€éƒ¨åˆ†ä¸ºè®­ç»ƒè¿‡ç¨‹æä¾›äº†å¿…è¦çš„é…ç½®ç®¡ç†ï¼š\n\næ¨¡å‹å‚æ•°ç»Ÿè®¡æœ‰åŠ©äºå¯è§†åŒ–è§„æ¨¡ï¼›\nEMA ç®¡ç†å¯æå‡è®­ç»ƒç¨³å®šæ€§ï¼›\nè°ƒåº¦å™¨è®¾ç½®ä¸ºä¼˜åŒ–å™¨è¡Œä¸ºæä¾›äº†çµæ´»æ€§ï¼›\næŸå¤±é¡¹åŠ æƒæ§åˆ¶ç”Ÿæˆæ¨¡å‹ä¼˜åŒ–ç›®æ ‡çš„ä¾§é‡ç‚¹ã€‚\n\nğŸ“ˆ PyTorch Lightning ä¸­çš„ monitor å‚æ•°ç®€æ\nmonitor æ˜¯ PyTorch Lightning ä¸­å›è°ƒï¼ˆCallbackï¼‰æœºåˆ¶çš„ä¸€éƒ¨åˆ†ï¼Œç”¨äºæŒ‡å®šè®­ç»ƒè¿‡ç¨‹ä¸­è¦ç›‘æ§çš„æŒ‡æ ‡åç§°ï¼Œä¾›å¦‚ ModelCheckpointã€EarlyStopping ç­‰å›è°ƒä¾æ®è¯¥æŒ‡æ ‡æ‰§è¡Œç›¸åº”é€»è¾‘ï¼ˆå¦‚ä¿å­˜æ¨¡å‹ã€æå‰åœæ­¢ç­‰ï¼‰ã€‚\nè¯¦è§pytorch_Lightning Callback æœºåˆ¶\n\nâœ… å…³é”®ç”¨é€”\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nç»„ä»¶ç”¨é€”ModelCheckpointä¿å­˜æ€§èƒ½æœ€å¥½çš„æ¨¡å‹EarlyStoppingåœ¨éªŒè¯æŒ‡æ ‡åœæ­¢æå‡æ—¶ä¸­æ­¢è®­ç»ƒ\n\nğŸ§© monitor çš„å·¥ä½œæµç¨‹\n\n\næ¨¡å‹å†…éƒ¨è®°å½•æŒ‡æ ‡ï¼š\nself.log(&quot;val/loss&quot;, val_loss, prog_bar=True)\n\n\næŒ‡å®š monitor çš„å›è°ƒç›‘å¬è¿™ä¸ªæŒ‡æ ‡ï¼š\nModelCheckpoint(monitor=&quot;val/loss&quot;, mode=&quot;min&quot;)\n\n\nLightning è‡ªåŠ¨æ¯”è¾ƒå¹¶è§¦å‘ä¿å­˜ / åœæ­¢é€»è¾‘ã€‚\n\n\n\nâš™ï¸ monitor ç¤ºä¾‹é…ç½®\nfrom pytorch_lightning.callbacks import ModelCheckpoint\n \ncheckpoint = ModelCheckpoint(\n    monitor=&quot;val/psnr&quot;,   # ç›‘å¬ PSNR æŒ‡æ ‡\n    mode=&quot;max&quot;,           # æŒ‡æ ‡è¶Šå¤§è¶Šå¥½\n    save_top_k=1,\n    filename=&quot;best-psnr&quot;\n)\nfrom pytorch_lightning.callbacks import EarlyStopping\n \nearly_stop = EarlyStopping(\n    monitor=&quot;val/loss&quot;,\n    mode=&quot;min&quot;,\n    patience=5\n)\n\nğŸ§  è¯´æ˜\n\nmonitor æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå¿…é¡»å’Œ .log(...) ä¸­è®°å½•çš„åå­—ä¸€è‡´ï¼›\nä¸ä¼šè‡ªåŠ¨åˆ›å»ºæŒ‡æ ‡å€¼ï¼Œåªæ˜¯å¼•ç”¨å·²æœ‰æŒ‡æ ‡ï¼›\nå’Œ mode ä¸€èµ·å†³å®šä½•æ—¶è§¦å‘æ“ä½œï¼ˆmin â†’ è¶Šå°è¶Šå¥½ï¼Œmax â†’ è¶Šå¤§è¶Šå¥½ï¼‰ï¼›\nåœ¨æ¨¡å‹ç±»ä¸­å¯ç”¨ self.monitor ä¼ é€’ç»™ callback å®ç°åŠ¨æ€é…ç½®ã€‚\n\n\nâœ… æ€»ç»“\n\nmonitor æ˜¯ å›è°ƒç³»ç»Ÿç›‘å¬çš„æŒ‡æ ‡åç§°ï¼›\né…åˆ .log(...) ä½¿ç”¨ï¼›\nå†³å®šæ˜¯å¦ä¿å­˜æ¨¡å‹ / æå‰åœæ­¢ï¼›\næœ¬èº«ä¸è®¡ç®—æŒ‡æ ‡ï¼Œä»…ä½œä¸ºå¼•ç”¨å­—æ®µä½¿ç”¨ã€‚\n\nline 64 to end\nè¿™ä¸€éƒ¨åˆ†ä¸»è¦å®Œæˆäº†å™ªå£°è°ƒåº¦ä¸æŸå¤±é…ç½®,å…·ä½“æ¥è¯´,\næœ¬éƒ¨åˆ†ä»£ç å®Œæˆäº†æ‰©æ•£è¿‡ç¨‹ä¸­çš„betaè°ƒåº¦è¡¨æ„å»º(å³å™ªå£°è°ƒåº¦)ã€æŸå¤±å‡½æ•°ç±»å‹è®¾å®šå’Œå¯¹æ•°æ–¹å·®çš„åˆå§‹åŒ–ï¼Œæ˜¯ DDPM å»ºæ¨¡æ ¸å¿ƒå‚æ•°çš„å…³é”®é…ç½®æ­¥éª¤ã€‚\n\n1. æ³¨å†Œè°ƒåº¦è¡¨ï¼ˆbeta scheduleï¼‰\nself.register_schedule(\n    given_betas=given_betas,\n    beta_schedule=beta_schedule,\n    timesteps=timesteps,\n    linear_start=linear_start,\n    linear_end=linear_end,\n    cosine_s=cosine_s\n)\n\nè¯¥å‡½æ•°æ ¹æ® beta_schedule çš„ç±»å‹ï¼ˆå¦‚ â€œlinearâ€ æˆ– â€œcosineâ€ï¼‰æ„å»ºæ‰©æ•£è¿‡ç¨‹ä¸­çš„æ—¶é—´æ­¥å™ªå£°ç³»æ•°è¡¨ï¼›\né€šå¸¸ä¼šç”Ÿæˆå¦‚ä¸‹å‚æ•°ï¼š\n\nbetasï¼šæ¯ä¸€æ­¥çš„å™ªå£°å¹…åº¦ï¼›\nalphas, alphas_cumprod, sqrt_alphas_cumprod, sqrt_one_minus_alphas_cumprod ç­‰ï¼›\n\n\nè¿™äº›ç³»æ•°ä¼šåœ¨åç»­ q_sample, q_posterior, predict_start_from_noise ç­‰å‡½æ•°ä¸­ä½¿ç”¨ï¼›\nå‚æ•°è¯´æ˜ï¼š\n\nlinear_start, linear_end: ç”¨äºçº¿æ€§ beta è°ƒåº¦èµ·æ­¢å€¼ï¼›\ncosine_s: ç”¨äºè°ƒæ•´ä½™å¼¦è°ƒåº¦çš„å½¢çŠ¶ï¼›\ngiven_betas: è‹¥æä¾›ï¼Œä¼˜å…ˆä½¿ç”¨ç”¨æˆ·è‡ªå®šä¹‰ beta è¡¨ã€‚\n\n\n\n\n2. è®¾ç½®æŸå¤±å‡½æ•°ç±»å‹\nself.loss_type = loss_type\n\næ§åˆ¶è®­ç»ƒæ—¶ä½¿ç”¨å“ªç§æŸå¤±ï¼š\n\n&quot;l2&quot;ï¼ˆé»˜è®¤ï¼‰ï¼šé¢„æµ‹çš„å™ªå£°ä¸çœŸå®å™ªå£°ä¹‹é—´çš„å‡æ–¹è¯¯å·®ï¼›\n&quot;l1&quot;ï¼šé¢„æµ‹æ®‹å·®çš„ç»å¯¹å€¼æŸå¤±ï¼›\nä¹Ÿå¯èƒ½æ”¯æŒå…¶ä»–è‡ªå®šä¹‰æŸå¤±ç±»å‹ï¼Œå¦‚ perceptual lossã€hybrid loss ç­‰ï¼›\n\n\nå®é™…ä½¿ç”¨åœ¨ get_loss() æˆ– p_losses() ä¸­å¤„ç†ã€‚\n\n\n3. åˆå§‹åŒ–å¯¹æ•°æ–¹å·®ï¼ˆlog-varianceï¼‰\nself.learn_logvar = learn_logvar\nself.logvar = torch.full(fill_value=logvar_init, size=(self.num_timesteps,))\nif self.learn_logvar:\n    self.logvar = nn.Parameter(self.logvar, requires_grad=True)\n\nlogvar æ˜¯ä¸€ä¸ªé•¿åº¦ä¸º num_timesteps çš„å¼ é‡ï¼Œè¡¨ç¤ºæ¯ä¸€æ‰©æ•£æ—¶é—´æ­¥çš„å¯¹æ•°æ–¹å·®ï¼›\nå¦‚æœå¯ç”¨ learn_logvar=Trueï¼Œåˆ™å°†å…¶è®¾ä¸ºå¯å­¦ä¹ å‚æ•°ï¼ˆnn.Parameterï¼‰ï¼Œå…è®¸æ¨¡å‹è‡ªåŠ¨ä¼˜åŒ–æ¯ä¸€æ—¶é—´æ­¥çš„ä¸ç¡®å®šæ€§ï¼›\nå¦‚æœä¸å¯ç”¨ï¼Œlogvar å°±æ˜¯ä¸€ä¸ªå›ºå®šçš„å¸¸é‡å€¼å¼ é‡ï¼›\nåœ¨ get_loss() ä¸­ä¼šå‚ä¸ KL é¡¹æˆ– likelihood çš„æƒé‡è°ƒæ•´ã€‚\n\nlogvar åœ¨ DDPM æ‰©æ•£æ¨¡å‹ä¸­çš„ä½œç”¨ä¸å®ç°\nlogvarï¼ˆå¯¹æ•°æ–¹å·®ï¼‰æ˜¯æ‰©æ•£æ¨¡å‹ï¼ˆå¦‚ DDPMï¼‰ä¸­ç”¨äºæ§åˆ¶è®­ç»ƒæŸå¤±æƒé‡å’Œä¸ç¡®å®šæ€§å»ºæ¨¡çš„ä¸€ä¸ªé‡è¦å˜é‡ã€‚åœ¨ StableSR å’Œ DDPM å®ç°ä¸­ï¼Œå®ƒæ˜¯ diffusion æ¨¡å‹çš„ä¸€éƒ¨åˆ†ï¼Œè€Œé encoder æˆ– decoder çš„ç»„æˆéƒ¨åˆ†ã€‚\n\n1. èƒŒæ™¯ï¼šä¸ºä½•éœ€è¦ logvar\næ‰©æ•£æ¨¡å‹è®­ç»ƒæ—¶é€šå¸¸ä»¥é¢„æµ‹å™ªå£°ä¸ºç›®æ ‡ï¼ŒåŸºæœ¬æŸå¤±å½¢å¼ä¸º(ä»¥L2æŸå¤±ä¸ºä¾‹)ï¼š\nL_t = \\left\\| \\varepsilon_{\\text{pred}} - \\varepsilon_{\\text{true}} \\right\\|^2\nä¸ºäº†å¢å¼ºçµæ´»æ€§ã€ç¨³å®šæ€§æˆ–é€¼è¿‘å¯¹æ•°ä¼¼ç„¶ï¼Œä¸€äº›å˜ä½“å¼•å…¥äº†å¯¹æ•°æ–¹å·® logvarï¼Œä½¿å¾—æŸå¤±å‡½æ•°å˜ä¸ºï¼š\nL_t = \\frac{1}{2} \\cdot \\exp(-\\text{logvar}_t) \\cdot \\left\\| \\varepsilon_{\\text{pred}} - \\varepsilon_{\\text{true}} \\right\\|^2 + \\frac{1}{2} \\cdot \\text{logvar}_t\nè¿™ç›¸å½“äºä½¿ç”¨ä¸€ä¸ªå¯å˜çš„æ—¶é—´æ­¥æƒé‡é¡¹ï¼Œç”¨äºï¼š\n\næ§åˆ¶æ¯ä¸€æ—¶é—´æ­¥æŸå¤±çš„ç›¸å¯¹é‡è¦æ€§ï¼›\næ¨¡æ‹Ÿé«˜æ–¯ä¼¼ç„¶ä¸­çš„åˆ†å¸ƒä¸ç¡®å®šæ€§ï¼›\nä½¿å¾—æ¨¡å‹å¯¹æŸäº›æ—¶é—´æ­¥é¢„æµ‹æ›´åŠ ç¨³å¥ã€‚\n\n\n2. åˆå§‹åŒ–æ–¹å¼\nlogvar é€šå¸¸è¢«åˆå§‹åŒ–ä¸ºå¸¸æ•°å¼ é‡ï¼š\nself.logvar = torch.full(fill_value=logvar_init, size=(self.num_timesteps,))\n\nlogvar_init: å¯¹æ•°æ–¹å·®çš„åˆå§‹å€¼ï¼ˆå¸¸ä¸º 0ï¼‰ï¼›\nnum_timesteps: æ‰©æ•£æ€»æ­¥æ•°ï¼ˆå¦‚ 1000ï¼‰ï¼›\nå¾—åˆ°å½¢çŠ¶ä¸º (T,) çš„ logvar å¼ é‡ï¼Œå…¶ä¸­ T æ˜¯æ—¶é—´æ­¥æ•°ã€‚\n\nè‹¥å¯ç”¨å¯å­¦ä¹ æ–¹å·®ï¼š\nif self.learn_logvar:\n    self.logvar = nn.Parameter(self.logvar, requires_grad=True)\nåˆ™è¯¥å¼ é‡åœ¨è®­ç»ƒä¸­ä¼šè‡ªåŠ¨æ›´æ–°ï¼Œæ¯ä¸€æ—¶é—´æ­¥éƒ½æœ‰ä¸åŒçš„å¯å­¦ä¹ ä¸ç¡®å®šæ€§ã€‚\n\n3. ä½¿ç”¨æ–¹å¼ï¼ˆè®­ç»ƒæ—¶ï¼‰\nlogvar é€šå¸¸å‚ä¸æŸå¤±å‡½æ•°å®šä¹‰ï¼Œåœ¨ get_loss() æˆ– p_losses() ä¸­ç”¨ä½œåŠ¨æ€æƒé‡ï¼š\nloss = weighted_mse / torch.exp(self.logvar[t]) + self.logvar[t]\næˆ–æ›´å¤æ‚çš„ï¼š\nloss = loss_weight * loss_raw + offset * logvar[t]\n\n4. logvaræ€»ç»“\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\né¡¹ç›®å†…å®¹åç§°logvarï¼ˆå¯¹æ•°æ–¹å·®ï¼‰ç±»å‹Tensor / nn.Parameterç»´åº¦(num_timesteps,)ç”¨é€”æ§åˆ¶ä¸åŒæ—¶é—´æ­¥çš„æŸå¤±æƒé‡ä¸ä¸ç¡®å®šæ€§å»ºæ¨¡åˆå§‹åŒ–æ–¹æ³•torch.full(size, fill_value)æ˜¯å¦å¯è®­ç»ƒç”± learn_logvar å‚æ•°æ§åˆ¶\nlogvar æ˜¯ä¸€ä¸ªæ‰©æ•£è¿‡ç¨‹ä¸­çš„æƒé‡è°ƒèŠ‚å™¨ï¼Œå°¤å…¶åœ¨åŠ å…¥ ELBOã€VLB ç­‰ç›®æ ‡æ—¶å°¤ä¸ºå…³é”®ã€‚\n\næ€»ç»“\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\né¡¹ç›®åŠŸèƒ½è¯´æ˜register_schedule()æ„é€ æ‰©æ•£è¿‡ç¨‹ä¸­æ¯ä¸€æ­¥çš„ beta å‚æ•°ï¼Œç”¨äºæ§åˆ¶åŠ å™ªè¿‡ç¨‹loss_typeå†³å®šè®­ç»ƒæ—¶çš„æŸå¤±å‡½æ•°ç±»å‹ï¼Œå¦‚ L2 æˆ– L1learn_logvar å’Œ logvaræ§åˆ¶æ˜¯å¦å­¦ä¹ æ¯ä¸ªæ—¶é—´æ­¥çš„å¯¹æ•°æ–¹å·®ï¼Œä»¥é€‚é…ä¸åŒçš„ä¸ç¡®å®šæ€§å»ºæ¨¡ç­–ç•¥\nè¿™äº›è®¾ç½®æ„æˆäº†æ‰©æ•£æ¨¡å‹è®­ç»ƒé˜¶æ®µçš„æ ¸å¿ƒæ•°å­¦åŸºç¡€ã€‚"},"StableSR_doc/ldm/models/diffusion/ddpm/class-DDPM/forward":{"slug":"StableSR_doc/ldm/models/diffusion/ddpm/class-DDPM/forward","filePath":"StableSR_doc/ldm/models/diffusion/ddpm/class DDPM/forward.md","title":"forward","links":[],"tags":[],"content":""},"StableSR_doc/ldm/models/diffusion/ddpm/class-DDPM/init_from_ckpt":{"slug":"StableSR_doc/ldm/models/diffusion/ddpm/class-DDPM/init_from_ckpt","filePath":"StableSR_doc/ldm/models/diffusion/ddpm/class DDPM/init_from_ckpt.md","title":"init_from_ckpt","links":[],"tags":[],"content":"    def init_from_ckpt(self, path, ignore_keys=list(), only_model=False):\n        sd = torch.load(path, map_location=&quot;cpu&quot;)\n        if &quot;state_dict&quot; in list(sd.keys()):\n            sd = sd[&quot;state_dict&quot;]\n        keys = list(sd.keys())\n        for k in keys:\n            for ik in ignore_keys:\n                if k.startswith(ik):\n                    print(&quot;Deleting key {} from state_dict.&quot;.format(k))\n                    del sd[k]\n        missing, unexpected = self.load_state_dict(sd, strict=False) if not only_model else self.model.load_state_dict(\n            sd, strict=False)\n        print(&#039;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&#039;)\n        print(f&quot;Restored from {path} with {len(missing)} missing and {len(unexpected)} unexpected keys&quot;)\n        if len(missing) &gt; 0:\n            print(f&quot;Missing Keys: {missing}&quot;)\n        if len(unexpected) &gt; 0:\n            print(f&quot;Unexpected Keys: {unexpected}&quot;)\ninit_from_ckpt(path, ignore_keys=list(), only_model=False) å‡½æ•°è§£æ\nè¯¥å‡½æ•°ç”¨äºä» checkpoint æ–‡ä»¶ä¸­åŠ è½½æ¨¡å‹å‚æ•°ï¼Œå¯é€‰æ‹©åªåŠ è½½ UNetï¼ˆself.modelï¼‰ï¼Œæˆ–åŠ è½½æ•´ä¸ª DDPM æ¨¡å‹æœ¬èº«ã€‚æ”¯æŒå¿½ç•¥éƒ¨åˆ†å‚æ•°é”®åï¼Œé€‚ç”¨äºå¾®è°ƒã€è¿ç§»å­¦ä¹ ç­‰åœºæ™¯ã€‚\n\nå‡½æ•°ç­¾å\ndef init_from_ckpt(self, path, ignore_keys=list(), only_model=False):\n\npath: checkpoint æ–‡ä»¶è·¯å¾„ï¼ˆé€šå¸¸ä¸º .ckpt æˆ– .pthï¼‰\nignore_keys: å­—ç¬¦ä¸²åˆ—è¡¨ï¼ŒæŒ‡å®šå“ªäº› key åº”ä» state_dict ä¸­æ’é™¤ï¼ˆå¸¸ç”¨äºå¿½ç•¥ä¸å…¼å®¹çš„æ¨¡å—ï¼‰\nonly_model: è‹¥ä¸º Trueï¼Œåˆ™åªåŠ è½½ self.model çš„å‚æ•°ï¼Œä¸åŠ è½½æ•´ä¸ª DDPM ç±»ç»“æ„ï¼ˆé€‚ç”¨äºä»…æ›´æ–° UNet æ—¶ï¼‰\n\n\n1. åŠ è½½ checkpoint å­—å…¸\nsd = torch.load(path, map_location=&quot;cpu&quot;)\nif &quot;state_dict&quot; in list(sd.keys()):\n    sd = sd[&quot;state_dict&quot;]\n\nä½¿ç”¨ torch.load åŠ è½½æƒé‡ï¼›\næœ‰äº› checkpoint æ˜¯é€šè¿‡ PyTorch Lightning ä¿å­˜çš„ï¼Œå¤–å±‚æ˜¯ä¸ªå­—å…¸ï¼Œå†…éƒ¨çš„æ¨¡å‹æƒé‡ä½äº state_dict é”®ä¸‹ï¼›\nè¿™ä¸€æ­¥å…¼å®¹è¿™ä¸¤ç§ç»“æ„ã€‚\n\n\n2. æ ¹æ® ignore_keys åˆ é™¤ä¸éœ€è¦çš„å‚æ•°\nkeys = list(sd.keys())\nfor k in keys:\n    for ik in ignore_keys:\n        if k.startswith(ik):\n            print(&quot;Deleting key {} from state_dict.&quot;.format(k))\n            del sd[k]\n\néå†æ‰€æœ‰å‚æ•°åï¼ˆkeyï¼‰ï¼Œå¦‚æœä»¥ ik ä¸­ä»»ä¸€å­—ç¬¦ä¸²å¼€å¤´ï¼Œåˆ™åˆ é™¤è¯¥ keyï¼›\nå…¸å‹ç”¨é€”ï¼šè·³è¿‡ cond_stage_model, model_ema, scheduler ç­‰ä¸å½“å‰ä»»åŠ¡æ— å…³çš„éƒ¨åˆ†ã€‚\n\n\n3. åŠ è½½æƒé‡åˆ°æ¨¡å‹ä¸­\nmissing, unexpected = self.load_state_dict(sd, strict=False) if not only_model else self.model.load_state_dict(sd, strict=False)\n\nstrict=Falseï¼šå…è®¸ checkpoint å’Œå½“å‰æ¨¡å‹ç»“æ„ä¸å®Œå…¨ä¸€è‡´ï¼ˆå¦åˆ™ä¼šæŠ¥é”™ï¼‰ï¼›\nmissingï¼šå½“å‰æ¨¡å‹ä¸­å­˜åœ¨è€Œ checkpoint ä¸­æ²¡æœ‰çš„ keyï¼›\nunexpectedï¼šcheckpoint ä¸­å­˜åœ¨ä½†å½“å‰æ¨¡å‹æ²¡æœ‰çš„ keyï¼›\næ ¹æ® only_model å†³å®šåŠ è½½æ•´ä¸ª DDPM æ¨¡å‹æˆ–ä»…åŠ è½½å…¶ self.modelï¼ˆé€šå¸¸æ˜¯ UNetï¼‰ã€‚\n\n\n4. æ‰“å°åŠ è½½ç»“æœ\nprint(&#039;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&#039;)\nprint(f&quot;Restored from {path} with {len(missing)} missing and {len(unexpected)} unexpected keys&quot;)\nif len(missing) &gt; 0:\n    print(f&quot;Missing Keys: {missing}&quot;)\nif len(unexpected) &gt; 0:\n    print(f&quot;Unexpected Keys: {unexpected}&quot;)\n\næ¸…æ™°åœ°æ±‡æŠ¥æ¢å¤æƒ…å†µï¼›\nè‹¥ missing/unexpected è¿‡å¤šï¼Œå¯èƒ½è¯´æ˜æ¨¡å‹ç»“æ„ä¸åŒ¹é…ï¼Œéœ€è¦è°ƒæ•´é…ç½®æˆ– ignore_keysã€‚\n\n\næ€»ç»“è¡¨æ ¼\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nå‚æ•°ä½œç”¨pathæŒ‡å®šåŠ è½½çš„ checkpoint æ–‡ä»¶è·¯å¾„ignore_keyså¿½ç•¥æ‰å…·æœ‰ç‰¹å®šå‰ç¼€çš„å‚æ•°é”®ï¼ˆå¦‚ model_emaï¼‰only_modelæ˜¯å¦åªåŠ è½½ self.modelï¼ˆé€šå¸¸ä¸º UNetï¼‰strict=Falseå®½æ¾åŠ è½½ï¼Œä¸è¦æ±‚ç»“æ„å®Œå…¨ä¸€è‡´missing / unexpectedåˆ†åˆ«è®°å½•ç¼ºå¤±å’Œå¤šä½™çš„å‚æ•° key å\næ­¤å‡½æ•°å¹¿æ³›ç”¨äº StableSR/LDMS/LatentDiffusion çš„é¢„è®­ç»ƒæ¨¡å‹åŠ è½½ä¸å¾®è°ƒæµç¨‹ä¸­ï¼Œæ¨èé…åˆ YAML é…ç½®ä¸ callback ä¸€èµ·ä½¿ç”¨ã€‚"},"StableSR_doc/ldm/models/diffusion/ddpm/disabled_train":{"slug":"StableSR_doc/ldm/models/diffusion/ddpm/disabled_train","filePath":"StableSR_doc/ldm/models/diffusion/ddpm/disabled_train.md","title":"disabled_train","links":[],"tags":[],"content":""},"StableSR_doc/ldm/models/diffusion/ddpm/space_timesteps":{"slug":"StableSR_doc/ldm/models/diffusion/ddpm/space_timesteps","filePath":"StableSR_doc/ldm/models/diffusion/ddpm/space_timesteps.md","title":"space_timesteps","links":[],"tags":[],"content":""},"StableSR_doc/ldm/models/diffusion/ddpm/torch2img":{"slug":"StableSR_doc/ldm/models/diffusion/ddpm/torch2img","filePath":"StableSR_doc/ldm/models/diffusion/ddpm/torch2img.md","title":"torch2img","links":[],"tags":[],"content":"def torch2img(input):\n    input_ = input[0]\n    input_ = input_.permute(1,2,0)\n    input_ = input_.data.cpu().numpy()\n    input_ = (input_ + 1.0) / 2\n    cv2.imwrite(&#039;./test.png&#039;, input_[:,:,::-1]*255.0)"},"StableSR_doc/ldm/models/diffusion/ddpm/uniform_on_device":{"slug":"StableSR_doc/ldm/models/diffusion/ddpm/uniform_on_device","filePath":"StableSR_doc/ldm/models/diffusion/ddpm/uniform_on_device.md","title":"uniform_on_device","links":[],"tags":[],"content":""},"StableSR_doc/ldm/models/diffusion/ddpm/visualize_fea":{"slug":"StableSR_doc/ldm/models/diffusion/ddpm/visualize_fea","filePath":"StableSR_doc/ldm/models/diffusion/ddpm/visualize_fea.md","title":"visualize_fea","links":[],"tags":[],"content":""},"StableSR_doc/ldm/modules/diffusionmodules/openaimodel/Module_info":{"slug":"StableSR_doc/ldm/modules/diffusionmodules/openaimodel/Module_info","filePath":"StableSR_doc/ldm/modules/diffusionmodules/openaimodel/Module_info.md","title":"Module_info","links":["convert_module_to_f16","convert_module_to_f32","exists","cal_fea_cossim","count_flops_attn","AttentionPool2d","TimestepBlock","TimestepBlockDual","TimestepBlock3cond","TimestepEmbedSequential","Upsample","TransposedUpsample","Downsample","ResBlock","ResBlockDual","AttentionBlock","QKVAttentionLegacy","QKVAttention","UNetModel","StableSR_doc/ldm/modules/diffusionmodules/openaimodel/class-UNetModelDualcondV2/UNetModelDualcondV2","EncoderUNetModelWT"],"tags":[],"content":"ldm/modules/diffusionmodules/openaimodel.py\n\n\n                  \n                  UMLå›¾è§£ï¼šopenaimodels.py \n                  \n                \n\n\n\n\n\n\nFunctions\n\nconvert_module_to_f16\nconvert_module_to_f32\nexists\ncal_fea_cossim\ncount_flops_attn\n\nClasses\n\nAttentionPool2d\nTimestepBlock\nTimestepBlockDual\nTimestepBlock3cond\nTimestepEmbedSequential\nUpsample\nTransposedUpsample\nDownsample\nResBlock\nResBlockDual\nAttentionBlock\nQKVAttentionLegacy\nQKVAttention\nUNetModel\nUNetModelDualcondV2\nEncoderUNetModelWT\n"},"StableSR_doc/ldm/modules/diffusionmodules/openaimodel/class-UNetModelDualcondV2/UNetModelDualcondV2":{"slug":"StableSR_doc/ldm/modules/diffusionmodules/openaimodel/class-UNetModelDualcondV2/UNetModelDualcondV2","filePath":"StableSR_doc/ldm/modules/diffusionmodules/openaimodel/class UNetModelDualcondV2/UNetModelDualcondV2.md","title":"UNetModelDualcondV2","links":["StableSR_doc/ldm/modules/diffusionmodules/openaimodel/class-UNetModelDualcondV2/attribute","StableSR_doc/ldm/modules/diffusionmodules/openaimodel/class-UNetModelDualcondV2/UNetModelDualcondV2","StableSR_doc/ldm/modules/diffusionmodules/openaimodel/class-UNetModelDualcondV2/convert_to_fp16","StableSR_doc/ldm/modules/diffusionmodules/openaimodel/class-UNetModelDualcondV2/convert_to_fp32","forward"],"tags":[],"content":"Class: UNetModelDualcondV2\nInheritance Tree (MRO):\n\nUNetModelDualcondV2\nnn.Module\nobject\n\nInstance Attributes (from self.xxx assignments):\n\nimage_size (defined in: init)\nin_channels (defined in: init)\nmodel_channels (defined in: init)\nout_channels (defined in: init)\nattention_resolutions (defined in: init)\ndropout (defined in: init)\nchannel_mult (defined in: init)\nconv_resample (defined in: init)\nnum_classes (defined in: init)\nuse_checkpoint (defined in: init)\ndtype (defined in: init)\nnum_heads (defined in: init)\nnum_head_channels (defined in: init)\nnum_heads_upsample (defined in: init)\npredict_codebook_ids (defined in: init)\ntime_embed (defined in: init)\ninput_blocks (defined in: init)\n_feature_size (defined in: init)\nmiddle_block (defined in: init)\noutput_blocks (defined in: init)\nout (defined in: init)\nnum_res_blocks (defined in: init, init)\nid_predictor (defined in: init)\nlabel_emb (defined in: init, init)\nattribute\n\nProject-defined Methods:\n\n[[init]]  â†  UNetModelDualcondV2\nconvert_to_fp16  â†  UNetModelDualcondV2\nconvert_to_fp32  â†  UNetModelDualcondV2\nforward  â†  UNetModelDualcondV2\n\nProject-defined Class Attributes:"},"StableSR_doc/ldm/modules/diffusionmodules/openaimodel/class-UNetModelDualcondV2/__init__":{"slug":"StableSR_doc/ldm/modules/diffusionmodules/openaimodel/class-UNetModelDualcondV2/__init__","filePath":"StableSR_doc/ldm/modules/diffusionmodules/openaimodel/class UNetModelDualcondV2/__init__.md","title":"__init__","links":[],"tags":[],"content":"init\n    def __init__(\n        self,\n        image_size,\n        in_channels,\n        model_channels,\n        out_channels,\n        num_res_blocks,\n        attention_resolutions,\n        dropout=0,\n        channel_mult=(1, 2, 4, 8),\n        conv_resample=True,\n        dims=2,\n        num_classes=None,\n        use_checkpoint=False,\n        use_fp16=False,\n        num_heads=-1,\n        num_head_channels=-1,\n        num_heads_upsample=-1,\n        use_scale_shift_norm=False,\n        resblock_updown=False,\n        use_new_attention_order=False,\n        use_spatial_transformer=False,    # custom transformer support\n        transformer_depth=1,              # custom transformer support\n        context_dim=None,                 # custom transformer support\n        n_embed=None,                     # custom support for prediction of discrete ids into codebook of first stage vq model\n        legacy=True,\n        disable_self_attentions=None,\n        num_attention_blocks=None,\n        disable_middle_self_attn=False,\n        use_linear_in_transformer=False,\n        semb_channels=None\n    ):\n        super().__init__()\n        if use_spatial_transformer:\n            assert context_dim is not None, &#039;Fool!! You forgot to include the dimension of your cross-attention conditioning...&#039;\n \n        if context_dim is not None:\n            assert use_spatial_transformer, &#039;Fool!! You forgot to use the spatial transformer for your cross-attention conditioning...&#039;\n            from omegaconf.listconfig import ListConfig\n            if type(context_dim) == ListConfig:\n                context_dim = list(context_dim)\n \n        if num_heads_upsample == -1:\n            num_heads_upsample = num_heads\n \n        if num_heads == -1:\n            assert num_head_channels != -1, &#039;Either num_heads or num_head_channels has to be set&#039;\n \n        if num_head_channels == -1:\n            assert num_heads != -1, &#039;Either num_heads or num_head_channels has to be set&#039;\n \n        self.image_size = image_size\n        self.in_channels = in_channels\n        self.model_channels = model_channels\n        self.out_channels = out_channels\n        if isinstance(num_res_blocks, int): # [[#residual-block|residual block]]\n            self.num_res_blocks = len(channel_mult) * [num_res_blocks]\n        else:\n            if len(num_res_blocks) != len(channel_mult):\n                raise ValueError(&quot;provide num_res_blocks either as an int (globally constant) or &quot;\n                                 &quot;as a list/tuple (per-level) with the same length as channel_mult&quot;)\n            self.num_res_blocks = num_res_blocks\n        if disable_self_attentions is not None: # [[#attention-block|attention block]]\n            # should be a list of booleans, indicating whether to disable self-attention in TransformerBlocks or not\n            assert len(disable_self_attentions) == len(channel_mult)\n        if num_attention_blocks is not None:\n            assert len(num_attention_blocks) == len(self.num_res_blocks)\n            assert all(map(lambda i: self.num_res_blocks[i] &gt;= num_attention_blocks[i], range(len(num_attention_blocks))))\n            print(f&quot;Constructor of UNetModel received num_attention_blocks={num_attention_blocks}. &quot;\n                  f&quot;This option has LESS priority than attention_resolutions {attention_resolutions}, &quot;\n                  f&quot;i.e., in cases where num_attention_blocks[i] &gt; 0 but 2**i not in attention_resolutions, &quot;\n                  f&quot;attention will still not be set.&quot;)\n\t\t# [[#unet-å…³é”®å‚æ•°é…ç½®|UNet å…³é”®å‚æ•°é…ç½®]] \n        self.attention_resolutions = attention_resolutions\n        self.dropout = dropout\n        self.channel_mult = channel_mult\n        self.conv_resample = conv_resample\n        self.num_classes = num_classes\n        self.use_checkpoint = use_checkpoint\n        self.dtype = th.float16 if use_fp16 else th.float32\n        self.num_heads = num_heads\n        self.num_head_channels = num_head_channels\n        self.num_heads_upsample = num_heads_upsample\n        self.predict_codebook_ids = n_embed is not None\n\t\t# [[#time_embed|time_embed]]\n        time_embed_dim = model_channels * 4\n        self.time_embed = nn.Sequential(\n            linear(model_channels, time_embed_dim),\n            nn.SiLU(),\n            linear(time_embed_dim, time_embed_dim),\n        )\n\t\t# [[#ç±»åˆ«æ¡ä»¶class-conditionalæœºåˆ¶åœ¨-unet-ä¸­çš„å®ç°|ç±»åˆ«æ¡ä»¶ï¼ˆClass-Conditionalï¼‰æœºåˆ¶åœ¨ UNet ä¸­çš„å®ç°]]\n        if self.num_classes is not None:\n            if isinstance(self.num_classes, int):\n                self.label_emb = nn.Embedding(num_classes, time_embed_dim)\n            elif self.num_classes == &quot;continuous&quot;:\n                print(&quot;setting up linear c_adm embedding layer&quot;)\n                self.label_emb = nn.Linear(1, time_embed_dim)\n            else:\n                raise ValueError()\n \n        self.input_blocks = nn.ModuleList(\n            [\n                TimestepEmbedSequential(\n                    conv_nd(dims, in_channels, model_channels, 3, padding=1)\n                )\n            ]\n        )\n        self._feature_size = model_channels\n        input_block_chans = [model_channels]\n        ch = model_channels\n        ds = 1\n        for level, mult in enumerate(channel_mult):\n            for nr in range(self.num_res_blocks[level]):\n                layers = [\n                    ResBlockDual(\n                        ch,\n                        time_embed_dim,\n                        dropout,\n                        semb_channels=semb_channels,\n                        out_channels=mult * model_channels,\n                        dims=dims,\n                        use_checkpoint=use_checkpoint,\n                        use_scale_shift_norm=use_scale_shift_norm,\n                    )\n                ]\n                ch = mult * model_channels\n                if ds in attention_resolutions:\n                    if num_head_channels == -1:\n                        dim_head = ch // num_heads\n                    else:\n                        num_heads = ch // num_head_channels\n                        dim_head = num_head_channels\n                    if legacy:\n                        #num_heads = 1\n                        dim_head = ch // num_heads if use_spatial_transformer else num_head_channels\n                    if exists(disable_self_attentions):\n                        disabled_sa = disable_self_attentions[level]\n                    else:\n                        disabled_sa = False\n \n                    if not exists(num_attention_blocks) or nr &lt; num_attention_blocks[level]:\n                        layers.append(\n                            AttentionBlock(\n                                ch,\n                                use_checkpoint=use_checkpoint,\n                                num_heads=num_heads,\n                                num_head_channels=dim_head,\n                                use_new_attention_order=use_new_attention_order,\n                            ) if not use_spatial_transformer else SpatialTransformerV2(\n                                ch, num_heads, dim_head, depth=transformer_depth, context_dim=context_dim,\n                                disable_self_attn=disabled_sa, use_linear=use_linear_in_transformer,\n                                use_checkpoint=use_checkpoint\n                            )\n                        )\n                self.input_blocks.append(TimestepEmbedSequential(*layers))\n                self._feature_size += ch\n                input_block_chans.append(ch)\n            if level != len(channel_mult) - 1:\n                out_ch = ch\n                self.input_blocks.append(\n                    TimestepEmbedSequential(\n                        ResBlockDual(\n                            ch,\n                            time_embed_dim,\n                            dropout,\n                            semb_channels=semb_channels,\n                            out_channels=out_ch,\n                            dims=dims,\n                            use_checkpoint=use_checkpoint,\n                            use_scale_shift_norm=use_scale_shift_norm,\n                            down=True,\n                        )\n                        if resblock_updown\n                        else Downsample(\n                            ch, conv_resample, dims=dims, out_channels=out_ch\n                        )\n                    )\n                )\n                ch = out_ch\n                input_block_chans.append(ch)\n                ds *= 2\n                self._feature_size += ch\n\t\t# [[#attention_head|attention_head]] \n        if num_head_channels == -1:\n            dim_head = ch // num_heads\n        else:\n            num_heads = ch // num_head_channels\n            dim_head = num_head_channels\n        if legacy:\n            #num_heads = 1\n            dim_head = ch // num_heads if use_spatial_transformer else num_head_channels\n        self.middle_block = TimestepEmbedSequential(\n            ResBlockDual(\n                ch,\n                time_embed_dim,\n                dropout,\n                semb_channels=semb_channels,\n                dims=dims,\n                use_checkpoint=use_checkpoint,\n                use_scale_shift_norm=use_scale_shift_norm,\n            ),\n            AttentionBlock(\n                ch,\n                use_checkpoint=use_checkpoint,\n                num_heads=num_heads,\n                num_head_channels=dim_head,\n                use_new_attention_order=use_new_attention_order,\n            ) if not use_spatial_transformer else SpatialTransformerV2(  # always uses a self-attn\n                            ch, num_heads, dim_head, depth=transformer_depth, context_dim=context_dim,\n                            disable_self_attn=disable_middle_self_attn, use_linear=use_linear_in_transformer,\n                            use_checkpoint=use_checkpoint\n                        ),\n            ResBlockDual(\n                ch,\n                time_embed_dim,\n                dropout,\n                semb_channels=semb_channels,\n                dims=dims,\n                use_checkpoint=use_checkpoint,\n                use_scale_shift_norm=use_scale_shift_norm,\n            ),\n        )\n        self._feature_size += ch\n \n        self.output_blocks = nn.ModuleList([])\n        for level, mult in list(enumerate(channel_mult))[::-1]:\n            for i in range(self.num_res_blocks[level] + 1):\n                ich = input_block_chans.pop()\n                layers = [\n                    ResBlockDual(\n                        ch + ich,\n                        time_embed_dim,\n                        dropout,\n                        semb_channels=semb_channels,\n                        out_channels=model_channels * mult,\n                        dims=dims,\n                        use_checkpoint=use_checkpoint,\n                        use_scale_shift_norm=use_scale_shift_norm,\n                    )\n                ]\n                ch = model_channels * mult\n                if ds in attention_resolutions:\n                    if num_head_channels == -1:\n                        dim_head = ch // num_heads\n                    else:\n                        num_heads = ch // num_head_channels\n                        dim_head = num_head_channels\n                    if legacy:\n                        #num_heads = 1\n                        dim_head = ch // num_heads if use_spatial_transformer else num_head_channels\n                    if exists(disable_self_attentions):\n                        disabled_sa = disable_self_attentions[level]\n                    else:\n                        disabled_sa = False\n \n                    if not exists(num_attention_blocks) or i &lt; num_attention_blocks[level]:\n                        layers.append(\n                            AttentionBlock(\n                                ch,\n                                use_checkpoint=use_checkpoint,\n                                num_heads=num_heads_upsample,\n                                num_head_channels=dim_head,\n                                use_new_attention_order=use_new_attention_order,\n                            ) if not use_spatial_transformer else SpatialTransformerV2(\n                                ch, num_heads, dim_head, depth=transformer_depth, context_dim=context_dim,\n                                disable_self_attn=disabled_sa, use_linear=use_linear_in_transformer,\n                                use_checkpoint=use_checkpoint\n                            )\n                        )\n                if level and i == self.num_res_blocks[level]:\n                    out_ch = ch\n                    layers.append(\n                        ResBlockDual(\n                            ch,\n                            time_embed_dim,\n                            dropout,\n                            semb_channels=semb_channels,\n                            out_channels=out_ch,\n                            dims=dims,\n                            use_checkpoint=use_checkpoint,\n                            use_scale_shift_norm=use_scale_shift_norm,\n                            up=True,\n                        )\n                        if resblock_updown\n                        else Upsample(ch, conv_resample, dims=dims, out_channels=out_ch)\n                    )\n                    ds //= 2\n                self.output_blocks.append(TimestepEmbedSequential(*layers))\n                self._feature_size += ch\n \n        self.out = nn.Sequential(\n            normalization(ch),\n            nn.SiLU(),\n            zero_module(conv_nd(dims, model_channels, out_channels, 3, padding=1)),\n        )\n        if self.predict_codebook_ids:\n            self.id_predictor = nn.Sequential(\n            normalization(ch),\n            conv_nd(dims, model_channels, n_embed, 1),\n            #nn.LogSoftmax(dim=1)  # change to cross_entropy and produce non-normalized logits\n        )\nattention_head\nåœ¨ä½¿ç”¨å¤šå¤´æ³¨æ„åŠ›æ¨¡å—ï¼ˆå¦‚ AttentionBlock æˆ– SpatialTransformerV2ï¼‰æ—¶ï¼Œéœ€è¦æŒ‡å®šä¸‹åˆ—ä¸¤ä¸ªå‚æ•°ä¹‹ä¸€ï¼š\n\nnum_headsï¼šæ³¨æ„åŠ›å¤´çš„æ•°é‡ï¼ˆä¾‹å¦‚ 8 è¡¨ç¤ºä½¿ç”¨ 8 ä¸ªå¹¶è¡Œæ³¨æ„åŠ›åˆ†æ”¯ï¼‰\nnum_head_channelsï¼šæ¯ä¸ªæ³¨æ„åŠ›å¤´çš„é€šé“å®½åº¦ï¼ˆä¾‹å¦‚ 64 è¡¨ç¤ºæ¯ä¸ªå¤´ç»´åº¦ä¸º 64ï¼‰\n\näºŒè€…çš„å…³ç³»\näºŒè€…æ»¡è¶³å¦‚ä¸‹å…³ç³»ï¼š\n\\mathrm{num\\_heads} \\times \\mathrm{num\\_head\\_channels} \\leq \\mathrm{total\\_channels}\nä½ åªéœ€è¦æ˜¾å¼æŒ‡å®šä¸€ä¸ªï¼Œå¦ä¸€ä¸ªå¯ä»¥è‡ªåŠ¨æ¨å¯¼ã€‚\nå‚æ•°æ£€æŸ¥é€»è¾‘\næºä»£ç ä¸­çš„æ ¡éªŒé€»è¾‘å¦‚ä¸‹ï¼š\nif num_heads == -1:\n    assert num_head_channels != -1, &#039;Either num_heads or num_head_channels has to be set&#039;\n \nif num_head_channels == -1:\n    assert num_heads != -1, &#039;Either num_heads or num_head_channels has to be set&#039;\nä¹Ÿå°±æ˜¯è¯´ï¼Œå¿…é¡»è‡³å°‘æŒ‡å®šä¸€ä¸ªå‚æ•°ï¼Œå¦åˆ™å°†æŠ›å‡ºé”™è¯¯ã€‚\nï¸ æ³¨æ„äº‹é¡¹\n\nè‹¥ total_channels æ— æ³•æ•´é™¤æŒ‡å®šå‚æ•°ï¼Œå¯èƒ½å¯¼è‡´è®¡ç®—å‡ºé”™æˆ–ç»´åº¦ä¸ä¸€è‡´ï¼›\nä¸¤è€…éƒ½æŒ‡å®šæ—¶è¦ç¡®ä¿ä¸€è‡´æ€§ï¼Œå³ï¼šnum_heads * num_head_channels == total_channelsï¼›\næ¨èåšæ³•æ˜¯ï¼šè®¾ç½®ä½ æƒ³æ§åˆ¶çš„é‚£ä¸€ä¸ªï¼Œç•™å¦ä¸€ä¸ªè‡ªåŠ¨è®¡ç®—ã€‚\n\nç¤ºä¾‹\nå‡è®¾å½“å‰å±‚é€šé“æ•°ä¸º 320ï¼š\n\nè‹¥è®¾ç½® num_heads=8ï¼Œåˆ™ num_head_channels=320 // 8 = 40\nè‹¥è®¾ç½® num_head_channels=64ï¼Œåˆ™ num_heads=320 // 64 = 5\n\n# æ¨èç¤ºä¾‹\nattention_block = AttentionBlock(\n    channels=320,\n    num_heads=8,\n    num_head_channels=-1,  # è‡ªåŠ¨è®¡ç®—ä¸º 40\n)\n \n# æˆ–è€…\nattention_block = AttentionBlock(\n    channels=320,\n    num_heads=-1,\n    num_head_channels=64,  # è‡ªåŠ¨è®¡ç®—ä¸º 5 heads\n)\nresidual block\nè¿™æ®µä»£ç ç”¨äºé…ç½®UNetçš„å„å±‚ä¸­æ®‹å·®å—ï¼ˆresidual blockï¼‰çš„æ•°é‡ã€‚\n        if isinstance(num_res_blocks, int):\n            self.num_res_blocks = len(channel_mult) * [num_res_blocks]\nå¦‚æœä¼ å…¥çš„num_res_blockså‚æ•°æ˜¯å•ä¸€æ•´æ•°ï¼Œé‚£ä¹ˆæ¯ä¸€å±‚å°†éƒ½ä½¿ç”¨è¿™ä¸ªæ•°é‡çš„æ®‹å·®å—ã€‚\n        else:\n            if len(num_res_blocks) != len(channel_mult):\n                raise ValueError(&quot;provide num_res_blocks either as an int (globally constant) or &quot;\n                                 &quot;as a list/tuple (per-level) with the same length as channel_mult&quot;)\n            self.num_res_blocks = num_res_blocks\nå¦‚æœä¼ å…¥çš„num_res_blockså‚æ•°ä¸æ˜¯æ•´æ•°ï¼Œé‚£ä¹ˆæœŸæœ›ä¸ºåˆ—è¡¨æˆ–å…¶ä»–åŒ…å«æ•´æ•°åºåˆ—çš„æœ‰åºå®¹å™¨ï¼Œä¸”è¯¥å®¹å™¨çš„é•¿åº¦åº”å’Œchannel_multçš„é•¿åº¦ï¼ˆä¹Ÿå³UNetçš„å•æµ‹æ·±åº¦ï¼‰ç›¸åŒã€‚\nattention block\nè¿™æ®µä»£ç é…ç½®äº†attention blockï¼ˆè‡ªæ³¨æ„åŠ›æœºåˆ¶ï¼‰éƒ¨åˆ†çš„å¯ç”¨æƒ…å†µã€‚\næ³¨æ„ï¼šåœ¨StableSRä¸­ï¼Œè‡ªæ³¨æ„åŠ›å’Œäº¤å‰æ³¨æ„åŠ›éƒ½æ˜¯é€šè¿‡ç»Ÿä¸€çš„transformeræ¨¡å—å®ç°çš„ï¼Œå…¶è‡ªæ³¨æ„åŠ›æœºåˆ¶å¹¶ä¸æ˜¯SR3é‚£æ ·ä¼ ç»Ÿçš„dot-product attentionã€‚StableSRä¸­ï¼Œè¯¥transformerå¯ä»¥é€‰æ‹©æ˜¯å¦å¼€å¯è‡ªæ³¨æ„åŠ›éƒ¨åˆ†ï¼Œä½†é»˜è®¤å¿…é¡»å¼€å¯äº¤å‰æ³¨æ„åŠ›ä»¥ä¸ºUNetæä¾›å¿…è¦çš„ç”Ÿæˆæ¡ä»¶ã€‚\n        if disable_self_attentions is not None:\n            # should be a list of booleans, indicating whether to disable self-attention in TransformerBlocks or not\n            assert len(disable_self_attentions) == len(channel_mult)\ndisable_self_attentionså‚æ•°æœŸæœ›æ˜¯Noneæˆ–è€…ä¸channel_multé•¿åº¦ç›¸åŒçš„å¸ƒå°”æ•°ç»„ï¼Œç”¨äºæ§åˆ¶UNetå†…å„å±‚æ˜¯å¦å¼€å¯è‡ªæ³¨æ„åŠ›æ¨¡å—ã€‚Noneè¡¨ç¤ºå…¨éƒ¨å¼€å¯ï¼Œå¸ƒå°”æ•°ç»„åˆ™æŒ‰ç…§å…¶çœŸå€¼æ§åˆ¶ã€‚\n        if num_attention_blocks is not None:\n            assert len(num_attention_blocks) == len(self.num_res_blocks)\n            assert all(map(lambda i: self.num_res_blocks[i] &gt;= num_attention_blocks[i], range(len(num_attention_blocks))))\n            print(f&quot;Constructor of UNetModel received num_attention_blocks={num_attention_blocks}. &quot;\n                  f&quot;This option has LESS priority than attention_resolutions {attention_resolutions}, &quot;\n                  f&quot;i.e., in cases where num_attention_blocks[i] &gt; 0 but 2**i not in attention_resolutions, &quot;\n                  f&quot;attention will still not be set.&quot;)\n\n\næ§åˆ¶ æ¯ä¸€å±‚ä¸­æœ€å¤šèƒ½æ’å…¥å¤šå°‘ä¸ª attention æ¨¡å—ï¼›\n\n\nä¸æ˜¯å±‚çº§æ•°ï¼Œè€Œæ˜¯å®é™… ResBlock æ•°é‡å¯¹ attention çš„æ•°é‡é™åˆ¶ï¼›\n\n\nå¿…é¡»åŒ¹é…ç»“æ„æ·±åº¦ï¼Œå³ num_attention_blocks[i] â‰¤ num_res_blocks[i]ã€‚\n\n\næ‰“å°è¯­å¥æ›´åŠ æ¸…æ™°åœ°è¡¨æ˜äº†é…ç½®å‚æ•°çš„ä¼˜å…ˆçº§å…³ç³»\n\n\næœ€ç»ˆæ˜¯å¦æ’å…¥ attention block çš„åˆ¤å®šï¼Œé¦–å…ˆçœ‹ attention_resolutionsï¼Œç„¶åæ‰çœ‹ num_attention_blocksã€‚\n\n\nä¹Ÿå°±æ˜¯è¯´ï¼š\n\n\nä½ å¯ä»¥è®¾ç½® num_attention_blocks[i] = 1 è¡¨ç¤ºâ€œæœ€å¤šæ’å…¥ 1 ä¸ªâ€ï¼›\n\n\nä½†å¦‚æœ 2**i ä¸åœ¨ attention_resolutionsï¼ˆä¾‹å¦‚ 16, 32ï¼‰ä¸­ï¼Œé‚£ attention å°±ä¸ä¼šæ’å…¥ï¼›\n\n\næ¢å¥è¯è¯´ï¼šä½ åªè¡¨è¾¾äº†â€œå…è®¸æ’å…¥â€ï¼Œæ’ä¸æ’è¦ç”± attention_resolutions å†³å®šã€‚\n\n\n\n\nUNet å…³é”®å‚æ•°é…ç½®\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nå‚æ•°è¯´æ˜attention_resolutionsæ§åˆ¶åœ¨å“ªäº›åˆ†è¾¨ç‡ä¸‹æ’å…¥ attentionï¼ˆå¦‚ 16ã€32ï¼‰dropoutdropout æ¦‚ç‡ï¼Œç”¨äº regularizationchannel_multæ¯ä¸€å±‚é€šé“æ•°æ˜¯åŸºé€šé“æ•°ï¼ˆmodel_channelsï¼‰çš„å‡ å€conv_resampleæ˜¯å¦ä½¿ç”¨å·ç§¯å®ç°ä¸‹/ä¸Šé‡‡æ ·ï¼ˆTrue ä¸ºå¯å­¦ä¹ ï¼‰num_classesæ˜¯å¦ä½¿ç”¨ class-conditional æ¡ä»¶ï¼ˆå¦‚æ ‡ç­¾ï¼‰use_checkpointæ˜¯å¦ä½¿ç”¨ gradient checkpointing å‡å°‘æ˜¾å­˜dtypeç½‘ç»œä¸­ä½¿ç”¨çš„ç²¾åº¦ï¼ˆfloat16 æˆ– float32ï¼‰num_heads / num_head_channelsAttention ä¸­çš„ head è®¾ç½®num_heads_upsampleä¸Šé‡‡æ ·é˜¶æ®µçš„ head æ•°predict_codebook_idsæ˜¯å¦è¾“å‡º codebook tokenï¼ˆå³æ˜¯å¦ä¸º VQGAN decoderï¼‰\ntime_embed\næ³¨æ„ï¼šè¿™æ˜¯å°†æ—¶é—´ä¿¡æ¯å¼•å…¥UNetçš„æ ¸å¿ƒé€”å¾„ã€‚\n        time_embed_dim = model_channels * 4\n        self.time_embed = nn.Sequential(\n            linear(model_channels, time_embed_dim),\n            nn.SiLU(),\n            linear(time_embed_dim, time_embed_dim),\n        )\nè¿™æ®µä»£ç æ„é€ äº†ä¸€ä¸ªç®€å•çš„ MLPï¼ˆå¤šå±‚æ„ŸçŸ¥æœºï¼‰ï¼Œå°†åŸå§‹çš„ timestep embedding æ˜ å°„æˆä¾› ResBlock ä½¿ç”¨çš„æ—¶é—´æ¡ä»¶å‘é‡ã€‚\n\nè¾“å…¥ç»´åº¦ï¼šmodel_channelsï¼ˆä¾‹å¦‚ 320ï¼‰\nè¾“å‡ºç»´åº¦ï¼štime_embed_dim = 4 Ã— model_channelsï¼ˆä¾‹å¦‚ 1280ï¼‰\næ¿€æ´»å‡½æ•°ï¼šSiLUï¼ˆå³ Swish æ¿€æ´»ï¼Œæ•ˆæœæ¯” ReLU æ›´å¹³æ»‘ï¼‰\n\nTODO:time_embedåªæ˜¯time aware encoderçš„ä¸€ä¸ªæ¨¡å—ï¼Œåœ¨è¿›å…¥ä»–ä¹‹å‰ä¼šæœ‰ä¸€ä¸ªåŸå§‹çš„time embedingï¼ˆå¯èƒ½æ˜¯æ­£ä½™å¼¦ä½ç½®ç¼–ç ï¼‰ï¼Œå°†ç¼–ç ç»“æœè¾“å…¥è¿™ä¸ªtime_embedçš„MLPæ¥è¿›ä¸€æ­¥æ·»åŠ å¯å­¦ä¹ æ€§ï¼Œå…¶è¾“å‡ºç”¨äºè°ƒèŠ‚æ®‹å·®å—çš„å·¥ä½œæ¨¡å¼ã€‚ä»¥ä¸Šå†…å®¹åº”è¯¥åœ¨åç»­ä»£ç å’Œforwardå‡½æ•°ä¸­æœ‰æ›´å¤šçš„ä½“ç°ã€‚\nç±»åˆ«æ¡ä»¶ï¼ˆClass-Conditionalï¼‰æœºåˆ¶åœ¨ UNet ä¸­çš„å®ç°\nä¸€ã€ä»€ä¹ˆæ˜¯ç±»åˆ«æ¡ä»¶ï¼Ÿ\nåœ¨æ‰©æ•£æ¨¡å‹ï¼ˆå¦‚ DDPMã€StableSRã€LDMï¼‰ä¸­ï¼Œç±»åˆ«æ¡ä»¶æ˜¯ä¸€ç§ç”¨äºå¼•å¯¼å›¾åƒç”Ÿæˆæ–¹å‘çš„è¾…åŠ©ä¿¡æ¯ã€‚é€šè¿‡åœ¨æ¯ä¸€æ­¥æ‰©æ•£ä¸­æ³¨å…¥ç±»åˆ«æ ‡ç­¾ï¼Œæ¨¡å‹èƒ½å¤Ÿå­¦ä¹ ï¼š\n\nå¦‚ä½•åœ¨ç¬¬ t æ­¥ç”Ÿæˆå±äºç±»åˆ« y çš„å›¾åƒç‰¹å¾ã€‚\n\nè¯¥æœºåˆ¶é€‚ç”¨äºåˆ†ç±»å¼•å¯¼å›¾åƒç”Ÿæˆï¼Œä¾‹å¦‚ï¼š\n\nç”Ÿæˆä¸€å¼ â€œçŒ«â€è€Œä¸æ˜¯â€œç‹—â€çš„å›¾åƒ\nåˆæˆç‰¹å®šç±»å‹çš„å»ºç­‘ã€è½¦è¾†æˆ–è‡ªç„¶åœºæ™¯å›¾åƒ\næ¡ä»¶æ§åˆ¶ä»»åŠ¡ï¼Œå¦‚ super-resolution with category hints\n\n\näºŒã€å®ç°æ–¹å¼\nåœ¨ UNetModelDualcondV2 ä¸­ï¼Œç±»åˆ«æ¡ä»¶é€šè¿‡ä»¥ä¸‹ç»“æ„å®ç°ï¼š\nif isinstance(self.num_classes, int):\n    self.label_emb = nn.Embedding(num_classes, time_embed_dim)\nelif self.num_classes == &quot;continuous&quot;:\n    self.label_emb = nn.Linear(1, time_embed_dim)\næ”¯æŒä¸¤ç§ç±»åˆ«æ¡ä»¶æ ¼å¼ï¼š\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nç±»å‹å«ä¹‰æ¨¡å—è¾“å…¥å½¢å¼ç¦»æ•£ç±»åˆ«æ˜ç¡®ç±»åˆ«æ ‡ç­¾ï¼Œå¦‚ 0~9nn.Embeddingy âˆˆ {0, ..., num_classes}è¿ç»­å˜é‡å±æ€§å€¼ã€å®æ•°æ¡ä»¶nn.Lineary âˆˆ â„ï¼ˆå½¢å¦‚ [B, 1]ï¼‰\nåµŒå…¥åå°†ä¸æ—¶é—´åµŒå…¥ç›¸åŠ ï¼Œç”¨äºè°ƒèŠ‚æ¯ä¸ª ResBlockï¼š\nemb = time_embed(t) + label_emb(y)\n\nä¸‰ã€ç±»åˆ«æ¡ä»¶çš„æ¥æº\nç±»åˆ«æ¡ä»¶ ä¸æ˜¯è‡ªåŠ¨ç”Ÿæˆçš„ï¼Œè€Œæ˜¯ ç”±ç”¨æˆ·æ˜¾å¼æä¾›ï¼š\n\nå¯¹äºåˆ†ç±»ä»»åŠ¡ï¼šæ ‡ç­¾ y æ¥è‡ªæ•°æ®é›†ï¼›\nå¯¹äºè¿ç»­æ¡ä»¶ä»»åŠ¡ï¼šå¦‚æ¨¡ç³Šç¨‹åº¦ã€æ¸©åº¦ç­‰æ•°å€¼ï¼Œç”±ç”¨æˆ·è®¾å®šï¼›\nä¸ä½¿ç”¨ç±»åˆ«æ¡ä»¶æ—¶ï¼Œè®¾ç½® num_classes = None å³å¯å…³é—­ã€‚\n\n\nå››ã€å…³é—­ç±»åˆ«æ¡ä»¶çš„æ–¹æ³•\nåªéœ€åœ¨åˆå§‹åŒ–æ¨¡å‹æ—¶è®¾å®šï¼š\nnum_classes = None\nå³å¯å®Œå…¨å…³é—­ç±»åˆ«æ¡ä»¶è·¯å¾„ï¼š\n\nä¸æ„å»º label_emb\næ—¶é—´åµŒå…¥ emb = time_embed(t) ä¸å†åŒ…å«ç±»åˆ«ä¿¡æ¯\næ¨¡å‹ä»…ä¾èµ–æ—¶é—´æ­¥ä¸å…¶ä»–æ¡ä»¶ï¼ˆå¦‚ç»“æ„æ¡ä»¶ï¼‰\n\n\näº”ã€æŠ€æœ¯æ„ä¹‰\nç±»åˆ«æ¡ä»¶æ‰©å±•äº†æ‰©æ•£æ¨¡å‹çš„èƒ½åŠ›ï¼Œä½¿å…¶æ”¯æŒï¼š\n\nåˆ†ç±»æ§åˆ¶ç”Ÿæˆï¼ˆclass-conditional generationï¼‰\nå¤šæ¨¡æ€æ§åˆ¶ç»“æ„ï¼ˆå¦‚ time + class + structureï¼‰\né€šç”¨æ§åˆ¶å™¨è®¾è®¡ï¼ˆæ”¯æŒæ ‡ç­¾ã€æ¨¡æ€ã€é£æ ¼ç­‰æ³¨å…¥ï¼‰\n\nè¿™ä¸€æœºåˆ¶ä¹Ÿä¸ºåç»­åŠ å…¥ cross-attention ç­‰ç»“æ„æä¾›äº†æ¡ä»¶è¾“å…¥çš„é€šé“ã€‚"},"StableSR_doc/ldm/modules/diffusionmodules/openaimodel/class-UNetModelDualcondV2/attribute":{"slug":"StableSR_doc/ldm/modules/diffusionmodules/openaimodel/class-UNetModelDualcondV2/attribute","filePath":"StableSR_doc/ldm/modules/diffusionmodules/openaimodel/class UNetModelDualcondV2/attribute.md","title":"attribute","links":[],"tags":[],"content":"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nå‚æ•°ä½œç”¨ä¸è¯´æ˜image_sizeè¾“å…¥å›¾åƒçš„å¤§å°ï¼Œç”¨äºæ„å»º U-Net ç»“æ„çš„å±‚çº§ï¼Œä¸€èˆ¬ç”¨äºè¾“å…¥å‰çš„å°ºå¯¸æ ¡éªŒæˆ–æ¨æ–­ç½‘ç»œæ·±åº¦ã€‚in_channelsè¾“å…¥å›¾åƒçš„é€šé“æ•°ï¼Œä¾‹å¦‚ RGB ä¸º 3ï¼Œç°åº¦å›¾ä¸º 1ã€‚model_channelsæ¨¡å‹çš„åŸºç¡€é€šé“æ•°ï¼Œå†³å®šäº†ç¬¬ä¸€å±‚ç‰¹å¾å›¾çš„å®½åº¦ã€‚U-Net çš„é€šé“æ•°é€šå¸¸æ˜¯ model_channels * mult å½¢å¼å¢é•¿ã€‚out_channelsè¾“å‡ºå›¾åƒçš„é€šé“æ•°ï¼Œé€šå¸¸ä¸ in_channels ç›¸åŒï¼Œä¾‹å¦‚ 3 é€šé“å›¾åƒã€‚ä¹Ÿå¯ä»¥æ˜¯ codebook å¤§å°ï¼ˆç”¨äº VQï¼‰ã€‚num_res_blocksæ¯ä¸ª downsample/upsample å±‚ä½¿ç”¨çš„ ResBlock ä¸ªæ•°ã€‚å¯ä¸º intï¼ˆæ¯å±‚ç›¸åŒï¼‰ï¼Œä¹Ÿå¯ä¸º listï¼ˆä¸åŒå±‚ä¸åŒæ•°é‡ï¼‰ã€‚attention_resolutionsæŒ‡å®šåœ¨å“ªäº› resolution ä¸‹æ’å…¥ attention æ¨¡å—ã€‚ä¾‹å¦‚åŒ…å« 4 è¡¨ç¤ºåœ¨ 1/4 å°ºåº¦ç‰¹å¾å›¾ä¸ŠåŠ å…¥ self-attn æˆ– cross-attnã€‚dropoutDropout æ¦‚ç‡ï¼Œæ§åˆ¶ç½‘ç»œçš„éšæœºå¤±æ´»ç¨‹åº¦ã€‚ç”¨äºæå‡æ³›åŒ–èƒ½åŠ›ã€‚channel_multU-Net æ¯ä¸ªå±‚çº§çš„é€šé“æ‰©å±•å€ç‡ã€‚ä¾‹å¦‚ (1, 2, 4, 8) è¡¨ç¤ºç¬¬4å±‚ä¸ºåŸºé€šé“çš„8å€ã€‚conv_resampleæ˜¯å¦ä½¿ç”¨å·ç§¯æ–¹å¼è¿›è¡Œä¸Šä¸‹é‡‡æ ·ï¼ˆå¦‚ PixelShuffleã€ConvTransposeï¼‰ï¼Œå¦åˆ™ä½¿ç”¨ç®€å•æ’å€¼ã€‚dimsè¾“å…¥æ•°æ®ç»´åº¦ï¼Œ2 è¡¨ç¤º 2D å›¾åƒï¼Œ1 æˆ– 3 åˆ™ç”¨äºåºåˆ—æˆ–ä½“æ•°æ®ã€‚num_classesåˆ†ç±»æ¡ä»¶æ•°é‡ã€‚å¦‚æœè®¾ç½®ä¸ºæ•´æ•°ï¼Œåˆ™æ¨¡å‹æ˜¯ class-conditionalï¼›æ”¯æŒ int æˆ– &quot;continuous&quot;ã€‚use_checkpointæ˜¯å¦å¼€å¯ gradient checkpointingï¼ˆåå‘ä¼ æ’­æ—¶èŠ‚çœå†…å­˜ï¼‰ã€‚ä¼šç‰ºç‰²é€Ÿåº¦æ¢ç©ºé—´ã€‚use_fp16æ˜¯å¦ä½¿ç”¨ float16 ç²¾åº¦æ¨ç†ï¼Œä¸»è¦ç”¨äºå‡å°‘æ˜¾å­˜ã€‚num_headsæ³¨æ„åŠ›æœºåˆ¶ä¸­ head çš„æ•°é‡ï¼Œå¦‚æœä¸º -1ï¼Œåˆ™æ ¹æ® num_head_channels è‡ªåŠ¨è®¡ç®—ã€‚num_head_channelsæ¯ä¸ª attention head çš„ç»´åº¦ï¼Œä¼˜å…ˆçº§é«˜äº num_headsã€‚äºŒè€…éœ€è‡³å°‘è®¾ç½®ä¸€ä¸ªã€‚num_heads_upsampleç”¨äºä¸Šé‡‡æ ·é˜¶æ®µçš„ attention head æ•°ï¼Œé»˜è®¤ä¸ num_heads ä¸€è‡´ã€‚use_scale_shift_normæ˜¯å¦åœ¨ ResBlock ä¸­ä½¿ç”¨ FiLM é£æ ¼çš„ scale-shift å½’ä¸€åŒ–ï¼ˆç”¨äºæ¡ä»¶å»ºæ¨¡ï¼‰ã€‚resblock_updownæ˜¯å¦ä½¿ç”¨æ®‹å·®å—è¿›è¡Œä¸Š/ä¸‹é‡‡æ ·ï¼Œå¦åˆ™ä½¿ç”¨ Downsample/Upsample æ¨¡å—ã€‚use_new_attention_orderæ§åˆ¶ attention é¡ºåºçš„å®éªŒæ€§è®¾ç½®ã€‚é»˜è®¤ä¸º Falseã€‚use_spatial_transformeræ˜¯å¦ä½¿ç”¨ Transformer æ›¿ä»£åŸç”Ÿ AttentionBlockã€‚å¼€å¯åéœ€è®¾ç½® context_dimã€‚transformer_depthTransformer æ¨¡å—çš„å †å æ·±åº¦ï¼ˆå±‚æ•°ï¼‰ã€‚context_dimCross-Attention ä¸­ contextï¼ˆå¦‚æ–‡æœ¬ã€å›¾åƒç¼–ç ï¼‰çš„ç»´åº¦ï¼Œå¿…é¡»ä¸ transformer é…å¥—ã€‚n_embedå¦‚æœä¸ä¸º Noneï¼Œè¡¨ç¤ºè¯¥æ¨¡å‹ç”¨äºé¢„æµ‹ codebook çš„ç¦»æ•£ tokenï¼ˆå¦‚ VQ-VAE / VQGAN åœºæ™¯ï¼‰ã€‚legacyæ§åˆ¶æ˜¯å¦ä½¿ç”¨ legacy çš„ attention ç»´åº¦è®¾ç½®é€»è¾‘ã€‚True è¡¨ç¤ºä¿æŒæ—§å®ç°å…¼å®¹æ€§ã€‚disable_self_attentionsæ˜¯å¦ç¦ç”¨æŸäº›å±‚ä¸­çš„ self-attnã€‚ä¸ºä¸€ä¸ªå¸ƒå°”åˆ—è¡¨ï¼Œé•¿åº¦ç­‰äº channel_multã€‚num_attention_blocksæ§åˆ¶æ¯ä¸ªå±‚çš„ attention block æ•°é‡ã€‚ä¼˜å…ˆçº§ä½äº attention_resolutionsã€‚disable_middle_self_attnæ˜¯å¦ç¦ç”¨ U-Net æœ€åº•éƒ¨ï¼ˆä¸­é—´å±‚ï¼‰çš„ self-attnã€‚use_linear_in_transformeræ˜¯å¦åœ¨ transformer ä¸­ä½¿ç”¨ Linear å½¢å¼çš„æŠ•å½±å±‚ã€‚semb_channelsç»“æ„æ¡ä»¶é€šé“æ•°ï¼ˆä¾‹å¦‚ç»“æ„å›¾ã€å°æ³¢å­å¸¦ç­‰ï¼‰ï¼Œä¼šä¼ å…¥ ResBlockDual è¿›è¡Œæ—¶é—´/ç»“æ„èåˆã€‚\nä¸ Time-Aware Encoder çš„å…³ç³»\nä½œä¸º Time-Aware Encoderï¼Œè¿™äº›å‚æ•°ä¸­ä»¥ä¸‹å‡ é¡¹èµ·å…³é”®ä½œç”¨ï¼š\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nå‚æ•°Time-Aware Encoder ä¸­çš„æ„ä¹‰t_embï¼ˆéšå«äº time_embedï¼‰ä¸ºæ¯ä¸ªæ—¶åˆ» t ç”Ÿæˆæ—¶é—´åµŒå…¥ï¼Œä¸ç»“æ„ä¸€èµ·å‚ä¸ç”Ÿæˆï¼ˆç±»ä¼¼æ—¶é—´æ¡ä»¶æ‰©æ•£ï¼‰semb_channelsæ”¯æŒç»“æ„æ¡ä»¶çš„é€šé“è¾“å…¥ï¼ˆå¦‚å°æ³¢å­å¸¦ã€æ·±åº¦å›¾ã€è¾¹ç¼˜å›¾ç­‰ï¼‰ï¼Œé€šè¿‡ ResBlockDual èåˆè¿›å…¥ä¸»å¹²ç½‘ç»œcontext_dim + use_spatial_transformerå®ç° Cross-Attentionï¼Œç”¨äºå°†æ–‡æœ¬/å›¾åƒä¸Šä¸‹æ–‡ä¿¡æ¯èåˆè¿›ç‰¹å¾æµuse_checkpoint + use_fp16æ§åˆ¶è®­ç»ƒæ—¶çš„è®¡ç®—æ•ˆç‡ï¼Œé€‚åˆå¤§è§„æ¨¡æ—¶é—´åºåˆ—è®­ç»ƒ"},"StableSR_doc/ldm/modules/diffusionmodules/openaimodel/class-UNetModelDualcondV2/convert_to_fp16":{"slug":"StableSR_doc/ldm/modules/diffusionmodules/openaimodel/class-UNetModelDualcondV2/convert_to_fp16","filePath":"StableSR_doc/ldm/modules/diffusionmodules/openaimodel/class UNetModelDualcondV2/convert_to_fp16.md","title":"convert_to_fp16","links":[],"tags":[],"content":""},"StableSR_doc/ldm/modules/diffusionmodules/openaimodel/class-UNetModelDualcondV2/convert_to_fp32":{"slug":"StableSR_doc/ldm/modules/diffusionmodules/openaimodel/class-UNetModelDualcondV2/convert_to_fp32","filePath":"StableSR_doc/ldm/modules/diffusionmodules/openaimodel/class UNetModelDualcondV2/convert_to_fp32.md","title":"convert_to_fp32","links":[],"tags":[],"content":""},"StableSR_doc/ldm/modules/diffusionmodules/openaimodel/class-UNetModelDualcondV2/forward":{"slug":"StableSR_doc/ldm/modules/diffusionmodules/openaimodel/class-UNetModelDualcondV2/forward","filePath":"StableSR_doc/ldm/modules/diffusionmodules/openaimodel/class UNetModelDualcondV2/forward.md","title":"forward","links":[],"tags":[],"content":""},"StableSR_doc/ldm/utils/Module_info":{"slug":"StableSR_doc/ldm/utils/Module_info","filePath":"StableSR_doc/ldm/utils/Module_info.md","title":"Module_info","links":["StableSR_doc/ldm/utils/get_obj_from_str","StableSR_doc/ldm/utils/instantiate_from_config"],"tags":[],"content":"Functions\n\nget_obj_from_str\ninstantiate_from_config\n"},"StableSR_doc/ldm/utils/get_obj_from_str":{"slug":"StableSR_doc/ldm/utils/get_obj_from_str","filePath":"StableSR_doc/ldm/utils/get_obj_from_str.md","title":"get_obj_from_str","links":[],"tags":[],"content":"def get_obj_from_str(string, reload=False):\n    module, cls = string.rsplit(&quot;.&quot;, 1)\n    if reload:\n        module_imp = importlib.import_module(module)\n        importlib.reload(module_imp)\n    return getattr(importlib.import_module(module, package=None), cls)"},"StableSR_doc/ldm/utils/instantiate_from_config":{"slug":"StableSR_doc/ldm/utils/instantiate_from_config","filePath":"StableSR_doc/ldm/utils/instantiate_from_config.md","title":"instantiate_from_config","links":["StableSR_doc/ldm/utils/get_obj_from_str"],"tags":[],"content":"def instantiate_from_config(config):\n    if not &quot;target&quot; in config:\n        if config == &#039;__is_first_stage__&#039;:\n            return None\n        elif config == &quot;__is_unconditional__&quot;:\n            return None\n        raise KeyError(&quot;Expected key `target` to instantiate.&quot;)\n    return get_obj_from_str(config[&quot;target&quot;])(**config.get(&quot;params&quot;, dict()))\n \nä½œç”¨\nè¯»å–configé…ç½®æ–‡ä»¶,æŒ‰ç…§å…¶æŒ‡å®šè§„åˆ™å°†targetæŒ‡å®šçš„ç±»å®ä¾‹åŒ–.åŒæ—¶åœ¨ç¬¬2è¡Œifå—ä¸­ç»™å‡ºäº†ä¸è¿›è¡Œå®ä¾‹åŒ–çš„åˆ¤æ–­é€»è¾‘,å¯ä»¥åˆ©ç”¨å®ƒæ¥æ§åˆ¶å¼€å…³æŸäº›æ¨¡å—(å¦‚æ³¨æ„åŠ›æœºåˆ¶å’Œç»“æ„æ¡ä»¶).\nconfig é…ç½®è¦æ±‚\nåº”è¯¥ä½¿ç”¨yamlæ–‡ä»¶,åŒ…å«targeté¡¹ç”¨äºæŒ‡å®šç±»å,paramsé¡¹åŠå…¶å­é¡¹ç”¨äºæŒ‡å®šå®ä¾‹åŒ–æ—¶çš„æ¨¡å‹å‚æ•°.\nå…·ä½“çš„å®ä¾‹åŒ–é€»è¾‘å’Œè¿‡ç¨‹\nget_obj_from_str è¿”å›ä¸€ä¸ªç±»å¯¹è±¡,åœ¨get_obj_from_str(â€¦)åé¢çš„ (**config.get)(&quot;params&quot;,dict())ç›¸å½“äºå°†paramsä½œä¸ºå‚æ•°ä¼ å…¥åˆ°å‰é¢çš„ç±»å¯¹è±¡çš„__init__ä¸­,æœ€ç»ˆå®Œæˆå®ä¾‹åŒ–."},"StableSR_doc/pytorch-lightning":{"slug":"StableSR_doc/pytorch-lightning","filePath":"StableSR_doc/pytorch lightning.md","title":"pytorch lightning","links":[],"tags":[],"content":"pytorch lightingæ¨¡å—ç®€ä»‹\npl.LightningMoudule\npl.LightningModule æ˜¯å¯¹ torch.nn.Module çš„é«˜çº§å°è£…\nåªéœ€è¦å®ç°ä¸‹é¢å‡ ä¸ªå…³é”®æ–¹æ³•ï¼Œå®ƒå°±èƒ½å¸®ä½ è‡ªåŠ¨å®Œæˆè®­ç»ƒæµç¨‹ã€GPU åˆ†å‘ã€æ—¥å¿—è®°å½•ã€checkpointä¿å­˜ç­‰å¤æ‚æ“ä½œï¼š\n\n\n\n__init__(self): åˆå§‹åŒ–æ¨¡å‹ç»“æ„ã€æŸå¤±å‡½æ•°ã€è¶…å‚æ•°ç­‰ã€‚\n\n\n\n\nforward(self, x): å®šä¹‰å‰å‘ä¼ æ’­é€»è¾‘ï¼ˆæ³¨æ„ï¼šä»…åœ¨è°ƒç”¨ model(x) æ—¶ä½¿ç”¨ï¼Œè®­ç»ƒé€»è¾‘ç”¨ training_stepï¼‰ã€‚\n\n\n\n\ntraining_step(self, batch, batch_idx):å®šä¹‰ä¸€ä¸ªè®­ç»ƒæ­¥éª¤çš„è¡Œä¸ºï¼Œè¿”å› lossã€‚\n\n\né€šå¸¸çš„æ­¥éª¤æ˜¯\n\nä» batch å–å‡ºæ•°æ®ï¼›\nå‰å‘ä¼ æ’­ï¼›\nè®¡ç®—æŸå¤±ï¼›\nä½¿ç”¨ self.log(...) è‡ªåŠ¨è®°å½•æ—¥å¿—ï¼ˆå¦‚ lossï¼‰ã€‚\n\n\n\n\n\n\nvalidation_step(...) / test_step(...):éªŒè¯å’Œæµ‹è¯•é˜¶æ®µçš„è¡Œä¸ºï¼Œç»“æ„ä¸ training_step ç±»ä¼¼ã€‚\n\n\n\n\nconfigure_optimizers(self):è¿”å›ä¼˜åŒ–å™¨å’Œï¼ˆå¯é€‰çš„ï¼‰å­¦ä¹ ç‡è°ƒåº¦å™¨ã€‚\n\n\n\npytorch_Lightning Callback æœºåˆ¶\nPyTorch Lightning çš„ Callbackï¼ˆå›è°ƒæœºåˆ¶ï¼‰æ˜¯è®­ç»ƒè¿‡ç¨‹ä¸­çš„äº‹ä»¶é’©å­ç³»ç»Ÿï¼Œå…è®¸ç”¨æˆ·åœ¨è®­ç»ƒ / éªŒè¯ / æµ‹è¯• / ä¿å­˜ç­‰é˜¶æ®µæ’å…¥è‡ªå®šä¹‰é€»è¾‘ï¼Œç±»ä¼¼äºé’©å­ï¼ˆhookï¼‰æˆ–ç›‘å¬å™¨ã€‚\n\nâœ… å¸¸è§ç”¨é€”\n\nè‡ªåŠ¨ä¿å­˜æœ€ä½³æ¨¡å‹ï¼ˆå¦‚æ ¹æ® val/loss æœ€å°ï¼‰\nEarly stoppingï¼ˆæå‰åœæ­¢è®­ç»ƒï¼‰\næ—¥å¿—è®°å½• / å­¦ä¹ ç‡å¯è§†åŒ–\nè‡ªå®šä¹‰æ—¥å¿—ã€è¯„ä¼°ã€æ ·æœ¬å¯è§†åŒ–ç­‰è¡Œä¸º\n\n\nğŸ§© æ ¸å¿ƒæ¦‚å¿µï¼šCallback æ˜¯ä¸€ä¸ªç±»\nfrom pytorch_lightning.callbacks import Callback\n \nclass MyCallback(Callback):\n    def on_train_start(self, trainer, pl_module):\n        print(&quot;è®­ç»ƒå¼€å§‹ï¼&quot;)\n    \n    def on_validation_end(self, trainer, pl_module):\n        print(&quot;éªŒè¯é˜¶æ®µç»“æŸã€‚&quot;)\n \n    def on_train_batch_end(self, trainer, pl_module, outputs, batch, batch_idx):\n        print(f&quot;è®­ç»ƒç¬¬ {batch_idx} ä¸ª batch å®Œæˆ&quot;)\n\nğŸ§ª ä½¿ç”¨ Callback çš„æ–¹å¼\nfrom pytorch_lightning import Trainer\n \ntrainer = Trainer(callbacks=[MyCallback()])\nå¯ä»¥ä¸€æ¬¡æ€§æ³¨å†Œå¤šä¸ª callbackï¼š\ntrainer = Trainer(callbacks=[\n    MyCallback(),\n    ModelCheckpoint(...),\n    EarlyStopping(...)\n])\n\nğŸ“¦ å®˜æ–¹å†…ç½®å¸¸ç”¨å›è°ƒ\n1. ModelCheckpoint: ä¿å­˜æœ€ä¼˜æ¨¡å‹\nfrom pytorch_lightning.callbacks import ModelCheckpoint\n \ncheckpoint_callback = ModelCheckpoint(\n    monitor=&quot;val/loss&quot;,     # ç›‘æ§å“ªä¸ªæŒ‡æ ‡\n    save_top_k=1,           # åªä¿ç•™ top1\n    mode=&quot;min&quot;,             # ç›®æ ‡æ˜¯æœ€å°åŒ– loss\n    filename=&quot;best-checkpoint&quot;,\n    save_last=True\n)\n2. EarlyStopping: æå‰åœæ­¢\nfrom pytorch_lightning.callbacks import EarlyStopping\n \nearly_stop_callback = EarlyStopping(\n    monitor=&quot;val/loss&quot;,\n    patience=5,     # è‹¥ 5 ä¸ª epoch æ²¡æœ‰æå‡åˆ™åœæ­¢\n    mode=&quot;min&quot;\n)\n\nğŸ“š å¸¸ç”¨ Callback é’©å­æ–¹æ³•ä¸€è§ˆ\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\næ–¹æ³•åè°ƒç”¨æ—¶æœºon_fit_startfit() å¼€å§‹æ—¶on_train_startè®­ç»ƒé˜¶æ®µå¼€å§‹on_train_endè®­ç»ƒé˜¶æ®µç»“æŸon_train_batch_startæ¯ä¸ª batch å¼€å§‹å‰on_train_batch_endæ¯ä¸ª batch ç»“æŸåon_validation_endæ¯è½®éªŒè¯ç»“æŸåon_save_checkpointä¿å­˜ checkpoint æ—¶on_load_checkpointåŠ è½½ checkpoint æ—¶\n\nğŸ¯ å®ä¾‹ï¼šåœ¨éªŒè¯åè®°å½•å½“å‰æ¨¡å‹çŠ¶æ€\nclass LogModelNorm(Callback):\n    def on_validation_end(self, trainer, pl_module):\n        total_norm = 0\n        for p in pl_module.parameters():\n            if p.grad is not None:\n                param_norm = p.grad.data.norm(2)\n                total_norm += param_norm.item() ** 2\n        total_norm = total_norm ** 0.5\n        print(f&quot;å½“å‰æ¢¯åº¦èŒƒæ•°ï¼š{total_norm:.4f}&quot;)\n\nâœ… å°ç»“\n\nCallback æ˜¯ä¸€ç§è½»é‡çº§çš„æ’ä»¶ç³»ç»Ÿï¼›\næ‰€æœ‰æ¨¡å‹ç›¸å…³å›è°ƒéƒ½å¯ä»¥é›†ä¸­ç®¡ç†ï¼Œä¸æ±¡æŸ“æ ¸å¿ƒè®­ç»ƒé€»è¾‘ï¼›\néå¸¸é€‚åˆè®°å½•æ—¥å¿—ã€ä¿å­˜ä¸­é—´ç»“æœã€åŠ¨æ€ä¿®æ”¹è®­ç»ƒè¡Œä¸ºç­‰ã€‚\n"},"cè¯­è¨€/1.åŸºæœ¬è¯­æ³•/Enumerated-Types":{"slug":"cè¯­è¨€/1.åŸºæœ¬è¯­æ³•/Enumerated-Types","filePath":"cè¯­è¨€/1.åŸºæœ¬è¯­æ³•/Enumerated Types.md","title":"Enumerated Types","links":[],"tags":[],"content":""},"cè¯­è¨€/1.åŸºæœ¬è¯­æ³•/data-type":{"slug":"cè¯­è¨€/1.åŸºæœ¬è¯­æ³•/data-type","filePath":"cè¯­è¨€/1.åŸºæœ¬è¯­æ³•/data type.md","title":"data type","links":[],"tags":[],"content":"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\næ•°æ®ç±»å‹ (å…³é”®å­—)å¸¸è§å®šä¹‰/å£°æ˜æ–¹å¼å ä½ç¬¦ (printf/scanf)è¯´æ˜charchar c = &#039;A&#039;;%cå­—ç¬¦ç±»å‹ï¼ˆå®é™…ä¸Šå­˜å‚¨æ•´æ•°ï¼Œå¯¹åº” ASCII ç ï¼‰ã€‚é€šå¸¸ 1 å­—èŠ‚ (8 ä½)ã€‚signed charsigned char sc = -10;%cæ˜ç¡®å¸¦ç¬¦å·çš„å­—ç¬¦ï¼ŒèŒƒå›´ä¸€èˆ¬æ˜¯ -128 ~ 127ã€‚unsigned charunsigned char uc = 250;%c æˆ– %hhuæ— ç¬¦å·å­—ç¬¦ï¼ŒèŒƒå›´ 0 ~ 255ã€‚intint x = 42;%d æˆ– %iæ•´æ•°ï¼Œé€šå¸¸ 4 å­—èŠ‚ï¼ŒèŒƒå›´çº¦ -2,147,483,648 ~ 2,147,483,647ã€‚short / short intshort s = 100;%hdçŸ­æ•´å‹ï¼Œä¸€èˆ¬ 2 å­—èŠ‚ã€‚unsigned shortunsigned short us = 60000;%huæ— ç¬¦å·çŸ­æ•´å‹ï¼ŒèŒƒå›´çº¦ 0 ~ 65535ã€‚long / long intlong l = 123456;%ldé•¿æ•´å‹ï¼Œä¸€èˆ¬ 4 æˆ– 8 å­—èŠ‚ï¼ˆå–å†³äºç³»ç»Ÿï¼‰ã€‚unsigned longunsigned long ul = 4000000000UL;%luæ— ç¬¦å·é•¿æ•´å‹ã€‚long long / long long intlong long ll = 123456789LL;%lldæ›´å¤§çš„æ•´æ•°ï¼Œä¸€èˆ¬ 8 å­—èŠ‚ã€‚unsigned long longunsigned long long ull = 18446744073709551615ULL;%lluæœ€å¤§çš„æ ‡å‡†æ— ç¬¦å·æ•´æ•°ç±»å‹ã€‚floatfloat f = 3.14f;%få•ç²¾åº¦æµ®ç‚¹æ•°ï¼Œçº¦ 6~7 ä½æœ‰æ•ˆæ•°å­—ã€‚doubledouble d = 3.141592653;%lfåŒç²¾åº¦æµ®ç‚¹æ•°ï¼Œçº¦ 15~16 ä½æœ‰æ•ˆæ•°å­—ã€‚long doublelong double ld = 3.141592653589793L;%Lfæ‰©å±•ç²¾åº¦æµ®ç‚¹ï¼Œç²¾åº¦æ¯” double é«˜ï¼ˆå¹³å°ä¾èµ–ï¼‰ã€‚_Bool (C99)_Bool flag = 1;%dåªèƒ½æ˜¯ 0 æˆ– 1ã€‚éœ€è¦ &lt;stdbool.h&gt; å¤´æ–‡ä»¶æ—¶å¯å†™ä½œ boolã€‚voidvoid func(void);æ— è¡¨ç¤ºâ€œæ— ç±»å‹â€ï¼Œç”¨äºå‡½æ•°è¿”å›ç±»å‹æˆ–æŒ‡é’ˆ (void*)ã€‚"},"cè¯­è¨€/1.åŸºæœ¬è¯­æ³•/typedef":{"slug":"cè¯­è¨€/1.åŸºæœ¬è¯­æ³•/typedef","filePath":"cè¯­è¨€/1.åŸºæœ¬è¯­æ³•/typedef.md","title":"typedef","links":[],"tags":[],"content":"typedefæ¦‚å¿µ\n\n\ntypedef æ˜¯ ç±»å‹é‡å®šä¹‰å…³é”®å­—ï¼Œç”¨æ¥ç»™å·²æœ‰çš„æ•°æ®ç±»å‹èµ·ä¸€ä¸ªæ–°çš„åå­—ï¼ˆåˆ«åï¼‰ã€‚\n\n\nå®ƒä¸ä¼šåˆ›å»ºæ–°çš„ç±»å‹ï¼Œåªæ˜¯è®©ä»£ç æ›´ç®€æ´ã€æ›´æ˜“è¯»ã€‚\n\n\nåŸºæœ¬è¯­æ³•\ntypedef åŸç±»å‹ æ–°ç±»å‹å;\nç¤ºä¾‹\nåŸºæœ¬ç±»å‹é‡å‘½å\ntypedef unsigned int uint;\n \nuint x = 10;  // ç­‰ä»·äº unsigned int x = 10;\næŒ‡é’ˆç±»å‹åˆ«å\ntypedef char* string;\n \nstring s1 = &quot;Hello&quot;;   // ç­‰ä»·äº char* s1 = &quot;Hello&quot;;\nç»“æ„ä½“ç®€åŒ–\næ²¡æœ‰ typedef æ—¶ï¼Œå®šä¹‰å˜é‡å¿…é¡»å†™ structï¼š\nstruct Student {\n    int id;\n    char name[20];\n};\nstruct Student s1;\nä½¿ç”¨ typedef å¯ä»¥ç»™ struct ç±»å‹èµ·ä¸€ä¸ªåˆ«åï¼š\nstruct StudentInfo {\n    int id;\n    char name[20];\n};\n \ntypedef struct StudentInfo Student; // ç”¨ typedef èµ·ä¸€ä¸ªåˆ«å\nStudent s1;   // ç­‰ä»·äº struct Student s1\nä¹Ÿå¯ä»¥ç®€å†™æˆåŒ¿åç»“æ„ä½“ + typedefï¼š\ntypedef struct {\n    int id;\n    char name[20];\n} Student;\n \nStudent s1;   // ä¸å†éœ€è¦å†™ struct\n\nä¸¤ç§ typedef struct çš„åŒºåˆ«\n\n\næœ‰æ ‡ç­¾çš„å†™æ³•\ntypedef struct StudentInfo {\n    char name[20];\n    int id;\n    float score;\n} Student1;\n \nstruct StudentInfo a;  // ç”¨æ ‡ç­¾\nStudent1 b;            // ç”¨åˆ«å\n\n\nå®šä¹‰äº† æ ‡ç­¾ struct StudentInfo å’Œ åˆ«å Student1ã€‚\n\n\nå…è®¸ å‰ç½®å£°æ˜ï¼Œå› æ­¤æ”¯æŒè‡ªå¼•ç”¨ï¼ˆé“¾è¡¨ã€æ ‘ç­‰æ•°æ®ç»“æ„å¸¸ç”¨ï¼‰ã€‚\n\n\n\n\nåŒ¿åç»“æ„ä½“å†™æ³•\ntypedef struct {\n    char name[20];\n    int id;\n    float score;\n} Student2;\n \nStudent2 c;  // ç”¨åˆ«å\n// struct ??? d; æ²¡æœ‰æ ‡ç­¾ï¼Œä¸èƒ½è¿™æ ·å†™\n\n\næ²¡æœ‰ç»“æ„ä½“æ ‡ç­¾ï¼Œåªæœ‰ åˆ«å Student2ã€‚\n\n\nä¸èƒ½å‰ç½®å£°æ˜ï¼Œå› æ­¤ ä¸èƒ½è‡ªå¼•ç”¨ï¼Œåªé€‚åˆç®€å•æ•°æ®ç»“æ„ã€‚\n\n\n\n\n\næ€»ç»“\n\n\næœ‰æ ‡ç­¾çš„å†™æ³•åŠŸèƒ½æ›´å®Œæ•´ï¼ˆèƒ½å‰ç½®å£°æ˜ã€è‡ªå¼•ç”¨ï¼‰ï¼Œæ›´é€‚åˆå¤æ‚åœºæ™¯ã€‚\n\n\nåŒ¿åå†™æ³•æ›´ç®€æ´ï¼Œå¸¸ç”¨äºç®€å•ç»“æ„æˆ–åº“æ¥å£ã€‚\n\n\nå¤æ‚ç±»å‹ç®€åŒ–\ntypedef int (*FuncPtr)(int, int);  \n \nint add(int a, int b) { return a + b; }\n \nFuncPtr f = add;\nprintf(&quot;%d\\n&quot;, f(3, 4));  // è¾“å‡º 7\ntypedef ä¸ #define çš„åŒºåˆ«\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nç‰¹æ€§typedef#defineå¤„ç†æ–¹å¼ç¼–è¯‘é˜¶æ®µé¢„å¤„ç†é˜¶æ®µï¼ˆæ–‡æœ¬æ›¿æ¢ï¼‰æ˜¯å¦æœ‰ä½œç”¨åŸŸæœ‰ï¼ˆä»…åœ¨å®šä¹‰ä½œç”¨åŸŸå†…æœ‰æ•ˆï¼‰æ— ï¼ˆå…¨å±€å®æ›¿æ¢ï¼‰èƒ½å¦å®šä¹‰æŒ‡é’ˆç±»å‹åˆ«åå¯ä»¥éœ€è¦æ‹¬å·ï¼Œå®¹æ˜“å‡ºé”™ä»£ç å¯è¯»æ€§æ›´å®‰å…¨ï¼Œæ›´ç›´è§‚å®¹æ˜“äº§ç”Ÿæ­§ä¹‰\nä¾‹å­ï¼š\n#define PTR_INT int*\ntypedef int* PtrInt;\n \nPTR_INT a, b;   // å®é™…æ˜¯ int* a, b;  (bä¸æ˜¯æŒ‡é’ˆ)\nPtrInt c, d;    // ä¸¤ä¸ªéƒ½æ˜¯ int* ç±»å‹\nå¸¸è§ç”¨æ³•æ€»ç»“\n\n\nç»™ åŸºæœ¬ç±»å‹ èµ·çŸ­åï¼ˆå¦‚ uintï¼‰ã€‚\n\n\nç»™ æŒ‡é’ˆç±»å‹ èµ·åˆ«åï¼ˆå¦‚ stringï¼‰ã€‚\n\n\nç»™ ç»“æ„ä½“/è”åˆ/æšä¸¾ èµ·åˆ«åï¼Œé¿å…æ¯æ¬¡å†™ structã€‚\n\n\nç»™ å‡½æ•°æŒ‡é’ˆ èµ·åˆ«åï¼Œç®€åŒ–å¤æ‚å£°æ˜ã€‚\n\n\nå°ç»“ï¼š\ntypedef æœ¬è´¨ä¸Šæ˜¯ ç±»å‹åˆ«åæœºåˆ¶ï¼Œå®ƒä¸åˆ›å»ºæ–°ç±»å‹ï¼Œåªæ˜¯æé«˜ å¯è¯»æ€§ å’Œ å¯ç»´æŠ¤æ€§ã€‚\nåœ¨å¤§å‹é¡¹ç›®ä¸­ï¼Œtypedef å¸¸ä¸ structã€enumã€å‡½æ•°æŒ‡é’ˆä¸€èµ·ä½¿ç”¨ï¼Œèƒ½è®©ä»£ç æ›´ç®€æ´ã€æ›´æ¸…æ™°ã€‚"},"cè¯­è¨€/1.åŸºæœ¬è¯­æ³•/å®macro":{"slug":"cè¯­è¨€/1.åŸºæœ¬è¯­æ³•/å®macro","filePath":"cè¯­è¨€/1.åŸºæœ¬è¯­æ³•/å®macro.md","title":"å®macro","links":[],"tags":[],"content":"åœ¨Cè¯­è¨€ä¸­ï¼Œå®æ˜¯é€šè¿‡é¢„å¤„ç†å™¨è¿›è¡Œæ–‡æœ¬æ›¿æ¢çš„ä¸€ç§åŠŸèƒ½ã€‚å®é€šå¸¸ç”¨äºç®€åŒ–ä»£ç ï¼Œå¢åŠ å¯è¯»æ€§ï¼Œæˆ–è€…åœ¨ç¼–è¯‘æ—¶æ‰§è¡Œä¸€äº›æ¡ä»¶ç¼–è¯‘æ“ä½œã€‚å®åœ¨ç¼–è¯‘è¿‡ç¨‹çš„é¢„å¤„ç†é˜¶æ®µå±•å¼€ï¼Œå®ƒä»¬ä¸ä¼šåœ¨è¿è¡Œæ—¶æ¶ˆè€—èµ„æºã€‚\nå®çš„ç§ç±»\n\n\nå¯¹è±¡å®ï¼ˆObject-like Macrosï¼‰\nå¯¹è±¡å®ç±»ä¼¼äºå¸¸é‡çš„æ›¿ä»£ï¼Œé€šå¸¸ç”¨äºå¸¸é‡å®šä¹‰ã€‚å®ƒæ˜¯ç›´æ¥ç”¨ä¸€ä¸ªåç§°æ›¿ä»£æŸä¸ªå€¼æˆ–è¡¨è¾¾å¼ã€‚\nç¤ºä¾‹ï¼š\n#define PI 3.14159\n#define MAX_BUFFER_SIZE 1024\nè¿™æ ·åœ¨ä»£ç ä¸­ï¼ŒPI ä¼šè¢«æ›¿æ¢æˆ 3.14159ï¼ŒMAX_BUFFER_SIZE ä¼šè¢«æ›¿æ¢æˆ 1024ã€‚\n\n\nå‡½æ•°å®ï¼ˆFunction-like Macrosï¼‰\nå‡½æ•°å®ç±»ä¼¼äºå‡½æ•°ï¼Œä½†å®ƒåœ¨é¢„å¤„ç†é˜¶æ®µè¢«ç›´æ¥æ›¿æ¢æˆå¯¹åº”çš„ä»£ç ã€‚å‡½æ•°å®å…è®¸å¸¦å‚æ•°ï¼Œå®å±•å¼€æ—¶ä¼šå°†å‚æ•°æ›¿æ¢åˆ°å®å®šä¹‰çš„ä½ç½®ã€‚\nç¤ºä¾‹ï¼š\n#define SQUARE(x) ((x) * (x))\n#define MAX(a, b) ((a) &gt; (b) ? (a) : (b))\nè¿™æ ·ï¼Œåœ¨ä»£ç ä¸­ï¼ŒSQUARE(4) ä¼šè¢«å±•å¼€æˆ ((4) * (4))ï¼ŒMAX(3, 5) ä¼šè¢«å±•å¼€æˆ ((3) &gt; (5) ? (3) : (5))ã€‚\næ³¨æ„ï¼š\n\n\nåœ¨å‡½æ•°å®ä¸­ï¼Œå‚æ•°åº”åŠ ä¸Šæ‹¬å·ï¼Œä»¥ç¡®ä¿è¡¨è¾¾å¼çš„ä¼˜å…ˆçº§æ­£ç¡®ã€‚\n\n\nå®å±•å¼€æ—¶æ²¡æœ‰ç±»å‹æ£€æŸ¥ï¼Œå› æ­¤å¯èƒ½ä¼šå¯¼è‡´ä¸€äº›æ½œåœ¨çš„é”™è¯¯ï¼Œæ¯”å¦‚å®å‚æ•°ä¸­æœ‰å‰¯ä½œç”¨ã€‚\n\n\n\n\næ¡ä»¶ç¼–è¯‘å®ï¼ˆConditional Compilationï¼‰\nå®ä¹Ÿå¯ä»¥ç”¨æ¥æ§åˆ¶ä»£ç çš„ç¼–è¯‘æ¡ä»¶ã€‚é€šè¿‡æ¡ä»¶ç¼–è¯‘ï¼Œå¯ä»¥æ ¹æ®ä¸åŒçš„ç¯å¢ƒæˆ–é…ç½®æ¥å†³å®šæ˜¯å¦ç¼–è¯‘æŸäº›ä»£ç å—ã€‚\nç¤ºä¾‹ï¼š\n#ifdef DEBUG\n    printf(&quot;Debugging enabled\\n&quot;);\n#else\n    printf(&quot;Debugging disabled\\n&quot;);\n#endif\n#ifdef ç”¨æ¥æ£€æŸ¥æ˜¯å¦å®šä¹‰äº† DEBUGï¼Œå¦‚æœå®šä¹‰äº† DEBUGï¼Œé‚£ä¹ˆå¯¹åº”çš„ä»£ç å—ä¼šè¢«ç¼–è¯‘ï¼Œå¦åˆ™è·³è¿‡ã€‚\n\n\n#defineä¸#undef\n\n\n#define ç”¨äºå®šä¹‰å®ã€‚\n\n\n#undef ç”¨äºå–æ¶ˆå·²å®šä¹‰çš„å®ã€‚\n\n\nç¤ºä¾‹ï¼š\n#define DEBUG\n#undef DEBUG\n\n\nå®æ›¿æ¢ä¸å‰¯ä½œç”¨é—®é¢˜\nç”±äºå®æ˜¯ç®€å•çš„æ–‡æœ¬æ›¿æ¢ï¼Œåœ¨ä½¿ç”¨å‡½æ•°å®æ—¶ï¼Œè¦å°å¿ƒå‚æ•°ä¸­çš„å‰¯ä½œç”¨ã€‚æ¯”å¦‚ï¼š\n#define SQUARE(x) ((x) * (x))\nint a = 2;\nint result = SQUARE(a++);\nåœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œa++ ä¼šè¢«å±•å¼€æˆ ((a++) * (a++))ï¼Œè¿™å¯èƒ½ä¼šå¯¼è‡´æ„å¤–çš„å‰¯ä½œç”¨ï¼ˆä¾‹å¦‚ a çš„å€¼å˜å¾—ä¸ç¬¦åˆé¢„æœŸï¼‰ã€‚\n\n\nå®çš„ä¼˜ç¼ºç‚¹\nä¼˜ç‚¹ï¼š\n\n\næ€§èƒ½æå‡ï¼šå®æ›¿æ¢åœ¨ç¼–è¯‘æ—¶è¿›è¡Œï¼Œå› æ­¤åœ¨è¿è¡Œæ—¶æ²¡æœ‰é¢å¤–çš„å¼€é”€ã€‚\n\n\nä»£ç ç®€æ´ï¼šå¯ä»¥ä½¿ç”¨å®é¿å…é‡å¤ç¼–å†™ç›¸åŒçš„ä»£ç ã€‚\n\n\næ¡ä»¶ç¼–è¯‘ï¼šå®å¯ä»¥å¸®åŠ©åœ¨ä¸åŒå¹³å°æˆ–è€…é…ç½®ä¸­ç¼–è¯‘ä¸åŒçš„ä»£ç ã€‚\n\n\nç¼ºç‚¹ï¼š\n\n\nç¼ºä¹ç±»å‹å®‰å…¨ï¼šå®åªæ˜¯ç®€å•çš„æ–‡æœ¬æ›¿æ¢ï¼Œæ²¡æœ‰ç±»å‹æ£€æŸ¥ï¼Œå®¹æ˜“äº§ç”Ÿé”™è¯¯ã€‚\n\n\nè°ƒè¯•å›°éš¾ï¼šè°ƒè¯•å®å±•å¼€åçš„ä»£ç ä¸å¦‚å‡½æ•°ç›´è§‚ï¼Œå› ä¸ºå®ƒä»¬åœ¨ç¼–è¯‘æ—¶å±•å¼€ï¼Œè°ƒè¯•æ—¶æ— æ³•çœ‹åˆ°å±•å¼€åçš„å®Œæ•´ä»£ç ã€‚\n\n\nå‰¯ä½œç”¨é—®é¢˜ï¼šå®çš„å‚æ•°ä¼šå¤šæ¬¡è®¡ç®—ï¼Œå¯èƒ½å¯¼è‡´å‰¯ä½œç”¨ï¼Œå°¤å…¶åœ¨ä½¿ç”¨å¸¦æœ‰å‰¯ä½œç”¨çš„è¡¨è¾¾å¼æ—¶ã€‚\n\n\næ€»ç»“æ¥è¯´ï¼Œå®æ˜¯Cè¯­è¨€ä¸­éå¸¸å¼ºå¤§çš„åŠŸèƒ½ï¼Œä½†åœ¨ä½¿ç”¨æ—¶è¦å°å¿ƒå¤„ç†å‰¯ä½œç”¨å’Œè°ƒè¯•é—®é¢˜ã€‚å¦‚æœå¯èƒ½ï¼Œåº”è¯¥å°½é‡ä½¿ç”¨ const æˆ– inline å‡½æ•°æ¥æ›¿ä»£å®ï¼Œé¿å…ä¸€äº›æ½œåœ¨çš„é”™è¯¯ã€‚"},"cè¯­è¨€/1.åŸºæœ¬è¯­æ³•/å±€éƒ¨å˜é‡ã€å…¨å±€å˜é‡ä¸é™æ€å˜é‡":{"slug":"cè¯­è¨€/1.åŸºæœ¬è¯­æ³•/å±€éƒ¨å˜é‡ã€å…¨å±€å˜é‡ä¸é™æ€å˜é‡","filePath":"cè¯­è¨€/1.åŸºæœ¬è¯­æ³•/å±€éƒ¨å˜é‡ã€å…¨å±€å˜é‡ä¸é™æ€å˜é‡.md","title":"å±€éƒ¨å˜é‡ã€å…¨å±€å˜é‡ä¸é™æ€å˜é‡","links":["cè¯­è¨€/1.åŸºæœ¬è¯­æ³•/é®è”½(shadowingï¼‰"],"tags":[],"content":"å±€éƒ¨å˜é‡\n\n\nä½œç”¨åŸŸï¼š\n\nå±€éƒ¨å˜é‡çš„ä½œç”¨åŸŸä»…é™äºå®ƒæ‰€åœ¨çš„å‡½æ•°ã€ifã€for æˆ– while ç­‰ä»£ç å—å†…éƒ¨ã€‚åœ¨ä»£ç å—å¤–éƒ¨æ— æ³•è®¿é—®è¯¥å˜é‡ã€‚\nä¾‹å¦‚ï¼Œfor å¾ªç¯ä¸­å£°æ˜çš„å˜é‡åªåœ¨å¾ªç¯å†…éƒ¨æœ‰æ•ˆã€‚\n\n\n\nç”Ÿå­˜æœŸï¼š\n\nå±€éƒ¨å˜é‡çš„ç”Ÿå­˜æœŸä»å®ƒä»¬è¢«å£°æ˜æ—¶å¼€å§‹ï¼Œç›´åˆ°ä»£ç å—æ‰§è¡Œå®Œæ¯•ä¸ºæ­¢ã€‚å®ƒä»¬é€šå¸¸ä¿å­˜åœ¨æ ˆä¸Šï¼Œå› æ­¤å½“ç¨‹åºç¦»å¼€ä½œç”¨åŸŸæ—¶ï¼Œå±€éƒ¨å˜é‡ä¼šè¢«é”€æ¯ã€‚\n\nç¤ºä¾‹ï¼š\n\n\nvoid func() {\n  int x = 10;  // å±€éƒ¨å˜é‡ x\n  printf(&quot;%d\\n&quot;, x);\n}\n// x åœ¨ func å‡½æ•°å¤–éƒ¨æ— æ³•è®¿é—®\nåœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œx ä»…åœ¨ func() å‡½æ•°å†…éƒ¨æœ‰æ•ˆï¼Œé€€å‡ºå‡½æ•°å x è¢«é”€æ¯ã€‚\nå…¨å±€å˜é‡\nä½œç”¨åŸŸå’Œç”Ÿå­˜æœŸ\n\n\nä½œç”¨åŸŸï¼š\n\n\nå…¨å±€å˜é‡çš„ä½œç”¨åŸŸæ˜¯æ•´ä¸ªæ–‡ä»¶ã€‚å¦‚æœåœ¨å…¶ä»–æ–‡ä»¶ä¸­éœ€è¦è®¿é—®è¯¥å…¨å±€å˜é‡ï¼Œå¯ä»¥ä½¿ç”¨ extern å…³é”®å­—å£°æ˜ã€‚\n\n\nå…¨å±€å˜é‡åœ¨ç¨‹åºä¸­åªå­˜åœ¨ä¸€ä»½ï¼Œå¯ä»¥åœ¨ç¨‹åºä¸­çš„ä»»ä½•åœ°æ–¹è®¿é—®ã€‚\n\n\n\n\nç”Ÿå­˜æœŸï¼š\n\n\nå…¨å±€å˜é‡çš„ç”Ÿå­˜æœŸæ˜¯æ•´ä¸ªç¨‹åºçš„ç”Ÿå‘½å‘¨æœŸï¼Œä»ç¨‹åºå¼€å§‹åˆ°ç¨‹åºç»“æŸã€‚å®ƒä»¬é€šå¸¸ä¿å­˜åœ¨æ•°æ®æ®µä¸­ã€‚\n\n\nç¤ºä¾‹ï¼š\nint x = 10;  // å…¨å±€å˜é‡ x\n \nvoid func() {\n    printf(&quot;%d\\n&quot;, x);  // è®¿é—®å…¨å±€å˜é‡ x\n}\n \nint main() {\n    printf(&quot;%d\\n&quot;, x);  // è®¿é—®å…¨å±€å˜é‡ x\n    func();\n    return 0;\n}\n\n\nåœ¨ä¸Šè¿°ä»£ç ä¸­ï¼Œx æ˜¯å…¨å±€å˜é‡ï¼Œå¯ä»¥åœ¨ main() å’Œ func() ä¸­è®¿é—®ï¼Œå¹¶ä¸”å®ƒçš„å€¼ä¼šåœ¨ç¨‹åºæ‰§è¡ŒæœŸé—´ä¸€ç›´å­˜åœ¨ã€‚\nexternå…³é”®å­—\nå¦‚æœä½¿ç”¨externå…³é”®å­—å¯¼å‡ºå…¨å±€å˜é‡ï¼Œåˆ™åœ¨å…¶ä»–æ–‡ä»¶ä¸­ä¹Ÿå¯ä»¥è®¿é—®ã€‚\nfile1.c\n#include &lt;stdio.h&gt;\n \nint x = 10;  // å…¨å±€å˜é‡ x\n \nvoid print_x() {\n    printf(&quot;x = %d\\n&quot;, x);  // è®¿é—®å…¨å±€å˜é‡ x\n}\n \nfile2.c\n#include &lt;stdio.h&gt;\n \nextern int x;  // ä½¿ç”¨ extern å£°æ˜å…¨å±€å˜é‡ x\n \nvoid change_x() {\n    x = 20;  // ä¿®æ”¹å…¨å±€å˜é‡ x\n}\n \nint main() {\n    printf(&quot;Before change, x = %d\\n&quot;, x);  // è®¿é—®å…¨å±€å˜é‡ x\n    change_x();  // ä¿®æ”¹å…¨å±€å˜é‡ x\n    printf(&quot;After change, x = %d\\n&quot;, x);  // è®¿é—®ä¿®æ”¹åçš„å…¨å±€å˜é‡ x\n    return 0;\n}\n \nfile1.cä¸­å®šä¹‰äº†å…¨å±€å˜é‡ x,file2.cä¸­ä½¿ç”¨ extern int x; å£°æ˜äº† xï¼Œè¡¨ç¤ºå®ƒåœ¨å…¶ä»–æ–‡ä»¶ä¸­å·²ç»å®šä¹‰ã€‚ç„¶åï¼Œfile2.c å¯ä»¥è®¿é—®å’Œä¿®æ”¹ xã€‚externå¯ä»¥åœ¨ä»»æ„æ–‡ä»¶çš„ä»»æ„ä½ç½®å£°æ˜ï¼Œç¼–è¯‘å™¨å’Œè¿æ¥å™¨ä¼šè‡ªåŠ¨åœ¨æ‰€æœ‰å‚ä¸ç¼–è¯‘çš„æºæ–‡ä»¶ä¸­å¯»æ‰¾å…¶å®šä¹‰ã€‚\nå¯¹äºä¸Šè¿°ä¸¤ä¸ªæºæ–‡ä»¶ file1.c å’Œ file2.cï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è¿›è¡Œç¼–è¯‘å’Œé“¾æ¥ï¼š\ngcc file1.c file2.c -o program\n\nè¿è¡Œç¨‹åºæ—¶ï¼Œè¾“å‡ºå°†ä¼šæ˜¯ï¼š\nBefore change, x = 10 \nAfter change, x = 20\n\né™æ€å˜é‡ (static)\n\n\nå±€éƒ¨é™æ€å˜é‡ï¼š\n\n\nä½œç”¨åŸŸï¼šé™æ€å±€éƒ¨å˜é‡çš„ä½œç”¨åŸŸä¾ç„¶æ˜¯å±€éƒ¨çš„ï¼Œåªèƒ½åœ¨å®šä¹‰å®ƒçš„å‡½æ•°æˆ–ä»£ç å—å†…éƒ¨è®¿é—®ã€‚\n\n\nç”Ÿå­˜æœŸï¼šé™æ€å±€éƒ¨å˜é‡çš„ç”Ÿå­˜æœŸæ˜¯æ•´ä¸ªç¨‹åºçš„ç”Ÿå‘½å‘¨æœŸã€‚å³ä½¿å‡½æ•°é€€å‡ºï¼Œé™æ€å˜é‡çš„å€¼ä¼šè¢«ä¿ç•™ï¼Œåœ¨ä¸‹ä¸€æ¬¡è°ƒç”¨è¯¥å‡½æ•°æ—¶ï¼Œé™æ€å˜é‡ä»ç„¶ä¿æŒä¹‹å‰çš„å€¼ã€‚\n\n\nç¤ºä¾‹ï¼š\nvoid func() {\n    static int counter = 0;  // é™æ€å±€éƒ¨å˜é‡ counter\n    counter++;\n    printf(&quot;%d\\n&quot;, counter);\n}\n \nint main() {\n    func();  // è¾“å‡º 1\n    func();  // è¾“å‡º 2\n    func();  // è¾“å‡º 3\n    return 0;\n}\nåœ¨ä¸Šè¿°ä»£ç ä¸­ï¼Œcounter æ˜¯é™æ€å±€éƒ¨å˜é‡ï¼Œå®ƒçš„å€¼åªæœ‰åœ¨ç¬¬ä¸€æ¬¡è°ƒç”¨func()æ—¶åˆå§‹åŒ–ï¼Œåœ¨åç»­æ¯æ¬¡è°ƒç”¨ func() æ—¶ä¼šè·³è¿‡åˆå§‹åŒ–ï¼Œä¿æŒä¹‹å‰çš„å€¼å¹¶ç´¯åŠ ã€‚\n\n\nå…¨å±€é™æ€å˜é‡ï¼š\n\n\nä½œç”¨åŸŸï¼šé™æ€å…¨å±€å˜é‡çš„ä½œç”¨åŸŸè¢«é™åˆ¶åœ¨å½“å‰æ–‡ä»¶å†…ï¼Œå…¶ä»–æ–‡ä»¶æ— æ³•è®¿é—®ã€‚å®ƒçš„ä½œç”¨ç±»ä¼¼äºä¸€ä¸ªå±€éƒ¨çš„å…¨å±€å˜é‡ã€‚\n\n\nç”Ÿå­˜æœŸï¼šé™æ€å…¨å±€å˜é‡çš„ç”Ÿå­˜æœŸæ˜¯æ•´ä¸ªç¨‹åºçš„ç”Ÿå‘½å‘¨æœŸã€‚\n\n\nç¤ºä¾‹ï¼š\nstatic int x = 10;  // é™æ€å…¨å±€å˜é‡ xï¼Œä½œç”¨åŸŸä»…é™äºå½“å‰æ–‡ä»¶\n \nvoid func() {\n    printf(&quot;%d\\n&quot;, x);  // è®¿é—®é™æ€å…¨å±€å˜é‡ x\n}\nåœ¨è¯¥ç¤ºä¾‹ä¸­ï¼Œx æ˜¯é™æ€å…¨å±€å˜é‡ï¼Œå®ƒçš„ä½œç”¨åŸŸä»…é™äºå½“å‰æ–‡ä»¶ï¼Œå…¶ä»–æ–‡ä»¶æ— æ³•è®¿é—®ã€‚\n\n\næ€»ç»“\n\n\nå±€éƒ¨å˜é‡ï¼šä½œç”¨åŸŸæ˜¯ä»£ç å—å†…ï¼Œç”Ÿå­˜æœŸä»…åœ¨ä»£ç å—æ‰§è¡ŒæœŸé—´ã€‚\n\n\nå…¨å±€å˜é‡ï¼šä½œç”¨åŸŸæ˜¯æ•´ä¸ªæ–‡ä»¶ï¼Œç”Ÿå­˜æœŸæ˜¯ç¨‹åºç”Ÿå‘½å‘¨æœŸã€‚\n\n\né™æ€å˜é‡ï¼š\n\n\né™æ€å±€éƒ¨å˜é‡ï¼šä½œç”¨åŸŸæ˜¯å±€éƒ¨çš„ï¼Œç”Ÿå­˜æœŸæ˜¯ç¨‹åºç”Ÿå‘½å‘¨æœŸï¼Œè·¨å‡½æ•°è°ƒç”¨ä¿æŒå€¼ã€‚\n\n\né™æ€å…¨å±€å˜é‡ï¼šä½œç”¨åŸŸæ˜¯å½“å‰æ–‡ä»¶ï¼Œç”Ÿå­˜æœŸæ˜¯ç¨‹åºç”Ÿå‘½å‘¨æœŸã€‚\n\n\n\n\næ³¨æ„ï¼šå±€éƒ¨å£°æ˜çš„å˜é‡å¦‚æœä¸å¤–éƒ¨ä½œç”¨åŸŸå˜é‡é‡ååˆ™ä¼šå‘ç”Ÿé®è”½(shadowingï¼‰"},"cè¯­è¨€/1.åŸºæœ¬è¯­æ³•/ç»“æ„ä½“(struct)":{"slug":"cè¯­è¨€/1.åŸºæœ¬è¯­æ³•/ç»“æ„ä½“(struct)","filePath":"cè¯­è¨€/1.åŸºæœ¬è¯­æ³•/ç»“æ„ä½“(struct).md","title":"ç»“æ„ä½“(struct)","links":["cè¯­è¨€/1.åŸºæœ¬è¯­æ³•/typedef"],"tags":[],"content":"ç»“æ„ä½“æ¦‚å¿µ\nåœ¨Cè¯­è¨€ä¸­ï¼Œç»“æ„ä½“ï¼ˆstructï¼‰ æ˜¯ä¸€ç§ç”¨æˆ·è‡ªå®šä¹‰çš„æ•°æ®ç±»å‹ï¼Œå®ƒå¯ä»¥æŠŠå¤šä¸ªä¸åŒç±»å‹çš„æ•°æ®ç»„åˆåœ¨ä¸€èµ·ï¼Œå½¢æˆä¸€ä¸ªæ•´ä½“ã€‚\nç»“æ„ä½“é€‚ç”¨äºæè¿° å¤æ‚å¯¹è±¡ï¼Œæ¯”å¦‚ä¸€ä¸ªå­¦ç”Ÿï¼ˆæœ‰å­¦å·ã€å§“åã€æˆç»©ç­‰ï¼‰ã€ä¸€ä¸ªç‚¹ï¼ˆæœ‰xã€yåæ ‡ï¼‰ã€ä¸€è¾†è½¦ï¼ˆæœ‰è½¦ç‰Œå·ã€é¢œè‰²ã€é€Ÿåº¦ç­‰ï¼‰ã€‚\n\nç»“æ„ä½“çš„å®šä¹‰æ–¹å¼\nåŸºæœ¬è¯­æ³•\nstruct ç»“æ„ä½“å {\n    æ•°æ®ç±»å‹ æˆå‘˜å1;\n    æ•°æ®ç±»å‹ æˆå‘˜å2;\n    ...\n};\nç¤ºä¾‹\nstruct Student {\n    int id;        // å­¦å·\n    char name[20]; // å§“å\n    float score;   // æˆç»©\n};\nè¿™æ ·å°±å®šä¹‰äº†ä¸€ä¸ª Student ç±»å‹ã€‚\n\nå®šä¹‰ç»“æ„ä½“å˜é‡\nstruct Student s1;    // å®šä¹‰ä¸€ä¸ªç»“æ„ä½“å˜é‡\nstruct Student s2 = {1001, &quot;Alice&quot;, 95.5};  // å®šä¹‰å¹¶åˆå§‹åŒ–\nè¿˜å¯ä»¥å’Œtypedefé…åˆï¼š\ntypedef struct {\n    int x;\n    int y;\n} Point;\n \nPoint p1 = {10, 20};\nè®¿é—®ç»“æ„ä½“æˆå‘˜\nç»“æ„ä½“æˆå‘˜é€šè¿‡ . è¿ç®—ç¬¦ æ¥è®¿é—®ï¼š\nprintf(&quot;ID: %d, Name: %s, Score: %.2f\\n&quot;, s2.id, s2.name, s2.score);\nå¦‚æœæ˜¯ ç»“æ„ä½“æŒ‡é’ˆï¼Œåˆ™é€šè¿‡ -&gt; è¿ç®—ç¬¦è®¿é—®ï¼š\nstruct Student *ps = &amp;s2;\nprintf(&quot;Name = %s\\n&quot;, ps-&gt;name);\nç»“æ„ä½“æ•°ç»„\nç»“æ„ä½“ä¹Ÿèƒ½ç»„æˆæ•°ç»„ï¼Œæ–¹ä¾¿æ‰¹é‡ç®¡ç†ã€‚\nstruct Student class[3] = {\n    {1001, &quot;Alice&quot;, 95.5},\n    {1002, &quot;Bob&quot;, 88.0},\n    {1003, &quot;Charlie&quot;, 92.5}\n};\nç»“æ„ä½“åµŒå¥—\nç»“æ„ä½“æˆå‘˜è¿˜å¯ä»¥æ˜¯å¦ä¸€ä¸ªç»“æ„ä½“ï¼š\nstruct Date {\n    int year, month, day;\n};\n \nstruct Student {\n    int id;\n    char name[20];\n    struct Date birthday;  // åµŒå¥—çš„ç»“æ„ä½“\n};\n \nstruct Student s = {1001, &quot;Alice&quot;, {2003, 5, 10}};\nprintf(&quot;Birthday: %d-%d-%d\\n&quot;, s.birthday.year, s.birthday.month, s.birthday.day);\nç»“æ„ä½“ä¸å‡½æ•°\nç»“æ„ä½“å¯ä»¥ä½œä¸ºå‡½æ•°çš„ å‚æ•° æˆ– è¿”å›å€¼ï¼š\nstruct Point {\n    int x, y;\n};\n \nstruct Point move(struct Point p, int dx, int dy) {\n    p.x += dx;\n    p.y += dy;\n    return p;\n}\n \nint main() {\n    struct Point p1 = {0, 0};\n    p1 = move(p1, 5, 10);\n    printf(&quot;(%d, %d)\\n&quot;, p1.x, p1.y);  // (5, 10)\n}\nå†…å­˜ä¸å¯¹é½\n\n\nç»“æ„ä½“ä¸­æ¯ä¸ªæˆå‘˜åœ¨å†…å­˜ä¸­æ˜¯æŒ‰é¡ºåºå­˜å‚¨çš„ï¼Œä½†ä¼šæœ‰ å­—èŠ‚å¯¹é½ï¼ˆpaddingï¼‰ã€‚\n\n\nsizeof(struct) çš„ç»“æœå¯èƒ½å¤§äºæˆå‘˜å¤§å°ä¹‹å’Œã€‚\n\n\nå¦‚æœéœ€è¦ä¼˜åŒ–å†…å­˜ï¼Œå¯ä»¥è°ƒæ•´æˆå‘˜é¡ºåºï¼Œæˆ–è€…ä½¿ç”¨ #pragma packï¼ˆä¾èµ–ç¼–è¯‘å™¨ï¼‰ã€‚\n\n\nå¸¸è§ç”¨æ³•æ€»ç»“\n\n\næè¿°å®ä½“å¯¹è±¡ï¼šå¦‚å­¦ç”Ÿã€ç‚¹ã€æ—¥æœŸç­‰ã€‚\n\n\nç»“æ„ä½“æ•°ç»„ï¼šæ‰¹é‡å­˜å‚¨å¤šä¸ªå®ä½“ã€‚\n\n\nç»“æ„ä½“æŒ‡é’ˆï¼šå¸¸ç”¨äºå‡½æ•°å‚æ•°ä¼ é€’ï¼Œé¿å…å¤§è§„æ¨¡å¤åˆ¶ã€‚\n\n\nåµŒå¥—ç»“æ„ä½“ï¼šæè¿°å¤æ‚å¯¹è±¡ã€‚\n\n"},"cè¯­è¨€/1.åŸºæœ¬è¯­æ³•/é€»è¾‘è¿ç®—ç¬¦":{"slug":"cè¯­è¨€/1.åŸºæœ¬è¯­æ³•/é€»è¾‘è¿ç®—ç¬¦","filePath":"cè¯­è¨€/1.åŸºæœ¬è¯­æ³•/é€»è¾‘è¿ç®—ç¬¦.md","title":"é€»è¾‘è¿ç®—ç¬¦","links":[],"tags":[],"content":"C è¯­è¨€çš„é€»è¾‘è¿ç®—ç¬¦\nC è¯­è¨€ä¸­å…±æœ‰ 3 ä¸ªé€»è¾‘è¿ç®—ç¬¦ï¼Œç”¨äºå¯¹è¡¨è¾¾å¼çš„çœŸå‡è¿›è¡Œé€»è¾‘è¿ç®—ï¼Œè¿”å›ç»“æœä¸º 1ï¼ˆçœŸï¼Œtrueï¼‰æˆ– 0ï¼ˆå‡ï¼Œfalseï¼‰ã€‚\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nè¿ç®—ç¬¦å«ä¹‰ç¤ºä¾‹ç»“æœè¯´æ˜&amp;&amp;é€»è¾‘ä¸ ANDa &amp;&amp; bä¸¤ä¸ªæ“ä½œæ•°éƒ½ä¸ºçœŸæ—¶ç»“æœä¸º 1ï¼Œå¦åˆ™ä¸º 0||é€»è¾‘æˆ–ORa || bä¸¤ä¸ªæ“ä½œæ•°æœ‰ä¸€ä¸ªä¸ºçœŸæ—¶ç»“æœä¸º 1ï¼Œå¦åˆ™ä¸º 0!é€»è¾‘é NOT!aå¦‚æœ a ä¸ºçœŸï¼Œåˆ™ç»“æœä¸º 0ï¼›å¦‚æœ a ä¸ºå‡ï¼Œç»“æœä¸º 1\né€»è¾‘ä¸ &amp;&amp;\n\n\nè¡¨è¾¾å¼ a &amp;&amp; bï¼šå½“ä¸”ä»…å½“ a å’Œ b éƒ½ä¸ºçœŸæ—¶ï¼Œç»“æœä¸ºçœŸï¼ˆ1ï¼‰ï¼›å¦åˆ™ä¸ºå‡ï¼ˆ0ï¼‰ã€‚\n\n\nçŸ­è·¯ç‰¹æ€§ï¼šå¦‚æœ a ä¸ºå‡ï¼ˆ0ï¼‰ï¼Œåˆ™ b ä¸å†è®¡ç®—ã€‚\n\n\n#include &lt;stdio.h&gt;\nint main() {\n    int a = 1, b = 0;\n    printf(&quot;a &amp;&amp; b = %d\\n&quot;, a &amp;&amp; b);  // 0\n    printf(&quot;a &amp;&amp; 1 = %d\\n&quot;, a &amp;&amp; 1);  // 1\n    return 0;\n}\n\né€»è¾‘æˆ– ||\n\n\nè¡¨è¾¾å¼ a || bï¼šåªè¦ a æˆ– b æœ‰ä¸€ä¸ªä¸ºçœŸï¼ˆé 0ï¼‰ï¼Œç»“æœå°±ä¸ºçœŸï¼ˆ1ï¼‰ã€‚åªæœ‰å½“ a å’Œ b éƒ½ä¸ºå‡æ—¶ï¼Œç»“æœæ‰æ˜¯å‡ï¼ˆ0ï¼‰ã€‚\n\n\nçŸ­è·¯ç‰¹æ€§ï¼šå¦‚æœ a ä¸ºçœŸï¼Œåˆ™ b ä¸å†è®¡ç®—ã€‚\n\n\n#include &lt;stdio.h&gt;\nint main() {\n    int a = 1, b = 0;\n    printf(&quot;a || b = %d\\n&quot;, a || b);  // 1\n    printf(&quot;0 || 0 = %d\\n&quot;, 0 || 0);  // 0\n    return 0;\n}\n\né€»è¾‘é !\n\nè¡¨è¾¾å¼ !aï¼šå¯¹ a å–åï¼Œå¦‚æœ a ä¸ºçœŸï¼ˆé 0ï¼‰ï¼Œç»“æœä¸ºå‡ï¼ˆ0ï¼‰ï¼›å¦‚æœ a ä¸ºå‡ï¼ˆ0ï¼‰ï¼Œç»“æœä¸ºçœŸï¼ˆ1ï¼‰ã€‚\n\n#include &lt;stdio.h&gt;\nint main() {\n    int a = 1, b = 0;\n    printf(&quot;!a = %d\\n&quot;, !a);  // 0\n    printf(&quot;!b = %d\\n&quot;, !b);  // 1\n    return 0;\n}\né€»è¾‘è¿ç®—ç¬¦çš„ç‰¹ç‚¹\n\n\nè¿”å›å€¼ï¼šé€»è¾‘è¿ç®—çš„ç»“æœè¦ä¹ˆæ˜¯ 0ï¼ˆå‡ï¼‰ï¼Œè¦ä¹ˆæ˜¯ 1ï¼ˆçœŸï¼‰ã€‚\n\n\nçŸ­è·¯æ±‚å€¼ï¼š\n\n\na &amp;&amp; bï¼šå¦‚æœ a ä¸ºå‡ï¼Œç›´æ¥è¿”å› 0ï¼Œä¸å†è®¡ç®— bã€‚\n\n\na || bï¼šå¦‚æœ a ä¸ºçœŸï¼Œç›´æ¥è¿”å› 1ï¼Œä¸å†è®¡ç®— bã€‚\nè¿™åœ¨ç¼–ç¨‹æ—¶å¯ä»¥ç”¨æ¥é¿å…ä¸å¿…è¦çš„è®¡ç®—æˆ–é”™è¯¯ï¼ˆå¦‚é™¤é›¶ï¼‰ã€‚\n\n\n\n\nç»“åˆæ€§ï¼š\n\n\n! çš„ç»“åˆæ€§æ˜¯ å³ç»“åˆï¼›\n\n\n&amp;&amp; å’Œ || æ˜¯ å·¦ç»“åˆï¼›\n\n\nä¼˜å…ˆçº§ï¼š ! &gt; &amp;&amp; &gt; ||ã€‚\n\n\n\n\n\nç¤ºä¾‹ï¼šç»“åˆä¼˜å…ˆçº§\n#include &lt;stdio.h&gt;\nint main() {\n    int a = 1, b = 0, c = 0;\n    printf(&quot;%d\\n&quot;, a || b &amp;&amp; c);   // ç­‰ä»·äº a || (b &amp;&amp; c)\n    printf(&quot;%d\\n&quot;, (a || b) &amp;&amp; c); // åŠ æ‹¬å·æ”¹å˜ä¼˜å…ˆçº§\n    return 0;\n}\nè¾“å‡ºï¼š\n1\n0\n\n\nâœ… æ€»ç»“ï¼š\n\n\n&amp;&amp;ï¼šé€»è¾‘ä¸ï¼Œä¸¤ä¸ªéƒ½çœŸæ‰çœŸã€‚\n\n\n||ï¼šé€»è¾‘æˆ–ï¼Œæœ‰ä¸€ä¸ªçœŸå°±çœŸã€‚\n\n\n!ï¼šé€»è¾‘éï¼ŒçœŸå˜å‡ï¼Œå‡å˜çœŸã€‚\n\n\næ³¨æ„çŸ­è·¯ç‰¹æ€§å’Œä¼˜å…ˆçº§ï¼Œå®é™…ç¼–ç¨‹æ—¶å»ºè®®ç”¨æ‹¬å·æ¥æé«˜å¯è¯»æ€§ã€‚\n\n\n\nè¦ä¸è¦æˆ‘å†å¸®ä½ æ•´ç†ä¸€ä¸ª é€»è¾‘è¿ç®—ç¬¦ vs ä½è¿ç®—ç¬¦ï¼ˆ&amp;ã€|ã€~ã€^ï¼‰ çš„å¯¹æ¯”è¡¨ï¼Ÿè¿™æ ·ä½ åœ¨åšç¬”è®°æ—¶èƒ½é¿å…æ··æ·†ã€‚"},"cè¯­è¨€/1.åŸºæœ¬è¯­æ³•/é®è”½(shadowingï¼‰":{"slug":"cè¯­è¨€/1.åŸºæœ¬è¯­æ³•/é®è”½(shadowingï¼‰","filePath":"cè¯­è¨€/1.åŸºæœ¬è¯­æ³•/é®è”½(shadowingï¼‰.md","title":"é®è”½(shadowingï¼‰","links":[],"tags":[],"content":"é®è”½ï¼ˆShadowingï¼‰\nåœ¨ C è¯­è¨€ä¸­ï¼Œå¦‚æœåœ¨æŸä¸ªä½œç”¨åŸŸå†…å®šä¹‰äº†ä¸€ä¸ªä¸å¤–å±‚ä½œç”¨åŸŸï¼ˆä¾‹å¦‚å…¨å±€ä½œç”¨åŸŸæˆ–å‡½æ•°å¤–å±‚ä½œç”¨åŸŸï¼‰åŒåçš„å˜é‡ï¼Œé‚£ä¹ˆè¿™ä¸ªæ–°çš„å˜é‡ä¼šåœ¨å½“å‰ä½œç”¨åŸŸå†…â€œé®è”½â€ï¼ˆshadowï¼‰å¤–å±‚ä½œç”¨åŸŸä¸­çš„åŒåå˜é‡ã€‚\nè¿™æ„å‘³ç€ï¼š\n\n\nåœ¨å½“å‰ä½œç”¨åŸŸä¸­ï¼Œè®¿é—®åˆ°çš„å°†æ˜¯å±€éƒ¨å®šä¹‰çš„æ–°å˜é‡ï¼›\n\n\nå¤–å±‚çš„åŒåå˜é‡ä¸ä¼šè¢«é”€æ¯æˆ–ä¿®æ”¹ï¼Œåªæ˜¯æš‚æ—¶â€œä¸å¯è§â€ï¼›\n\n\nä¸€æ—¦ç¦»å¼€è¯¥å±€éƒ¨ä½œç”¨åŸŸï¼Œå¤–å±‚å˜é‡é‡æ–°å¯è§ï¼Œå¹¶ä¸”ä¿æŒåŸæœ‰å€¼ã€‚\n\n\n\nå‡½æ•°ä¸­çš„é®è”½\n#include &lt;stdio.h&gt;\n \nint x = 10;  // å…¨å±€å˜é‡ x\n \nvoid func() {\n    int x = 20;  // å±€éƒ¨å˜é‡ xï¼Œé®è”½äº†å…¨å±€å˜é‡ x\n    printf(&quot;Inside func, x = %d\\n&quot;, x);  // è¾“å‡ºå±€éƒ¨å˜é‡ x çš„å€¼ 20\n}\n \nint main() {\n    printf(&quot;Before func, x = %d\\n&quot;, x);  // è¾“å‡ºå…¨å±€å˜é‡ x çš„å€¼ 10\n    func();\n    printf(&quot;After func, x = %d\\n&quot;, x);   // è¾“å‡ºå…¨å±€å˜é‡ x çš„å€¼ 10\n    return 0;\n}\nè¾“å‡ºç»“æœï¼š\nBefore func, x = 10\nInside func, x = 20\nAfter func, x = 10\n\nåœ¨ func å†…é‡æ–°å£°æ˜äº†ä¸€ä¸ªå±€éƒ¨å˜é‡ xï¼Œå®ƒé®è”½äº†å…¨å±€å˜é‡ xã€‚å› æ­¤ï¼Œfunc å†…æ‰“å°çš„æ˜¯å±€éƒ¨å˜é‡çš„å€¼ï¼Œè€Œåœ¨ main ä¸­è°ƒç”¨ func å‰åï¼Œå…¨å±€å˜é‡ x ä¿æŒä¸å˜ã€‚\n\nå—ä½œç”¨åŸŸä¸­çš„é®è”½\né®è”½ä¸ä»…èƒ½å‘ç”Ÿåœ¨å‡½æ•°å†…éƒ¨ï¼Œä¹Ÿå¯ä»¥å‘ç”Ÿåœ¨ä»£ç å—ï¼ˆå¦‚å¾ªç¯æˆ–æ¡ä»¶è¯­å¥ï¼‰ä¸­ï¼š\n#include &lt;stdio.h&gt;\n \nint x = 10;  // å…¨å±€å˜é‡\n \nint main() {\n    printf(&quot;Global x before block: %d\\n&quot;, x);\n \n    {\n        int x = 30;  // æ–°çš„å±€éƒ¨å˜é‡ï¼Œé®è”½å…¨å±€å˜é‡\n        printf(&quot;Block x: %d\\n&quot;, x);\n    }\n \n    printf(&quot;Global x after block: %d\\n&quot;, x);\n    return 0;\n}\nè¾“å‡ºç»“æœï¼š\nGlobal x before block: 10\nBlock x: 30\nGlobal x after block: 10\n\nåœ¨ {} å—å†…å£°æ˜äº†ä¸€ä¸ªæ–°çš„ xï¼Œå®ƒé®è”½äº†å…¨å±€å˜é‡ xã€‚ä½†ç¦»å¼€è¿™ä¸ªå—åï¼Œæ–°çš„å±€éƒ¨å˜é‡ç”Ÿå‘½å‘¨æœŸç»“æŸï¼Œå…¨å±€å˜é‡ x åˆæ¢å¤å¯è§ã€‚\n\næ³¨æ„äº‹é¡¹\n\n\né®è”½å¹¶ä¸ä¼šä¿®æ”¹å¤–å±‚å˜é‡çš„å€¼\né‡æ–°å£°æ˜çš„å˜é‡åªæ˜¯ä¸€ä¸ªæ–°çš„å®ä½“ï¼Œç”Ÿå‘½å‘¨æœŸå’Œå­˜å‚¨ç©ºé—´éƒ½ä¸åŒï¼Œä¸ä¼šå½±å“å¤–å±‚çš„åŒåå˜é‡ã€‚\n\n\nä½œç”¨åŸŸè§„åˆ™ä¼˜å…ˆ\nåœ¨ C è¯­è¨€ä¸­ï¼Œå°±è¿‘åŸåˆ™å†³å®šäº†å˜é‡çš„è§£æï¼šç¼–è¯‘å™¨æ€»æ˜¯ä¼˜å…ˆä½¿ç”¨å½“å‰ä½œç”¨åŸŸå†…æœ€æ¥è¿‘çš„å£°æ˜ã€‚\n\n\næ˜“å¼•å‘æ··æ·†\nå¦‚æœåœ¨ä»£ç ä¸­è¿‡åº¦ä½¿ç”¨é®è”½ï¼Œå®¹æ˜“è®©äººè¯¯ä»¥ä¸ºæ“ä½œçš„æ˜¯å…¨å±€å˜é‡ï¼Œå®é™…ä¸Šå´æ˜¯åœ¨ä¿®æ”¹å±€éƒ¨å˜é‡ã€‚å»ºè®®å®é™…ç¼–ç¨‹ä¸­é¿å…ä½¿ç”¨ç›¸åŒçš„å˜é‡åã€‚\n\n\n\nå¦‚ä½•è®¿é—®è¢«é®è”½çš„å…¨å±€å˜é‡\nåœ¨ C è¯­è¨€é‡Œï¼Œå¦‚æœå±€éƒ¨å˜é‡é®è”½äº†å…¨å±€å˜é‡ï¼Œå¯ä»¥é€šè¿‡ åœ¨å±€éƒ¨ä½œç”¨åŸŸå†…ä½¿ç”¨ extern æ˜¾å¼å£°æ˜ æ¥è®¿é—®å…¨å±€å˜é‡ï¼š\n#include &lt;stdio.h&gt;\n \nint x = 10;  // å…¨å±€å˜é‡\n \nvoid func() {\n    int x = 20;  \n    printf(&quot;Local x = %d\\n&quot;, x);  // è¾“å‡º 20\n \n    extern int x;  // å¼•ç”¨å…¨å±€å˜é‡ x\n    printf(&quot;Global x = %d\\n&quot;, x); // è¾“å‡º 10\n}\nè¿™æ ·å¯ä»¥åŒºåˆ†åˆ°åº•è®¿é—®çš„æ˜¯å“ªä¸€ä¸ª xã€‚ä¸è¿‡ï¼Œä»£ç å¯è¯»æ€§ä¼šå˜å·®ï¼Œä¸€èˆ¬ä¸æ¨èã€‚\næ€»ç»“\n\n\né®è”½ï¼ˆshadowingï¼‰æŒ‡çš„æ˜¯å†…å±‚ä½œç”¨åŸŸçš„å˜é‡ä¸å¤–å±‚ä½œç”¨åŸŸçš„å˜é‡åŒåï¼Œä»è€Œè®©å¤–å±‚å˜é‡åœ¨è¯¥ä½œç”¨åŸŸå†…â€œä¸å¯è§â€ã€‚\n\n\nå¤–å±‚å˜é‡çš„å€¼ä¸ä¼šå› é®è”½è€Œæ”¹å˜ï¼Œä½œç”¨åŸŸç»“æŸåä¼šé‡æ–°å¯è§ã€‚\n\n\nå®é™…ç¼–ç¨‹ä¸­åº”å°½é‡é¿å…ä½¿ç”¨ç›¸åŒçš„å˜é‡åï¼Œä»¥å‡å°‘æ··æ·†ã€‚\n\n\n\nè¦ä¸è¦æˆ‘å†å¸®ä½ æ‰©å±•ä¸€ä¸ª å‡½æ•°å‚æ•°é®è”½å…¨å±€å˜é‡ çš„ç¤ºä¾‹ï¼Œè®©è¿™ä¸€èŠ‚æ›´å®Œæ•´ï¼Ÿ"},"cè¯­è¨€/3.æŒ‡é’ˆã€æ•°ç»„ä¸é€’å½’ç®—æ³•/æŒ‡é’ˆ(Pointer)":{"slug":"cè¯­è¨€/3.æŒ‡é’ˆã€æ•°ç»„ä¸é€’å½’ç®—æ³•/æŒ‡é’ˆ(Pointer)","filePath":"cè¯­è¨€/3.æŒ‡é’ˆã€æ•°ç»„ä¸é€’å½’ç®—æ³•/æŒ‡é’ˆ(Pointer).md","title":"æŒ‡é’ˆ(Pointer)","links":[],"tags":[],"content":"æŒ‡é’ˆæ¦‚å¿µ\næŒ‡é’ˆæœ¬èº«ä¸æ˜¯ä¸€ä¸ªæ•°æ®ç±»å‹ï¼Œè€Œæ˜¯ä¸€ç§ç±»å‹æ„é€ å™¨ï¼Œç»™å®šä»»ä½•ä¸€ç§ç±»å‹ï¼ˆintã€floatã€charç­‰ï¼‰ï¼Œå¯ä»¥é€šè¿‡æ˜Ÿå·ç”ŸæˆæŒ‡å‘è¯¥ç±»å‹å˜é‡çš„æŒ‡é’ˆã€‚\nint x = 10;\nint* ptr_to_int = &amp;x;\n&amp;æ˜¯å–åœ°å€è¿ç®—ç¬¦ï¼Œå®ƒå¯ä»¥ä½œç”¨åœ¨Cè¯­è¨€çš„ä»»ä½•å·¦å€¼ï¼ˆlvalueï¼‰ä¸Šï¼Œå¹¶è¿”å›è¯¥å·¦å€¼çš„å†…å­˜åœ°å€ã€‚\n*æ˜¯è§£å¼•ç”¨è¿ç®—ç¬¦ï¼Œå®ƒä½œç”¨åœ¨ä¸€ä¸ªæŒ‡é’ˆä¸Šæ—¶ï¼Œ*ptrç­‰ä»·äºæŒ‡é’ˆptræ‰€æŒ‡å‘çš„å˜é‡ã€‚\nint x = 10;\nint* xptr = &amp;x;\nx = 5;        // å°†xçš„å€¼ç½®ä¸º5\n*xptr = 5;    // å°†xçš„å€¼ç½®ä¸º5\n\nSwap revisit\næœ‰äº†æŒ‡é’ˆï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡ä¼ é€’å˜é‡æŒ‡é’ˆçš„æ–¹å¼ï¼Œè®¾è®¡ä¸€ä¸ªå‡½æ•°æ¥è®¿é—®å¦ä¸€ä¸ªå‡½æ•°çš„å˜é‡ã€‚\nvoid swap(int* x, int* y) {\n    int temp = *x;\n    *x = *y;\n    *y = temp;\n}\n \nint main(void) {\n    int a = 3;\n    int b = 4;\n    printf(&quot;a:%d; b:%d\\n&quot;, a, b);\n    swap(&amp;a, &amp;b);\n    printf(&quot;a:%d; b:%d\\n&quot;, a, b);\n    return EXIT_SUCCESS;\n}\næŒ‡é’ˆxã€yåˆ†åˆ«æŒ‡å‘åŸå…ˆçš„aã€bï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç”¨ä»¥æŒ‡é’ˆä¸ºå‚æ•°çš„å‡½æ•°ï¼ˆswapï¼‰ä¿®æ”¹è°ƒç”¨è¯¥å‡½æ•°çš„å‡½æ•°ï¼ˆmainï¼‰ä¸­çš„å±€éƒ¨å˜é‡çš„å€¼ã€‚\n\næŒ‡é’ˆçš„ç¡¬ä»¶å·¥ä½œåŸç†\nåœ°å€å¯»å€\nè®¡ç®—æœºé€šè¿‡å°†æ•°æ®å­˜å‚¨åœ¨å†…å­˜ä¸­æ¥ç®¡ç†æ‰€æœ‰ä¿¡æ¯ã€‚ç¡¬ä»¶ä½¿ç”¨æ•°å€¼åœ°å€æ¥å”¯ä¸€æ ‡è¯†å†…å­˜ä¸­çš„æ¯ä¸ªå­˜å‚¨å•å…ƒã€‚\nç°ä»£è®¡ç®—æœºé€šå¸¸é‡‡ç”¨å­—èŠ‚å¯»å€å†…å­˜ï¼Œå³æ¯ä¸ªä¸åŒçš„åœ°å€å¯¹åº”å†…å­˜ä¸­çš„ä¸€ä¸ªå­—èŠ‚ã€‚\n\n\næ¯ä¸ªå†…å­˜å•å…ƒä»£è¡¨ä¸€ä¸ªå­—èŠ‚ã€‚\n\n\næ¯ä¸ªå­—èŠ‚éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„åœ°å€ï¼ˆ0, 1, 2, â€¦ï¼‰ã€‚\n\n\nåœ¨ 32 ä½æœºå™¨ä¸Šï¼Œåœ°å€ç”± 32 ä½äºŒè¿›åˆ¶æ•°è¡¨ç¤ºï¼Œå› æ­¤ä¸€ä¸ªæŒ‡é’ˆå˜é‡éœ€è¦ 4 ä¸ªå­—èŠ‚æ¥å­˜å‚¨åœ°å€å€¼ï¼Œè€Œä¸å®ƒæŒ‡å‘çš„æ•°æ®ç±»å‹å¤§å°æ— å…³ã€‚\nåœ¨ 64 ä½æœºå™¨ä¸Šï¼Œåœ°å€ä¸º 64 ä½ï¼Œå› æ­¤æŒ‡é’ˆå¤§å°é€šå¸¸æ˜¯ 8 ä¸ªå­—èŠ‚ã€‚\næŒ‡é’ˆçš„ç¡¬ä»¶å®ç°\né€šè¿‡ç†è§£å†…å­˜å’Œåœ°å€ï¼Œå¯ä»¥æ›´æ¸…æ¥šåœ°è®¤è¯†æŒ‡é’ˆçš„æœ¬è´¨ï¼š\næŒ‡é’ˆæœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªå˜é‡ï¼Œå®ƒå­˜å‚¨äº†å¦ä¸€ä¸ªå˜é‡çš„å†…å­˜åœ°å€ã€‚\n\n\nå¯¹äºå ç”¨ç©ºé—´è¶…è¿‡ä¸€ä¸ªå­—èŠ‚çš„å˜é‡ï¼ˆå¦‚ intã€doubleã€struct ç­‰ï¼‰ï¼Œè¯¥å˜é‡åœ¨å†…å­˜ä¸­ä¼šå æ®è¿ç»­çš„ä¸€æ®µå­—èŠ‚ã€‚\n\n\nå…¶æŒ‡é’ˆå¹¶ä¸æ˜¯è®°å½•è¿™æ®µå†…å­˜çš„å…¨éƒ¨ï¼Œè€Œæ˜¯è®°å½•è¯¥å¯¹è±¡èµ·å§‹å­—èŠ‚çš„åœ°å€ã€‚\n\n\nåªè¦çŸ¥é“èµ·å§‹åœ°å€ï¼Œå¹¶ç»“åˆç±»å‹ä¿¡æ¯ï¼ˆå‘Šè¯‰ç¼–è¯‘å™¨éœ€è¦è¯»å–å¤šå°‘å­—èŠ‚ï¼‰ï¼Œç¨‹åºå°±èƒ½æ­£ç¡®åœ°æ‰¾åˆ°å¹¶è®¿é—®å˜é‡çš„å®Œæ•´æ•°æ®ã€‚\n\n\nPSï¼š\n\næ ‡å‡†ç±»å‹ï¼ˆå¦‚ intã€floatã€doubleï¼‰ä»¥åŠæ•°ç»„åœ¨å†…å­˜ä¸­çš„å­˜å‚¨ä¸€å®šæ˜¯è¿ç»­çš„ï¼›ç»“æ„ä½“çš„æˆå‘˜å˜é‡å¯èƒ½å­˜åœ¨å¡«å……ï¼ˆpaddingï¼‰ï¼Œä½†æ•´ä½“ä¸Šä¾ç„¶æ˜¯è¿ç»­çš„ä¸€å—å†…å­˜ã€‚\nå¯¹äºé“¾è¡¨ã€æ ‘ç­‰å¤æ‚æ•°æ®ç»“æ„ï¼Œå®ƒä»¬çš„èŠ‚ç‚¹é€šå¸¸åˆ†æ•£å­˜å‚¨ï¼Œé€šè¿‡æŒ‡é’ˆç»„åˆå®ç°é€»è¾‘ä¸Šçš„å…³è”ã€‚\nå¯¹äºè¶…å¤§å¯¹è±¡ï¼ˆå¦‚å¤§æ•°ç»„ã€malloc åˆ†é…çš„å¤§å†…å­˜å—ï¼‰ï¼Œåœ¨è™šæ‹Ÿå†…å­˜ä¸­ä¾ç„¶è¡¨ç°ä¸ºè¿ç»­çš„åœ°å€åŒºé—´ï¼Œä½†åœ¨ç‰©ç†å†…å­˜ä¸­å¯èƒ½åˆ†æ•£åœ¨å¤šä¸ªé¡µé¢ä¸Šã€‚\nä¾‹å¦‚ï¼š\n\nint x = 42;    // å‡è®¾ int å  4 å­—èŠ‚\nint *p = &amp;x;   // p ä¿å­˜çš„æ˜¯ x çš„èµ·å§‹åœ°å€\nå³ä½¿ x å ç”¨ 4 ä¸ªå­—èŠ‚ï¼ŒæŒ‡é’ˆ p åªå­˜å‚¨ x æ‰€åœ¨å†…å­˜åŒºåŸŸçš„ç¬¬ä¸€ä¸ªå­—èŠ‚çš„åœ°å€ï¼Œç¼–è¯‘å™¨é€šè¿‡ int* ç±»å‹ä¿¡æ¯çŸ¥é“è¦å–è¿ç»­ 4 å­—èŠ‚æ¥è§£é‡Šä¸ºä¸€ä¸ªæ•´æ•°ã€‚\né‡è¦é™åˆ¶\næŒ‡é’ˆæ˜¯å€¼ä¸ºâ€œåœ°å€â€çš„å˜é‡ï¼Œè¿™å¸¦æ¥ä¸€ä¸ªé‡è¦é™åˆ¶ï¼š\næŒ‡é’ˆåªèƒ½æŒ‡å‘å¯å¯»å€çš„æ•°æ®å¯¹è±¡ã€‚\nè¿™æ„å‘³ç€ï¼š\n\n\nåªæœ‰å æ®å®é™…å†…å­˜ç©ºé—´çš„å¯¹è±¡ï¼ˆå˜é‡ã€æ•°ç»„ã€ç»“æ„ä½“ç­‰ï¼‰æ‰æœ‰åœ°å€ã€‚\n\n\nä¸å¯¹åº”å†…å­˜ä½ç½®çš„ä¸´æ—¶ç»“æœæˆ–å­—é¢é‡ä¸èƒ½è¢«å–åœ°å€ã€‚\n\n\nä¾‹å¦‚ï¼š\nint *ptr = &amp;3;        // âŒ é”™è¯¯ï¼šå­—é¢é‡ 3 ä¸æ˜¯å¯å¯»å€å¯¹è±¡\nint *ptr = &amp;(x + y);  // âŒ é”™è¯¯ï¼šè¡¨è¾¾å¼ (x+y) ç»“æœæ˜¯ä¸´æ—¶å€¼ï¼Œæ— å­˜å‚¨ä½ç½®\nè¿™æ˜¯å› ä¸º 3 å’Œ (x+y) éƒ½ä¸æ˜¯ å·¦å€¼ï¼ˆlvalueï¼‰ã€‚\n\n\nå·¦å€¼æŒ‡ä»£ä¸€ä¸ªå®é™…å­˜å‚¨ä½ç½®ï¼ˆâ€œå†…å­˜ä¸­çš„ç›’å­â€ï¼‰ã€‚\n\n\nä¸´æ—¶å€¼ä¸æ˜¯å­˜å‚¨å•å…ƒï¼Œå› æ­¤æ²¡æœ‰åœ°å€ã€‚\n\n\nç¼–è¯‘å™¨ä¼šæŠ¥é”™ï¼Œæé†’æˆ‘ä»¬åªèƒ½å¯¹å˜é‡å–åœ°å€ã€‚\næ¨è®ºï¼šèµ‹å€¼è¯­å¥çš„å·¦è¾¹å¿…é¡»æ˜¯ä¸€ä¸ªå·¦å€¼ï¼Œå› ä¸ºèµ‹å€¼æ“ä½œçš„æœ¬è´¨å°±æ˜¯â€œå¾€æŸä¸ªç›’å­é‡Œæ”¾æ•°æ®â€ã€‚\nå› æ­¤åƒä¸‹é¢çš„è¯­å¥ä¼šæŠ¥é”™ï¼š\n3 = 4;        // âŒ é”™è¯¯\nx + y + z = 2; // âŒ é”™è¯¯\næ ¸å¿ƒè¦ç‚¹æ€»ç»“\n\n\næŒ‡é’ˆçš„æœ¬è´¨\n\næŒ‡é’ˆä¸æ˜¯ç‹¬ç«‹ç±»å‹ï¼Œè€Œæ˜¯ç±»å‹æ„é€ å™¨ï¼Œç”¨äºåˆ›å»ºâ€œæŒ‡å‘æŸç±»å‹å¯¹è±¡â€çš„æ–°ç±»å‹ã€‚\n\n\n\nåœ°å€è¿ç®—ç¬¦ &amp;\n\nå–å‡ºå˜é‡çš„å†…å­˜åœ°å€ï¼ˆå¿…é¡»æ˜¯å·¦å€¼ï¼‰ã€‚\n\n\n\nè§£å¼•ç”¨è¿ç®—ç¬¦ *\n\næ ¹æ®æŒ‡é’ˆå­˜å‚¨çš„åœ°å€è®¿é—®å¯¹åº”å†…å­˜ä¸­çš„å€¼ã€‚\n\n\n\nå†…å­˜å¯»å€\n\næ¯ä¸ªå†…å­˜ä½ç½®éƒ½æœ‰å”¯ä¸€åœ°å€ã€‚æŒ‡é’ˆå­˜å‚¨çš„æ˜¯åœ°å€ï¼Œè€Œä¸æ˜¯å¯¹è±¡çš„å€¼ã€‚\n\n\n\nç±»å‹ä¿¡æ¯çš„é‡è¦æ€§\n\næŒ‡é’ˆåªå­˜å‚¨èµ·å§‹åœ°å€ï¼Œç¼–è¯‘å™¨ä¾é æŒ‡é’ˆçš„ç±»å‹æ¥ç¡®å®šè®¿é—®å¤šå°‘å­—èŠ‚ã€‚\n\n\n\né™åˆ¶æ¡ä»¶\n\næŒ‡é’ˆåªèƒ½æŒ‡å‘å¯å¯»å€çš„å¯¹è±¡ï¼Œä¸èƒ½æŒ‡å‘å¸¸é‡æˆ–ä¸´æ—¶è®¡ç®—ç»“æœã€‚\n\n\n\nèµ‹å€¼è§„åˆ™\n\nèµ‹å€¼æ“ä½œçš„å·¦è¾¹å¿…é¡»æ˜¯å·¦å€¼ï¼ˆå®é™…å†…å­˜å•å…ƒï¼‰ã€‚\n\n\n\nPointer to strut\nWhen we have pointers to structs, we can just use the * and . operators that we have seen so far, however, the order of operations means that . happens first. If we write *a.b, it means (a.b)â€”a should be a struct, which we look inside to find a field named b (which should be a pointer), and we dereference that pointer. If we have a pointer to a struct (c, and we want to refer to the field d in the struct at the end of the arrow, we would need parenthesis, and write (c).d (or the â†’ operator we will learn about momentarily).\nIn the figure above, we have a struct which has a field p (which is a pointer to an int), and a field x which is an int. We then declare y (an int), a (a struct), and q (a pointer to a struct), and initialize them. When we write *a.p, the order of operations is to evaluate a.p (which is an arrow pointing at y), then dereference that arrow. If we wrote *q.x, we would receive a compiler error, as q is not a struct, and the order of operations would say to do q.x first (which is not possible, since q is not a struct). We could write parenthesis, as in the figure ((*q).x).\nHowever, pointers to structs are incredibly common, and the above syntax gets quite cumbersome, especially with pointers to structs which have pointers to structs, and so on. For (*q).x, it may not be so bad, but if we have (((*q).r).s).t it becomes incredibly ugly, and confusing. Instead, we should use the â†’ operator, which is shorthand for dereferencing a pointer to a struct and selecting a fieldâ€”that is, we could write qâ†’x (which means exactly the same thing as (*q).x). For our more complex example, we could instead write qâ†’râ†’sâ†’t (which is easier to read and modify).\nAliasing\nconst\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nç±»å‹Can we change **pCan we change *pCan we change pè§£è¯»int ** pYesYesYesä¸‰å±‚éƒ½é constï¼›å¯ä»¥æ”¹åº•å±‚ intã€ä¸­é—´æŒ‡é’ˆçš„æŒ‡å‘ã€ä»¥åŠæœ€å¤–å±‚æŒ‡é’ˆå˜é‡æœ¬èº«ã€‚const int ** pNoYesYesæœ€é‡Œå±‚æ˜¯ const intï¼Œä¸èƒ½æ”¹æ•°æ®ï¼›ä¸¤å±‚æŒ‡é’ˆæœ¬èº«éƒ½å¯æ”¹åŠ¨å…¶æŒ‡å‘ã€‚int * const * pYesNoYesä¸­é—´å±‚æ˜¯â€œconst æŒ‡é’ˆæŒ‡å‘ intâ€ï¼šä¸èƒ½ç»™ *p èµ‹æ–°åœ°å€ï¼›ä½†åº•å±‚ int å¯æ”¹ã€å¤–å±‚ p å¯æ”¹ã€‚int ** const pYesYesNoæœ€å¤–å±‚æ˜¯â€œconst æŒ‡é’ˆâ€ï¼šp ä¸èƒ½æ”¹ï¼›ä½†å¯æ”¹ä¸­é—´å±‚æŒ‡å‘ä¸åº•å±‚ intã€‚const int * const * pNoNoYesä¸­é—´å±‚æ˜¯â€œconst æŒ‡é’ˆæŒ‡å‘ const intâ€ï¼šæ—¢ä¸èƒ½æ”¹åº•å±‚æ•°æ®ï¼Œä¹Ÿä¸èƒ½ç»™ *p æ¢åœ°å€ï¼›ä»…èƒ½æ”¹å¤–å±‚ p æœ¬èº«ã€‚const int ** const pNoYesNoæœ€å¤–å±‚æ˜¯ constï¼ˆä¸èƒ½æ”¹ pï¼‰ï¼›åº•å±‚æ•°æ®æ˜¯ const intï¼ˆä¸èƒ½æ”¹ **pï¼‰ï¼›ä½†èƒ½è®©ä¸­é—´å±‚ *p æŒ‡å‘åˆ«å¤„ã€‚int * const * const pYesNoNoä¸¤å±‚æŒ‡é’ˆéƒ½æ˜¯ constï¼ˆ*p ä¸ p éƒ½ä¸èƒ½æ”¹ï¼‰ï¼›ä½†ä¸­é—´å±‚æŒ‡å‘çš„æ˜¯éå¸¸é‡ intï¼Œå› æ­¤å¯æ”¹åº•å±‚æ•°æ®ã€‚const int * const * const pNoNoNoä¸‰å±‚éƒ½è¢«â€œè¯»å†™èƒ½åŠ›â€é”æ­»ï¼šåº•å±‚æ•°æ®æ˜¯ constï¼Œä¸¤å±‚æŒ‡é’ˆä¹Ÿéƒ½æ˜¯ constã€‚\næ´‹è‘±æ³•\npsï¼š constç›¸å½“äºä¸€ä¸ªå½¢å®¹è¯ï¼Œint float double  * ç­‰ç­‰ç›¸å½“äºåè¯ï¼Œconstå¯¹â€œåè¯â€çš„ä¿®é¥°å¯ä»¥æ”¾åœ¨â€œåè¯ä¹‹å‰æˆ–åè¯ä¹‹å\negï¼š\nconst int å’Œ int constå®Œå…¨ç­‰ä»·\nè§£è¯»è¿™ç±»å¤æ‚å£°æ˜æ—¶ï¼Œåº”å…ˆæ‰¾åˆ°å˜é‡åï¼Œç„¶åæŒ‰ç…§è‹±è¯­çš„é¡ºåº,ä»¥â€œåè¯â€ä¸ºä¸€å±‚ï¼Œä¸€å±‚ä¸€å±‚å‘å¤–è§£è¯»ã€‚constå½¢å®¹è¯ä¼˜å…ˆå’Œå³ä¾§(å†…å±‚)çš„åè¯ç»“åˆã€‚\neg:\nconst int * const * const p\n\né¦–å…ˆæ‰¾åˆ°å˜é‡åp\nå‘å¤–è¯»ï¼š\n\n* const pï¼šp is a const pointer to\n* const :  a const pointer to\nint const : a const int\n\n\nå’Œèµ·æ¥ï¼šp is a const pointer to a const pointer to a const int\nç¿»è¯‘è¿‡æ¥ï¼š\n\npæ˜¯ä¸€ä¸ªæŒ‡å‘ï¼ˆæŒ‡å‘å¸¸é‡æ•´å‹çš„å¸¸é‡æŒ‡é’ˆï¼‰çš„ï¼ˆå¸¸é‡æŒ‡é’ˆï¼‰\np æ˜¯ä¸€ä¸ª å¸¸é‡æŒ‡é’ˆï¼Œå®ƒæŒ‡å‘ä¸€ä¸ª å¸¸é‡æŒ‡é’ˆï¼Œè€Œè¿™ä¸ªå¸¸é‡æŒ‡é’ˆåˆæŒ‡å‘ä¸€ä¸ª å¸¸é‡æ•´å‹\n\n\n\næŒ‡é’ˆè¿ç®— (Pointer Arithmetic)\nåœ¨ C è¯­è¨€ä¸­ï¼ŒæŒ‡é’ˆå¸¦æœ‰ç±»å‹ä¿¡æ¯ã€‚å½“ä½ åš p + nã€p - n æˆ–ä¸¤ä¸ªåŒç±»å‹æŒ‡é’ˆç›¸å‡æ—¶ï¼Œç¼–è¯‘å™¨ä¼šæŒ‰â€œå…ƒç´ â€ä¸ºå•ä½è€Œä¸æ˜¯â€œå­—èŠ‚â€ä¸ºå•ä½è®¡ç®—ä½ç§»ã€‚\næ ¸å¿ƒå…¬å¼ï¼ˆæ¦‚å¿µä¸Šï¼‰ï¼š\np + n == (char*)p + n * sizeof(*p)\nä¹Ÿå°±æ˜¯è¯´ï¼Œæ­¥é•¿ç”±â€œæŒ‡é’ˆæ‰€æŒ‡å‘çš„ç±»å‹â€çš„å¤§å°å†³å®šã€‚\nå¸¸è§æ­¥é•¿ä¸¾ä¾‹\n\n\nint*ï¼šp + 1 å‰è¿› sizeof(int) å­—èŠ‚ï¼ˆå¸¸è§ä¸º 4ï¼‰\n\n\nfloat*ï¼šq + 1 å‰è¿› sizeof(float) å­—èŠ‚ï¼ˆå¸¸è§ä¸º 4ï¼‰\n\n\ndouble*ï¼šr + 1 å‰è¿› sizeof(double) å­—èŠ‚ï¼ˆå¸¸è§ä¸º 8ï¼‰\n\n\nchar*ï¼šc + 1 å‰è¿› 1 å­—èŠ‚ï¼ˆé€å­—èŠ‚ç§»åŠ¨ï¼Œå¸¸ç”¨äºäºŒè¿›åˆ¶/å†…å­˜æ“ä½œï¼‰\n\n\nå°ç¤ºä¾‹ï¼ˆåœ°å€å˜åŒ–å¯¹æ¯”ï¼‰\n#include &lt;stdio.h&gt;\n \nint main(void) {\n    int    xi = 42;     int*    pi = &amp;xi;\n    float  xf = 3.14f;  float*  pf = &amp;xf;\n    double xd = 6.28;   double* pd = &amp;xd;\n \n    printf(&quot;pi    = %p, pi+1    = %p\\n&quot;, (void*)pi, (void*)(pi+1));\n    printf(&quot;pf    = %p, pf+1    = %p\\n&quot;, (void*)pf, (void*)(pf+1));\n    printf(&quot;pd    = %p, pd+1    = %p\\n&quot;, (void*)pd, (void*)(pd+1));\n \n    // é€å­—èŠ‚è§‚å¯Ÿ\n    char* pc = (char*)&amp;xi;\n    printf(&quot;pc    = %p, pc+1    = %p\\n&quot;, (void*)pc, (void*)(pc+1));\n    return 0;\n}\nå…·ä½“æ•°å€¼å¯èƒ½å› å¹³å°ä¸åŒè€Œå˜åŒ–\né‡è¦è§„åˆ™ &amp; æ˜“é”™ç‚¹\n\n\næ•°ç»„è¾¹ç•Œè§„åˆ™\næŒ‡é’ˆè¿ç®—åªåœ¨åŒä¸€æ•°ç»„å¯¹è±¡å†…æœ‰å®šä¹‰ï¼ˆå«â€œå°¾åä½ç½®â€one-past-the-endï¼‰ã€‚\n\n\nä½ å¯ä»¥æŠŠ p ç§»åŠ¨åˆ° arr + nï¼ˆn ä¸ºæ•°ç»„é•¿åº¦ï¼‰çš„â€œå°¾åâ€ä½ç½®ï¼Œä½†ä¸èƒ½è§£å¼•ç”¨é‚£ä¸ªä½ç½®ã€‚\n\n\nè¶…å‡ºè¿™ä¸ªèŒƒå›´çš„è®¡ç®—æˆ–ä»»ä½•è¶Šç•Œè§£å¼•ç”¨éƒ½æ˜¯æœªå®šä¹‰è¡Œä¸ºï¼ˆUBï¼‰ã€‚\n\n\nå¯¹äºå•ä¸ªå˜é‡ int x; int* p = &amp;x; p+1 åªæ˜¯â€œç®—å‡ºä¸€ä¸ªåœ°å€â€ï¼Œå¯¹å…¶è§£å¼•ç”¨æ˜¯ UBã€‚\n\n\n\n\nvoid* ä¸èƒ½åšç®—æœ¯ï¼ˆæ ‡å‡† Cï¼‰\næ ‡å‡† C ä¸å…è®¸å¯¹ void* åšåŠ å‡ï¼ˆæŸäº›ç¼–è¯‘å™¨ä½œä¸ºæ‰©å±•æ”¯æŒï¼‰ã€‚å¦‚éœ€æŒ‰å­—èŠ‚ç§»åŠ¨ï¼Œå…ˆè½¬æˆ char* å†è¿ç®—ï¼š\nchar* pc = (char*)p; pc += n;\n\n\næŒ‡é’ˆå¯¹é½ï¼ˆalignmentï¼‰\næŠŠä¸åŒç±»å‹æŒ‡é’ˆâ€œç¡¬è½¬æ¢â€å¹¶è§£å¼•ç”¨ï¼Œå¯èƒ½è§¦å‘æœªå¯¹é½è®¿é—®ï¼ˆæŸäº›æ¶æ„ä¼šå´©æºƒ/é™é€Ÿï¼‰ã€‚å°½é‡éµå®ˆåŸå§‹ç±»å‹çš„å¯¹é½è¦æ±‚ã€‚\n\n\næŒ‡é’ˆç›¸å‡\nä»…å½“ä¸¤ä¸ªæŒ‡é’ˆæŒ‡å‘åŒä¸€æ•°ç»„çš„å…ƒç´ ï¼ˆæˆ–å…¶å°¾åä½ç½®ï¼‰æ—¶ï¼Œp2 - p1 æ‰æœ‰å®šä¹‰ï¼Œç»“æœç±»å‹æ˜¯ ptrdiff_tï¼Œè¡¨ç¤ºå…ƒç´ ä¸ªæ•°çš„å·®ï¼Œè€Œéå­—èŠ‚å·®ã€‚\n\n\né€Ÿè®°æ€»ç»“\n\n\næ­¥é•¿ = sizeof(*p)ï¼Œä¸æ˜¯ 1 å­—èŠ‚ï¼ˆé™¤ char*ï¼‰ã€‚\n\n\nåªåœ¨åŒä¸€æ•°ç»„å†…åšè¿ç®—å¹¶è°¨æ…è§£å¼•ç”¨å°¾åä½ç½®ï¼ˆä¸å¯è§£å¼•ç”¨ï¼‰ã€‚\n\n\né€å­—èŠ‚ç§»åŠ¨è¯·ç”¨ char*ã€‚\n\n\né¿å…æœªå¯¹é½ä¸è¶Šç•Œï¼Œp2 - p1 è¿”å›å…ƒç´ å·®è€Œéå­—èŠ‚å·®ã€‚\n\n"},"index":{"slug":"index","filePath":"index.md","title":"é¦–é¡µ","links":[],"tags":[],"content":"æ¬¢è¿æ¥åˆ°æˆ‘çš„ Quartz\nè¿™æ˜¯æˆ‘çš„æ•°å­—èŠ±å›­é¦–é¡µã€‚ä½ å¯ä»¥ä»å·¦è¾¹çš„ç›®å½•æˆ–æœç´¢æ¡†è¿›å…¥ç¬”è®°ã€‚"},"åˆ†å¸ƒå¼/hadoop/HDFS/HDFSä½“ç³»ç»“æ„":{"slug":"åˆ†å¸ƒå¼/hadoop/HDFS/HDFSä½“ç³»ç»“æ„","filePath":"åˆ†å¸ƒå¼/hadoop/HDFS/HDFSä½“ç³»ç»“æ„.md","title":"HDFSä½“ç³»ç»“æ„","links":[],"tags":[],"content":"å‘½åç©ºé—´ç®¡ç†\n\n\nHDFSçš„å‘½åç©ºé—´åŒ…å«ç›®å½•ã€æ–‡ä»¶å’Œå—\n\n\nåœ¨HDFS1.0ä½“ç³»ç»“æ„ä¸­ï¼Œåœ¨æ•´ä¸ªHDFSé›†ç¾¤ä¸­åªæœ‰ä¸€ä¸ªå‘½åç©ºé—´ï¼Œå¹¶ä¸”åªæœ‰å”¯ä¸€ä¸€ä¸ªåç§°èŠ‚ç‚¹ï¼Œè¯¥èŠ‚ç‚¹è´Ÿè´£å¯¹è¿™ä¸ªå‘½åç©ºé—´è¿›è¡Œç®¡ç†\n\n\nHDFSä½¿ç”¨çš„æ˜¯ä¼ ç»Ÿçš„åˆ†çº§æ–‡ä»¶ä½“ç³»ï¼Œå› æ­¤ï¼Œç”¨æˆ·å¯ä»¥åƒä½¿ç”¨æ™®é€šæ–‡ä»¶ç³»ç»Ÿä¸€æ ·ï¼Œåˆ›å»ºã€åˆ é™¤ç›®å½•å’Œæ–‡ä»¶ï¼Œåœ¨ç›®å½•é—´è½¬ç§»æ–‡ä»¶ï¼Œé‡å‘½åæ–‡ä»¶ç­‰\n\n\né€šä¿¡åè®®\nClient â†” NameNode\nåè®®\n\n\nHadoop RPCï¼ˆorg.apache.hadoop.ipc æä¾›ï¼‰\n\n\nNameNode å®ç°äº† ClientProtocol æ¥å£ï¼ˆJavaï¼‰ï¼Œå®¢æˆ·ç«¯é€šè¿‡ RPC Stub è°ƒç”¨ NameNode æ–¹æ³•ã€‚\n\n\nå…¸å‹è°ƒç”¨\n\n\ncreate()ï¼šè¯·æ±‚æ–°å»ºæ–‡ä»¶\n\n\naddBlock()ï¼šç”³è¯·æ–°çš„ block å¹¶è¿”å› DataNode åˆ—è¡¨\n\n\ngetBlockLocations()ï¼šæŸ¥è¯¢æŸä¸ªæ–‡ä»¶çš„ block åˆ†å¸ƒ\n\n\ncomplete()ï¼šå…³é—­æ–‡ä»¶ï¼Œæ ‡è®°å®Œæˆ\n\n\nç‰¹ç‚¹\n\n\nåŸºäº TCP\n\n\né»˜è®¤ç”¨ protobuf åºåˆ—åŒ–\n\n\nç«¯å£ï¼šåœ¨core-site.xml ä¸­ä½¿ç”¨ fs.defaultFS=hdfs://namenode:9000è¿›è¡Œé…ç½®ï¼Œé»˜è®¤æ˜¯9000\n\n\nClient â†” DataNode\nåè®®\n\n\nDataTransferProtocol\n\n\nä¸“é—¨ç”¨äºæ•°æ®è¯»å†™ï¼Œèµ° TCPï¼ˆé»˜è®¤ç«¯å£ 50010ï¼Œåœ¨ docker ç¯å¢ƒé‡Œå¯èƒ½æ˜ å°„åˆ°å¤–éƒ¨çš„ 9866/9864ï¼‰ã€‚\n\n\nå…¸å‹åœºæ™¯\n\n\nè¯»æµç¨‹\n\n\nå®¢æˆ·ç«¯è¯·æ±‚ä¸€ä¸ª blockï¼ˆblock ID + token + åç§»ï¼‰ã€‚\n\n\nDataNode è¿”å›æ•°æ®æµï¼Œé‡‡ç”¨ packet-based streamingï¼š\n\n\næ¯ä¸ª packet åŒ…å«è‹¥å¹²ä¸ª chunk + æ ¡éªŒå’Œã€‚\n\n\nå®¢æˆ·ç«¯æ ¡éªŒåç¡®è®¤ã€‚\n\n\n\n\n\n\nå†™æµç¨‹\n\n\nå®¢æˆ·ç«¯å…ˆè”ç³» pipeline ç¬¬ä¸€ä¸ª DNï¼Œå‘é€å†™ block è¯·æ±‚ã€‚\n\n\nDN1 æ¥æ”¶åå†™æœ¬åœ°ï¼ŒåŒæ—¶è½¬å‘ç»™ DN2ï¼›DN2 å†è½¬å‘ç»™ DN3 â€¦\n\n\næœ€å ACK æŒ‰é“¾è·¯é€†åºè¿”å› â†’ å®¢æˆ·ç«¯ã€‚\n\n\n\n\nç‰¹ç‚¹\n\n\né«˜ååæµå¼ä¼ è¾“\n\n\nä½¿ç”¨ æ ¡éªŒå’Œ (CRC32) ç¡®ä¿æ•°æ®å®Œæ•´æ€§ã€‚\n\n\nDataNode â†” NameNode\nè¿™éƒ¨åˆ†ä¸æ¶‰åŠæ–‡ä»¶æ•°æ®ï¼Œè€Œæ˜¯ å¿ƒè·³ä¸å…ƒæ•°æ®æ±‡æŠ¥ã€‚\nåè®®\n\n\nHadoop RPCï¼ˆResourceManager ä¹Ÿç”¨è¿™ä¸€å¥—ï¼‰\n\n\nDataNode å‘ NameNode æä¾› DatanodeProtocol æ¥å£ã€‚\n\n\nå…¸å‹é€šä¿¡\n\n\nå¿ƒè·³ï¼ˆHeartbeatï¼‰ï¼šé»˜è®¤ 3sï¼Œæ±‡æŠ¥ DataNode çŠ¶æ€ï¼ˆç£ç›˜ä½¿ç”¨é‡ã€è´Ÿè½½ç­‰ï¼‰ã€‚\n\n\nBlock Reportï¼šé»˜è®¤ 1 å°æ—¶ä¸€æ¬¡ï¼Œæ±‡æŠ¥è‡ªå·±æŒæœ‰çš„æ‰€æœ‰ block åˆ—è¡¨ã€‚\n\n\nIncremental Block Reportï¼šå¢é‡æ±‡æŠ¥æ–°å¢æˆ–åˆ é™¤çš„ blockã€‚\n\n\nå‘½ä»¤ä¸‹å‘ï¼šNameNode ä¹Ÿä¼šé€šè¿‡å¿ƒè·³å“åº”ä¸‹å‘å‘½ä»¤ï¼ˆå¦‚å¤åˆ¶ã€åˆ é™¤ blockï¼‰ã€‚\n\n\nDataNode â†” DataNode\nåè®®\nDataNode â†” DataNode ä¹‹é—´ä½¿ç”¨çš„åè®® å¹¶ä¸æ˜¯æ–°çš„åè®®ï¼Œè€Œæ˜¯å’Œ Client â†” DataNode ä¸€æ ·çš„ï¼š\n\n\nDataTransferProtocol\n\n\nåŸºäº TCP\n\n\nç”¨äºæ•°æ®çš„è¯»å†™ã€å¤åˆ¶ã€è½¬å‘\n\n\nå†…éƒ¨æ˜¯ packet + checksum çš„æµå¼æ ¼å¼\n\n\n\n\nä¹Ÿå°±æ˜¯è¯´ï¼š\n\n\nClient â†’ DN1 â†’ DN2 â†’ DN3 çš„ æµæ°´çº¿å†™å…¥ï¼Œç”¨çš„å°±æ˜¯ DataTransferProtocolã€‚\n\n\nDN_A â†’ DN_B çš„ å‰¯æœ¬å¤åˆ¶ï¼Œä¹Ÿæ˜¯ç”¨ DataTransferProtocolï¼Œåªä¸è¿‡æ˜¯ç”± DataNode å‘èµ·ï¼Œè€Œä¸æ˜¯å®¢æˆ·ç«¯ã€‚\n\n\nå…¸å‹åœºæ™¯\n\n\nå†™å…¥å‰¯æœ¬ï¼ˆreplication pipelineï¼‰\n\n\nå½“å®¢æˆ·ç«¯å†™æ–‡ä»¶æ—¶ï¼ŒNameNode åˆ†é…å‰¯æœ¬é“¾ï¼ˆDN1 â†’ DN2 â†’ DN3ï¼‰ã€‚\n\n\nå®¢æˆ·ç«¯åªæŠŠæ•°æ®æ¨ç»™ç¬¬ä¸€ä¸ª DataNodeï¼ˆDN1ï¼‰ã€‚\n\n\nDN1 ä¼š è½¬å‘æ•°æ® ç»™ DN2ï¼ŒDN2 å†è½¬å‘ç»™ DN3ã€‚\n\n\nè¿™å°±æ˜¯ pipeline å†™å…¥ï¼Œå®è´¨ä¸Šæ˜¯ DataNode ä¹‹é—´çš„æ•°æ®è½¬å‘ã€‚\n\n\n\n\nå‰¯æœ¬æ¢å¤ / å†—ä½™å¤åˆ¶\n\n\nNameNode å‘ç°æŸä¸ª block çš„å‰¯æœ¬ä¸¢å¤±æˆ–ä¸è¶³ï¼ˆä¾‹å¦‚æŸä¸ª DataNode å®•æœºï¼‰ã€‚\n\n\nå®ƒä¼šé€šè¿‡ å¿ƒè·³å‘½ä»¤æŒ‡ç¤ºæŸä¸ª DataNode å»â€œå¤åˆ¶ block åˆ°å¦ä¸€ä¸ª DataNodeâ€ã€‚\n\n\næ­¤æ—¶ï¼Œæº DataNode ä¼šæŠŠæœ¬åœ°çš„ block é€šè¿‡æ•°æ®ä¼ è¾“åè®®å‘ç»™ç›®æ ‡ DataNodeã€‚\n\n\n\n\n\næ€»ç»“è¡¨\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\né€šä¿¡å¯¹ç«¯åè®®/æ¥å£ç”¨é€”Client â†” NameNodeHadoop RPC / ClientProtocolå…ƒæ•°æ®æ“ä½œï¼šæ–‡ä»¶åˆ›å»ºã€æŸ¥è¯¢ã€å…³é—­Client â†” DataNodeDataTransferProtocolæ•°æ®æµä¼ è¾“ï¼ˆè¯»å†™ blockï¼‰DataNode â†” NameNodeHadoop RPC / DatanodeProtocolå¿ƒè·³ã€block æŠ¥å‘Šã€å‘½ä»¤ä¸‹å‘DataNode â†” DataNodeDataTransferProtocolå‰¯æœ¬å¤åˆ¶ã€å†™å…¥æµæ°´çº¿è½¬å‘ï¼ˆreplication pipelineï¼‰\nè¡¥å……\n\n\nHadoop RPC æœ¬è´¨ä¸Šæ˜¯ TCP + Protobuf + åŠ¨æ€ä»£ç†ï¼Œæœ‰ç‚¹åƒè½»é‡çº§çš„ gRPCã€‚\n\n\nDataTransferProtocol æ˜¯ é¢å‘æµçš„ç§æœ‰åè®®ï¼Œä¸æ˜¯ RPCï¼Œè€Œæ˜¯å›ºå®šæ ¼å¼çš„äºŒè¿›åˆ¶æ•°æ®åŒ…ã€‚\n\n\nå®¢æˆ·ç«¯ä¸€èˆ¬åªè·Ÿ NameNode RPC å’Œ DataNode DataTransfer æ‰“äº¤é“ï¼›\nDataNode å’Œ NameNode åˆ™é å¿ƒè·³ RPC ä¿æŒä¸€è‡´æ€§ã€‚\n\n\nHDFSä½“ç³»ç»“æ„çš„å±€é™æ€§\n\nHDFSçš„è®¾è®¡ç†å¿µæ˜¯â€œä¸€æ¬¡å†™å…¥ï¼Œå¤šæ¬¡è¯»å–â€ï¼Œæœ¬èº«ä¸æ”¯æŒæ–‡ä»¶çš„éšæœºå†™å…¥ï¼Œå¦‚æœè¦è¿›è¡Œä¿®æ”¹ï¼Œåªèƒ½å°†æ•´ä¸ªæ–‡ä»¶è¯»å–åˆ°å®¢æˆ·ç«¯å®Œæˆä¿®æ”¹åå†æ•´ä¸ªå†™å›HDFS\nå‘½åç©ºé—´çš„é™åˆ¶ï¼šå‘½åç©ºé—´ä¿å­˜åœ¨åç§°èŠ‚ç‚¹ï¼Œç³»ç»Ÿçš„æ€»å®¹çº³é‡å—åˆ°åç§°èŠ‚ç‚¹å†…å­˜çš„é™åˆ¶\næ€§èƒ½ç“¶é¢ˆï¼šæ•´ä¸ªåˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿåªæœ‰ä¸€ä¸ªåç§°èŠ‚ç‚¹ï¼Œååé‡å—é™äºåç§°èŠ‚ç‚¹çš„å¤„ç†èƒ½åŠ›\néš”ç¦»é—®é¢˜ï¼šåªæœ‰ä¸€ä¸ªåç§°èŠ‚ç‚¹ï¼Œæ— æ³•å¯¹ä¸åŒçš„åº”ç”¨ç¨‹åºè¿›è¡Œéš”ç¦»\né›†ç¾¤å¯ç”¨æ€§ï¼šä¸€æ—¦åç§°èŠ‚ç‚¹æŸåï¼Œé›†ç¾¤ä¼šå˜å¾—ä¸å¯ç”¨\n"},"åˆ†å¸ƒå¼/hadoop/HDFS/HDFSæ¦‚è¿°":{"slug":"åˆ†å¸ƒå¼/hadoop/HDFS/HDFSæ¦‚è¿°","filePath":"åˆ†å¸ƒå¼/hadoop/HDFS/HDFSæ¦‚è¿°.md","title":"HDFSæ¦‚è¿°","links":[],"tags":[],"content":"æ–‡ä»¶ç³»ç»ŸåŸºæœ¬å¸¸è¯†\nåœ¨æ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œæ‰€æœ‰çš„ç£ç›˜å†…å®¹ä¼šä»¥æ–‡ä»¶å’Œç›®å½•çš„å½¢å¼å‘ˆç°ç»™ç”¨æˆ·ã€‚ä¸åŒçš„æ–‡ä»¶ç³»ç»Ÿï¼ˆå¦‚ NTFSã€ext4ã€FAT32ï¼‰æœ‰å„è‡ªç‹¬ç‰¹çš„å‘½åç©ºé—´ï¼Œå³æ–‡ä»¶è·¯å¾„çš„ç»„ç»‡ç»“æ„ã€‚\nç‰©ç†ç£ç›˜ç»“æ„\nåœ¨ç£ç›˜çš„ç‰©ç†å±‚é¢ï¼Œç£ç›˜è¢«åˆ†ä¸ºæ‰‡åŒºï¼ˆSectorï¼‰ã€‚æ¯ä¸ªæ‰‡åŒºçš„å¤§å°é€šå¸¸ä¸º512å­—èŠ‚æˆ–4KBã€‚å¤šä¸ªæ‰‡åŒºç»„æˆç°‡ï¼ˆClusterï¼Œæˆ–ç§°å—Blockï¼‰ï¼Œä¸€ä¸ªç°‡æ˜¯æ–‡ä»¶ç³»ç»Ÿåœ¨å­˜å‚¨æ•°æ®æ—¶çš„åŸºæœ¬å•ä½ï¼Œé€šå¸¸ä¸€ä¸ªç°‡çš„å¤§å°æ˜¯4KBã€8KBæˆ–æ›´å¤§ã€‚æ–‡ä»¶ç³»ç»Ÿå°†æ–‡ä»¶æ•°æ®æŒ‰ç°‡æ¥å­˜å‚¨ï¼Œç°‡çš„å¤§å°ä¼šå½±å“ç£ç›˜ç©ºé—´çš„åˆ©ç”¨ç‡ã€‚\næ–‡ä»¶çš„æ•°æ®å’Œå…ƒæ•°æ®\n\næ–‡ä»¶æ•°æ®ï¼šæ˜¯æŒ‡æ–‡ä»¶çš„å®é™…å†…å®¹ï¼Œå­˜å‚¨åœ¨ç£ç›˜ä¸Šç”¨äºä¿å­˜ç”¨æˆ·ä¿¡æ¯çš„éƒ¨åˆ†ã€‚\næ–‡ä»¶å…ƒæ•°æ®ï¼šåŒ…å«æ–‡ä»¶çš„å±æ€§ä¿¡æ¯ï¼Œå¦‚ï¼š\n\næ–‡ä»¶çš„æ—¶é—´æˆ³ï¼šè®°å½•æ–‡ä»¶çš„åˆ›å»ºæ—¶é—´ã€ä¿®æ”¹æ—¶é—´å’Œæœ€åè®¿é—®æ—¶é—´ã€‚\næ–‡ä»¶çš„æ‰€æœ‰è€…ï¼šè¡¨ç¤ºæ–‡ä»¶çš„æ‹¥æœ‰è€…ï¼Œé€šå¸¸ä¸æ–‡ä»¶çš„æƒé™ç³»ç»Ÿç›¸å…³ã€‚\næ–‡ä»¶çš„æƒé™ï¼šæè¿°è°å¯ä»¥è¯»å–ã€å†™å…¥æˆ–æ‰§è¡Œæ–‡ä»¶ã€‚\næ–‡ä»¶çš„ç‰©ç†ä½ç½®ï¼šæ–‡ä»¶åœ¨ç£ç›˜ä¸Šçš„å­˜å‚¨ä½ç½®ï¼ŒæŒ‡ç¤ºæ–‡ä»¶æ•°æ®å­˜å‚¨åœ¨å“ªäº›ç°‡ä¸­ã€‚æ–‡ä»¶ç³»ç»Ÿä¼šæ ¹æ®è¿™äº›ä¿¡æ¯ç®¡ç†æ–‡ä»¶çš„è¯»å†™æ“ä½œã€‚\n\n\n\næ­¤å¤–ï¼Œæ–‡ä»¶å…ƒæ•°æ®é€šå¸¸è¿˜åŒ…æ‹¬æ–‡ä»¶åã€å¤§å°ã€æ–‡ä»¶ç±»å‹ç­‰ä¿¡æ¯ã€‚æ–‡ä»¶ç³»ç»Ÿåˆ©ç”¨è¿™äº›å…ƒæ•°æ®æ¥ç®¡ç†æ–‡ä»¶çš„å­˜å–ã€åˆ é™¤å’Œæƒé™æ§åˆ¶ã€‚\nå…¶ä»–è¡¥å……ï¼š\n\nç›®å½•ç»“æ„ï¼šæ–‡ä»¶ç³»ç»Ÿé€šè¿‡ç›®å½•æ¥ç»„ç»‡æ–‡ä»¶ï¼Œè¿™äº›ç›®å½•å½¢æˆä¸€ä¸ªå±‚çº§ç»“æ„ï¼Œç±»ä¼¼æ ‘çŠ¶ç»“æ„ï¼Œå¸®åŠ©ç”¨æˆ·å’Œç¨‹åºæ›´æ–¹ä¾¿åœ°å­˜å–æ–‡ä»¶ã€‚\nç£ç›˜ç®¡ç†ï¼šæ–‡ä»¶ç³»ç»Ÿè¿˜ä¼šç®¡ç†ç£ç›˜çš„ç©ºé—´ä½¿ç”¨æƒ…å†µï¼Œå¦‚ç©ºé—²ç©ºé—´ç®¡ç†ã€æ–‡ä»¶åˆ†é…è¡¨ï¼ˆå¦‚FATè¡¨ï¼‰æˆ–inodeç»“æ„ï¼ˆå¦‚åœ¨Unixç±»æ–‡ä»¶ç³»ç»Ÿä¸­ä½¿ç”¨ï¼‰ã€‚\n\nåˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿ\nèŠ‚ç‚¹åˆ†ä¸ºä¸¤ç±»ï¼šåç§°èŠ‚ç‚¹ï¼ˆnamenodeï¼‰å’Œæ•°æ®èŠ‚ç‚¹ï¼ˆdatanodeï¼‰ã€‚\nåç§°èŠ‚ç‚¹è´Ÿè´£å­˜å‚¨å…ƒæ•°æ®ï¼Œæ•°æ®èŠ‚ç‚¹è´Ÿè´£å­˜å‚¨å—æ•°æ®ã€‚\nHDFSçš„ç‰¹æ€§ï¼š\n\nä¼˜ç‚¹\n\næµæ•°æ®è¯»å†™\nå¤§å‹æ•°æ®è¯»å†™ï¼ˆtb pbçº§åˆ«ï¼‰\nä¸€æ¬¡å†™å…¥ï¼Œå¤šæ¬¡è¯»å–\n\n\nç¼ºç‚¹\n\nä¸æ”¯æŒéšæœºå†™å…¥\n\n\n\nå—ï¼ˆBlockï¼‰\nHDFSé»˜è®¤ä¸€ä¸ªå—128mb,HDFSå—çš„å¤§å°è¿œè¿œå¤§äºæ™®é€šæ–‡ä»¶ç³»ç»Ÿï¼Œå¯ä»¥æœ€å°åŒ–å¯»å€å¼€é”€ã€‚\n\næ”¯æŒå¤§è§„æ¨¡æ–‡ä»¶è¯»å†™ï¼Œæ–‡ä»¶åˆ†å—å­˜å‚¨åˆ°ä¸åŒçš„èŠ‚ç‚¹ï¼Œæ‰€ä»¥ç³»ç»Ÿå¯ä»¥å­˜å‚¨å¤§äºä»»ä¸€èŠ‚ç‚¹å®¹é‡çš„æ–‡ä»¶ã€‚\nç®€åŒ–ç³»ç»Ÿè®¾è®¡ï¼Œç”±äºå—çš„å¤§å°æ˜¯å›ºå®šçš„ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿åœ°è®¡ç®—å‡ºå„ä¸ªèŠ‚ç‚¹éœ€è¦å­˜å‚¨å¤šå°‘ä¸ªå—ï¼Œè€Œä¸”å…ƒæ•°æ®å’Œæ–‡ä»¶æ•°æ®æƒ³åˆ†ç¦»ï¼Œæ–¹ä¾¿ç®¡ç†ã€‚\né€‚åˆæ•°æ®å†—ä½™å¤‡ä»½ã€‚\nä¸é€‚åˆå­˜å‚¨å¤§é‡å°æ–‡ä»¶ï¼Œå› ä¸ºæ¯ä¸ªæ–‡ä»¶è‡³å°‘å ä¸€ä¸ªå—ï¼Œå­˜å‚¨å¤§é‡å°æ–‡ä»¶ä¼šä¸¥é‡å½±å“å¯»å€æ•ˆç‡ ã€‚\n\nåç§°èŠ‚ç‚¹ï¼ˆNameNodeï¼‰\nåç§°èŠ‚ç‚¹è´Ÿè´£ç®¡ç†åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿçš„å‘½åç©ºé—´ï¼ˆNamespaceï¼‰ï¼Œä¿å­˜äº†ä¸¤ä¸ªæ ¸å¿ƒæ•°æ®ç»“æ„ï¼šFsimageã€EditLog.\n\nFsimageç”¨äºç»´æŠ¤æ–‡ä»¶ç³»ç»Ÿæ ‘ä»¥åŠæ–‡ä»¶æ ‘ä¸­æ‰€æœ‰æ–‡ä»¶å’Œæ–‡ä»¶å¤¹çš„å…ƒæ•°æ®ã€‚\nEditLogæ“ä½œæ—¥å¿—æ–‡ä»¶è®°å½•äº†æ‰€æœ‰é’ˆå¯¹æ–‡ä»¶çš„åˆ›å»ºã€åˆ é™¤ã€é‡å‘½åç­‰æ“ä½œçš„æ—¥å¿—ã€‚\n\nå‘½åç©ºé—´ (Namespace)\nHDFS çš„å‘½åç©ºé—´ç±»ä¼¼äºä¼ ç»Ÿæ–‡ä»¶ç³»ç»Ÿä¸­çš„ç›®å½•ç»“æ„ï¼Œå®ƒå­˜å‚¨æ–‡ä»¶çš„è·¯å¾„ä¿¡æ¯ã€ç›®å½•ä¿¡æ¯å’Œæ–‡ä»¶çš„ç›¸å…³å±æ€§ï¼ˆå¦‚æƒé™ã€æ‰€æœ‰è€…ç­‰ï¼‰ã€‚å‘½åç©ºé—´ç®¡ç†äº†æ–‡ä»¶å’Œç›®å½•ä¹‹é—´çš„å…³ç³»ï¼Œç¡®ä¿æ–‡ä»¶å’Œç›®å½•çš„è·¯å¾„å”¯ä¸€æ€§ã€‚å®ƒç”± NameNode ç®¡ç†ï¼ŒNameNode æ˜¯ HDFS ä¸­çš„æ ¸å¿ƒç»„ä»¶ï¼Œè´Ÿè´£æ‰€æœ‰ä¸æ–‡ä»¶ç³»ç»Ÿå…ƒæ•°æ®ç›¸å…³çš„è¯·æ±‚ã€‚\n\nå‘½åç©ºé—´ å­˜å‚¨ç€æ–‡ä»¶ç³»ç»Ÿçš„ç»“æ„å’Œæ–‡ä»¶çš„æ‰€æœ‰å…ƒæ•°æ®ã€‚å®ƒåŒ…å«äº†æ‰€æœ‰çš„æ–‡ä»¶å’Œç›®å½•ä¿¡æ¯ï¼Œå¦‚æ–‡ä»¶è·¯å¾„ã€æƒé™ã€æ‰€æœ‰è€…ã€æ—¶é—´æˆ³ç­‰ã€‚\n\nfsimage\nfsimage æ˜¯ä¸€ä¸ªåŒ…å«æ•´ä¸ªæ–‡ä»¶ç³»ç»Ÿå‘½åç©ºé—´å¿«ç…§çš„æ–‡ä»¶ã€‚å®ƒæ˜¯ HDFS å…ƒæ•°æ®çš„æŒä¹…åŒ–å­˜å‚¨ï¼Œè®°å½•äº†æ–‡ä»¶ç³»ç»Ÿçš„çŠ¶æ€ã€‚æ¯å½“ HDFS å¯åŠ¨æ—¶ï¼ŒNameNode ä¼šåŠ è½½ fsimage æ–‡ä»¶ä¸­çš„å†…å®¹ï¼Œæ¢å¤æ–‡ä»¶ç³»ç»Ÿçš„çŠ¶æ€ã€‚\n\nfsimage è®°å½•äº†ä»æ–‡ä»¶ç³»ç»Ÿå¯åŠ¨ä»¥æ¥æ‰€æœ‰å…ƒæ•°æ®çš„æœ€ç»ˆçŠ¶æ€ï¼Œè¡¨ç¤ºæ–‡ä»¶ç³»ç»Ÿçš„æŒä¹…åŒ–å¿«ç…§ã€‚å®ƒæ˜¯ä¸€ä¸ªå®Œæ•´çš„æ–‡ä»¶ç³»ç»Ÿå…ƒæ•°æ®çš„é™æ€é•œåƒã€‚\næ¯æ¬¡ HDFS å¯åŠ¨æ—¶ï¼ŒNameNode ä¼šä»ç£ç›˜åŠ è½½ fsimage æ–‡ä»¶ï¼Œæ¢å¤å…ƒæ•°æ®çš„æœ€æ–°çŠ¶æ€ã€‚fsimage æ–‡ä»¶çš„å­˜åœ¨ä¿è¯äº†å³ä½¿åœ¨ç³»ç»Ÿé‡å¯åï¼Œä¹Ÿèƒ½å¤Ÿæ¢å¤åˆ°æœ€è¿‘çš„æŒä¹…åŒ–çŠ¶æ€ã€‚\n\neditlog\neditlog æ˜¯ä¸€ä¸ªæ—¥å¿—æ–‡ä»¶ï¼Œè®°å½•äº†æ‰€æœ‰å¯¹ HDFS å‘½åç©ºé—´çš„ä¿®æ”¹æ“ä½œã€‚æ¯æ¬¡å¯¹æ–‡ä»¶ç³»ç»Ÿè¿›è¡Œæ›´æ”¹ï¼ˆä¾‹å¦‚åˆ›å»ºæ–‡ä»¶ã€åˆ é™¤æ–‡ä»¶ã€ä¿®æ”¹æƒé™ç­‰ï¼‰ï¼Œè¿™äº›æ›´æ”¹éƒ½ä¼šè¢«å†™å…¥ editlog æ–‡ä»¶ã€‚\n\neditlog è®°å½•äº†æ¯æ¬¡å¯¹å‘½åç©ºé—´è¿›è¡Œä¿®æ”¹çš„æ“ä½œï¼Œä¸”ä»…è®°å½•å¢é‡ä¿®æ”¹ã€‚å®ƒç”¨äºä¿è¯åœ¨ NameNode å´©æºƒæˆ–é‡å¯åèƒ½å¤Ÿæ¢å¤åˆ°ä¿®æ”¹å‘ç”Ÿæ—¶çš„çŠ¶æ€ã€‚\nä¸ fsimage ä¸åŒï¼Œeditlog æ˜¯å¢é‡è®°å½•ï¼Œå­˜å‚¨äº†å¯¹æ–‡ä»¶ç³»ç»Ÿçš„æ‰€æœ‰ä¿®æ”¹æ“ä½œã€‚editlog ä¼šä¸æ–­å¢é•¿ï¼Œä¼šå®šæœŸé€šè¿‡ç¬¬äºŒåç§°èŠ‚ç‚¹è¿›è¡Œ Checkpointing åˆå¹¶ã€‚\n\nç¬¬äºŒåç§°èŠ‚ç‚¹ (Secondary NameNode) ä¸ Checkpointing\nåœ¨ HDFS ä¸­ï¼ŒSecondary NameNode å¹¶ä¸æ˜¯ä¸» NameNode çš„å¤‡ä»½ï¼Œå®ƒçš„ä¸»è¦èŒè´£æ˜¯è¾…åŠ©ä¸» NameNode è¿›è¡Œ Checkpointingï¼Œä»¥é˜²æ­¢ editlog æ–‡ä»¶æ— é™å¢é•¿ï¼Œä¿è¯æ–‡ä»¶ç³»ç»Ÿå…ƒæ•°æ®çš„ç¨³å®šæ€§å’Œå¯æ¢å¤æ€§ã€‚\nä¸»è¦èŒè´£\n\nå®šæœŸä»ä¸» NameNode ä¸‹è½½å½“å‰çš„ fsimage æ–‡ä»¶å’Œç´¯ç§¯çš„ editlog æ–‡ä»¶ã€‚\nå°† fsimage å’Œ editlog åˆå¹¶ï¼Œç”Ÿæˆæ–°çš„ã€åŒ…å«æœ€æ–°ä¿®æ”¹çš„ fsimage æ–‡ä»¶ã€‚\nå°†æ–°çš„ fsimage æ–‡ä»¶ä¸Šä¼ å›ä¸» NameNodeï¼Œå¹¶é€šçŸ¥ä¸» NameNode æ¸…ç©ºå·²åˆå¹¶çš„ editlogï¼Œä»è€Œé˜²æ­¢ editlog æ— é™å¢é•¿ã€‚\n\nCheckpointing æµç¨‹\n\n\nè·å–æ–‡ä»¶\nSecondary NameNode å®šæœŸä¸ä¸» NameNode é€šä¿¡ï¼Œè·å–å½“å‰æœ€æ–°çš„ fsimage æ–‡ä»¶ä»¥åŠè‡ªä¸Šæ¬¡ Checkpointing ä¹‹åç§¯ç´¯çš„ editlog æ–‡ä»¶ã€‚\n\n\nåˆå¹¶æ“ä½œ\nSecondary NameNode åœ¨æœ¬åœ°å°† editlog æ–‡ä»¶ä¸­çš„æ‰€æœ‰æ“ä½œåº”ç”¨åˆ° fsimage ä¸­ï¼Œç”Ÿæˆä¸€ä¸ªæ–°çš„ fsimage æ–‡ä»¶ã€‚è¿™ä¸€æ­¥ä¿è¯äº†æ–°çš„ fsimage åŒ…å«äº†æœ€æ–°çš„æ–‡ä»¶ç³»ç»Ÿå…ƒæ•°æ®çŠ¶æ€ã€‚\n\n\nä¸Šä¼ æ›´æ–°\nå°†æ–°çš„ fsimage æ–‡ä»¶ä¸Šä¼ å›ä¸» NameNodeï¼Œä¸» NameNode æ›¿æ¢æ—§çš„ fsimageï¼ŒåŒæ—¶æ¸…ç©ºå·²ç»åˆå¹¶åˆ° fsimage ä¸­çš„ editlogï¼Œä»è€Œå‡å° editlog æ–‡ä»¶å¤§å°ï¼Œä¿è¯ç³»ç»Ÿç¨³å®šã€‚\n\n\nSecondary NameNode çš„ç‰¹ç‚¹\n\nä¸æ˜¯å¤‡ä»½ NameNodeï¼šå®ƒä¸èƒ½åœ¨ä¸» NameNode æ•…éšœæ—¶ç›´æ¥æ›¿ä»£ NameNodeã€‚\né™ä½æ¢å¤æˆæœ¬ï¼šé€šè¿‡å®šæœŸåˆå¹¶ fsimage å’Œ editlogï¼Œå‡å°‘ NameNode å´©æºƒæ—¶æ¢å¤æ“ä½œæ‰€éœ€åº”ç”¨çš„ editlog æ•°é‡ã€‚\næé«˜ç³»ç»Ÿç¨³å®šæ€§ï¼šé¿å… editlog æ–‡ä»¶è¿‡å¤§å¯¼è‡´ NameNode é‡å¯å’Œæ¢å¤å˜æ…¢ã€‚\n\næ€»ç»“\nSecondary NameNode çš„æ ¸å¿ƒä½œç”¨æ˜¯ è¾…åŠ© Checkpointingï¼š\n\nä¿è¯ fsimage å¿«ç…§ä¸ editlog çš„å¢é‡ä¿®æ”¹åŒæ­¥ï¼›\né˜²æ­¢ editlog æ–‡ä»¶æ— é™å¢é•¿ï¼›\né™ä½ä¸» NameNode å´©æºƒåçš„æ¢å¤æˆæœ¬ã€‚\n\né€šè¿‡ Secondary NameNode çš„å®šæœŸ Checkpointingï¼ŒHDFS èƒ½å¤Ÿä¿æŒå‘½åç©ºé—´å…ƒæ•°æ®çš„æŒä¹…æ€§å’Œä¸€è‡´æ€§ï¼ŒåŒæ—¶æé«˜ç³»ç»Ÿçš„å¥å£®æ€§å’Œå¯é æ€§ã€‚\næ¦‚è¿°æ€»ç»“\n\nå‘½åç©ºé—´ ç”± NameNode ç®¡ç†ï¼Œå­˜å‚¨æ–‡ä»¶ç³»ç»Ÿçš„å…ƒæ•°æ®ã€‚\nfsimage æ˜¯æ–‡ä»¶ç³»ç»Ÿçš„å¿«ç…§ï¼ŒåŒ…å«å‘½åç©ºé—´çš„å®Œæ•´çŠ¶æ€ï¼Œä½œä¸ºæ–‡ä»¶ç³»ç»Ÿå…ƒæ•°æ®çš„æŒä¹…åŒ–å­˜å‚¨ã€‚\neditlog è®°å½•æ–‡ä»¶ç³»ç»Ÿå¯¹å‘½åç©ºé—´çš„å¢é‡ä¿®æ”¹ï¼Œç¡®ä¿æ–‡ä»¶ç³»ç»Ÿçš„æœ€æ–°çŠ¶æ€èƒ½å¤Ÿæ¢å¤ã€‚\nCheckpointing é€šè¿‡å°† fsimage å’Œ editlog åˆå¹¶æ¥é¿å… editlog æ–‡ä»¶è¿‡å¤§ï¼Œå¹¶å®šæœŸç”Ÿæˆæ–°çš„ fsimage æ–‡ä»¶ã€‚\nSecondary NameNode å®šæœŸä»ä¸» NameNode è·å– fsimage å’Œ editlogï¼Œè¿›è¡Œåˆå¹¶æ“ä½œï¼Œå¹¶å°†æ–°çš„ fsimage è¿”å›ç»™ä¸» NameNodeã€‚\n\nè¿™æ ·ï¼Œfsimage å’Œ editlog çš„ç›¸äº’ä½œç”¨ç¡®ä¿äº† HDFS èƒ½å¤Ÿé«˜æ•ˆã€æŒä¹…åœ°ç®¡ç†æ–‡ä»¶ç³»ç»Ÿå…ƒæ•°æ®ï¼Œå¹¶èƒ½å¤Ÿåœ¨å‘ç”Ÿæ•…éšœæ—¶å¿«é€Ÿæ¢å¤ã€‚"},"åˆ†å¸ƒå¼/hadoop/HDFS/HDFSçš„è¯»å†™è¿‡ç¨‹":{"slug":"åˆ†å¸ƒå¼/hadoop/HDFS/HDFSçš„è¯»å†™è¿‡ç¨‹","filePath":"åˆ†å¸ƒå¼/hadoop/HDFS/HDFSçš„è¯»å†™è¿‡ç¨‹.md","title":"HDFSçš„è¯»å†™è¿‡ç¨‹","links":["åˆ†å¸ƒå¼/hadoop/HDFS/HDFSä½“ç³»ç»“æ„","åˆ†å¸ƒå¼/hadoop/HDFS/HDFSæ¦‚è¿°","tags/"],"tags":[""],"content":"ç›¸å…³çš„ Java ç±»ä¸ IO å¯¹è±¡\næŠ½è±¡å±‚æ¬¡\n\n\norg.apache.hadoop.fs.FileSystem\n\n\nHadoop çš„æ–‡ä»¶ç³»ç»ŸæŠ½è±¡ç±»ã€‚\n\n\næœ¬åœ°æ–‡ä»¶ç³»ç»Ÿæ˜¯ LocalFileSystemã€‚\n\n\nHDFS æ˜¯ DistributedFileSystemã€‚\n\n\n\n\norg.apache.hadoop.fs.Path\n\nè¡¨ç¤º HDFS çš„è·¯å¾„å¯¹è±¡ã€‚\n\n\n\nè¾“å…¥ç±»ï¼ˆè¯»ï¼‰\n\n\nFSDataInputStream\n\n\nHadoop çš„è¾“å…¥æµï¼Œæ”¯æŒ seek()ã€‚\n\n\nå†…éƒ¨é€šè¿‡ DFSInputStream ç®¡ç†ä¸ DataNode çš„é€šä¿¡ã€‚\n\n\nç±»ä¼¼ java.io.DataInputStreamï¼Œä½†èƒ½éšæœºå®šä½ã€‚\n\n\n\n\nè¾“å‡ºç±»ï¼ˆå†™ï¼‰\n\n\nFSDataOutputStream\n\n\nHadoop çš„è¾“å‡ºæµï¼Œæ”¯æŒå†™å…¥ã€‚\n\n\nå†…éƒ¨ç”¨ DFSOutputStream æ¥åˆ†ç‰‡ã€åˆ†å—ã€å†™ pipelineã€‚\n\n\nç±»ä¼¼ java.io.DataOutputStreamã€‚\n\n\n\n\nHDFS è¯»æµç¨‹ (Read Path)\n\n\nå®¢æˆ·ç«¯è¯·æ±‚æ–‡ä»¶\n\n\nå®¢æˆ·ç«¯é€šè¿‡ FileSystem fs = FileSystem.get(conf) è·å–ä¸€ä¸ª DistributedFileSystem å®ä¾‹ã€‚\n\n\næ‰§è¡Œ FSDataInputStream in = fs.open(new Path(&quot;/path/file.txt&quot;))ã€‚\n\n\nå†…éƒ¨ä¼šå…ˆé€šè¿‡ RPC(Client â†” NameNode)å‘ NameNode è¯·æ±‚è¿™ä¸ªæ–‡ä»¶çš„ å…ƒæ•°æ®(åç§°èŠ‚ç‚¹ï¼ˆNameNodeï¼‰)ï¼ˆblock åˆ—è¡¨ã€æ¯ä¸ª block å­˜åœ¨å“ªäº› DataNodeï¼‰ã€‚\n\n\n\n\nè·å–æ•°æ®å—ä½ç½®\n\n\nNameNode è¿”å›ï¼šæ–‡ä»¶çš„ block ä¿¡æ¯ï¼ˆblockIDã€åç§»é‡ã€é•¿åº¦ã€DataNode åœ°å€åˆ—è¡¨ï¼‰ã€‚\n\n\nç›¸åŒçš„blockæœ‰å­˜å‚¨å†—ä½™ï¼Œå®¢æˆ·ç«¯ä¼šæ ¹æ®å—æ‰€åœ¨çš„DataNodeçš„è·ç¦»ã€è´Ÿè½½çŠ¶å†µç­‰é€‰æ‹©å…¶ä¸­åˆé€‚çš„ä¸€ä»½æ¥è¯»å–ã€‚\n\n\n\n\nä¸ DataNode é€šä¿¡\n\n\nå®¢æˆ·ç«¯ç›´æ¥ä¸ DataNode å»ºç«‹ è¿æ¥è¿›è¡Œè¯»å–[Client â†” DataNodeã€‚\n\n\né€šè¿‡ BlockReader ç±»æ¥é€å—è¯»å–æ•°æ®ã€‚\n\n\nFSDataInputStream æ”¯æŒ seek()ï¼Œæ‰€ä»¥å¯ä»¥éšæœºè®¿é—®å¤§æ–‡ä»¶çš„ä»»æ„åç§»ã€‚\n\n\n\n\nHDFS å†™æµç¨‹ (Write Path)\n\n\nå®¢æˆ·ç«¯è¯·æ±‚åˆ›å»ºæ–‡ä»¶\n\n\nè°ƒç”¨ FSDataOutputStream out = fs.create(new Path(&quot;/path/file.txt&quot;))ã€‚\n\n\nå®¢æˆ·ç«¯é€šè¿‡ RPCClient â†” NameNode å‘ NameNode ç”³è¯·åœ¨å‘½åç©ºé—´ä¸­æ–°å»ºæ–‡ä»¶ã€‚\n\n\nNameNode æ£€æŸ¥æ˜¯å¦å­˜åœ¨ã€æƒé™æ˜¯å¦å…è®¸ï¼Œç„¶åè¿”å›æ˜¯å¦å¯å†™ã€‚\n\n\n\n\næ•°æ®åˆ‡åˆ†ä¸º block\n\n\nå®¢æˆ·ç«¯å°†æ•°æ®å†™å…¥ DFSOutputStreamï¼Œå®ƒä¼šæŠŠæ•°æ®æ‹†åˆ†æˆ blockã€‚\n\n\næ¯ä¸ª block é»˜è®¤å¤§å° 128MBï¼ˆdfs.blocksize å¯é…ç½®ï¼‰ã€‚\n\n\n\n\nNameNode åˆ†é… DataNode ç®¡é“\n\n\nå®¢æˆ·ç«¯å‘ NameNode è¯·æ±‚ï¼šæˆ‘è¦å†™ä¸‹ä¸€ä¸ª blockã€‚\n\n\nNameNode è¿”å›ä¸€ä¸ª DataNode åˆ—è¡¨ï¼ˆå¦‚å‰¯æœ¬æ•°=3ï¼Œè¿”å›3ä¸ªèŠ‚ç‚¹åœ°å€ï¼‰ã€‚\n\n\nå®¢æˆ·ç«¯å»ºç«‹ä¸€ä¸ª pipelineï¼šclient â†’ DN1 â†’ DN2 â†’ DN3ã€‚Client â†” DataNode\n\n\n\n\næµæ°´çº¿å†™å…¥\n\n\nå®¢æˆ·ç«¯å…ˆæŠŠæ•°æ®æµé€åˆ°ç¬¬ä¸€ä¸ª DataNodeã€‚\n\n\nDN1 å†™æœ¬åœ°åå†è½¬å‘ç»™ DN2ï¼ŒDN2 å†è½¬å‘ DN3ã€‚\n\n\næ¯ä¸ª DataNode éƒ½ä¼šè¿”å› ACKï¼Œæœ€ç»ˆç¡®è®¤å†™æˆåŠŸã€‚\n\n\n\n\nå…³é—­æ–‡ä»¶\n\n\nå®¢æˆ·ç«¯è°ƒç”¨ out.close()ã€‚\n\n\nDFSOutputStream é€šçŸ¥ NameNode æ–‡ä»¶å†™å®Œã€‚\n\n\nNameNode å°†æœ€ç»ˆçš„æ–‡ä»¶å…ƒæ•°æ®æ ‡è®°ä¸ºâ€œå®Œæˆâ€ï¼Œä¹‹åå…¶ä»–å®¢æˆ·ç«¯å¯ä»¥è¯»ã€‚\n\n\n\n\n äºŒã€å†™æµç¨‹ä¸­çš„ editlog æ›´æ–°\nå†™å…¥æ—¶ NameNode è¦ç»´æŠ¤ å‘½åç©ºé—´ä¸€è‡´æ€§ï¼Œå®ƒçš„ editlogï¼ˆå¢é‡æ—¥å¿—ï¼‰è®°å½•äº†å¯¹æ–‡ä»¶ç³»ç»Ÿçš„å…ƒæ•°æ®ä¿®æ”¹ã€‚\næµç¨‹å¯ä»¥åˆ†ä¸¤ç±»æ›´æ–°ï¼š\n\n\næ–‡ä»¶åˆ›å»ºæ—¶\n\n\nå®¢æˆ·ç«¯ create(&quot;/path/file&quot;) â†’ RPC åˆ° NameNode\n\n\nNameNode åœ¨å†…å­˜å…ƒæ•°æ®ä¸­åŠ ä¸€ä¸ªâ€œæ­£åœ¨å†™â€çš„æ–‡ä»¶æ¡ç›®\n\n\nå¹¶ç«‹å³å†™å…¥ä¸€æ¡ OP_ADD (æ–°å¢æ–‡ä»¶) åˆ° editlog\n\n\n\n\nåˆ†é… block æ—¶\n\n\nå®¢æˆ·ç«¯ç¼“å­˜æ•°æ®è¾¾åˆ° block å¤§å°æˆ– close() æ—¶ â†’ è¯·æ±‚ NameNode åˆ†é…æ–° block\n\n\nNameNode åœ¨å†…å­˜ä¸­ç»™æ–‡ä»¶åˆ†é…ä¸€ä¸ªæ–°çš„ blockIDï¼Œå¹¶å†³å®šå‰¯æœ¬æ”¾åœ¨å“ªäº› DataNode\n\n\nNameNode å†™å…¥ä¸€æ¡ OP_ADD_BLOCK (å¢åŠ  block) åˆ° editlog\n\n\nç„¶åæŠŠ DataNode åˆ—è¡¨è¿”å›ç»™å®¢æˆ·ç«¯\n\n\nå®¢æˆ·ç«¯æ‰å»å’Œ DataNode å»º pipelineï¼Œä¼ è¾“æ•°æ®\n\n\n\n\næ–‡ä»¶å…³é—­æ—¶\n\n\nDFSOutputStreamç®¡ç†çš„pipelineä¼šæ”¶é›†æ‰€æœ‰DataNodeçš„å†™å…¥ACK,å¾—åˆ°æ‰€æœ‰ACKåè¿”å›ç»™å®¢æˆ·ç«¯\n\n\nå®¢æˆ·ç«¯ close() â†’ RPC åˆ° NameNode\n\n\nNameNode æŠŠè¯¥æ–‡ä»¶æ ‡è®°ä¸º complete\n\n\nå†™å…¥ä¸€æ¡ OP_CLOSE (å…³é—­æ–‡ä»¶) åˆ° editlog\n\n\n\n\nå…³é”®ç‚¹\n\n\nDataNode pipeline ä¼ è¾“\nDataNode ä¹‹é—´çš„å¤åˆ¶ã€æ ¡éªŒã€ç¡®è®¤ ä¸æ¶‰åŠ NameNodeï¼Œå®Œå…¨æ˜¯å®¢æˆ·ç«¯å’Œ DataNode ä¹‹é—´åä½œå®Œæˆçš„ã€‚\nNameNode åªåœ¨â€œåˆ†é… blockã€å®Œæˆ blockâ€æ—¶å†™ editlogã€‚\n\n\neditlog å†…å®¹\neditlog æ˜¯çº¯å…ƒæ•°æ®æ“ä½œæ—¥å¿—ï¼Œä¸è®°å½•å®é™…æ•°æ®å†…å®¹ã€‚\nå®ƒè®°å½•çš„æ“ä½œåŒ…æ‹¬ï¼šæ–‡ä»¶åˆ›å»ºã€åˆ é™¤ã€æ·»åŠ  blockã€å‰¯æœ¬ä½ç½®ã€å…³é—­æ–‡ä»¶ç­‰ã€‚\n\n\næœ€ç»ˆä¸€è‡´æ€§\n\nå®¢æˆ·ç«¯å†™å®Œæ•°æ®åï¼Œåªæœ‰åœ¨ close() ä¹‹åï¼ŒNameNode æ‰æŠŠæ–‡ä»¶æ ‡è®°ä¸ºå®Œæˆï¼ˆå¦åˆ™æ–‡ä»¶ä¸€ç›´æ˜¯â€œæ­£åœ¨å†™â€çŠ¶æ€ï¼‰ã€‚  è¿™æ—¶ editlog é‡Œå·²ç»æœ‰äº†å®Œæ•´çš„ create + addBlock + close ä¸‰ç±»è®°å½•ã€‚\nå¦‚æœä¸­é€”å®¢æˆ·ç«¯å®•æœºï¼ŒNameNodeä¹Ÿå¯ä»¥é€šè¿‡å‘¨æœŸæ€§å¿ƒè·³å’Œblock reportå‘NomaNodeæ±‡æŠ¥ã€‚\n\n\n"},"æ•°æ®ç»“æ„ä¸ç®—æ³•/ç®—æ³•æŠ€å·§ç¬”è®°/äºŒåˆ†æ³•":{"slug":"æ•°æ®ç»“æ„ä¸ç®—æ³•/ç®—æ³•æŠ€å·§ç¬”è®°/äºŒåˆ†æ³•","filePath":"æ•°æ®ç»“æ„ä¸ç®—æ³•/ç®—æ³•æŠ€å·§ç¬”è®°/äºŒåˆ†æ³•.md","title":"äºŒåˆ†æ³•","links":[],"tags":[],"content":"ç®—æ³•æè¿°\nåœ¨è¿ç»­ä¸”æœ‰é™çš„æ•°ç»„ä¸­æœç´¢ç¬¦åˆæ¡ä»¶çš„å€¼æ—¶å¯ä»¥ä½¿ç”¨äºŒåˆ†æ³•ï¼Œå¤æ‚åº¦ä¸ºO(\\log{n}).\nåŸºæœ¬ç»“æ„å¦‚ä¸‹\nleft=0;\nright=arr.length-1;\nwhile (CONDATION(left,right)){\n\tmid=MID(left,right);\n\tif (P(mid))\t{\n\t\tUPDATE_LEFT(left);\t\n\t}\n\telse{\n\t\tUPDATE_RIGHT(right);\t\n\t}\n}\nreturn CHOICE(left,right,mid);\n\nå…¶ä¸­CONDITON,MID,P,UPDATE_LEFT,UPDATE_RIGHT,CHOICEéƒ½æ˜¯éœ€è¦æ ¹æ®å…·ä½“é—®é¢˜æ¥ç¡®å®šçš„ç®—æ³•ã€‚\n\næœç´¢ç©ºé—´æ˜¯ä¸€ä¸ªä»¥leftå’Œrightä¸ºè¾¹ç•Œçš„åŒ…å«ç›®æ ‡å€¼çš„åŒºé—´ï¼Œè¿­ä»£è¿‡ç¨‹ä¸­æœç´¢ç©ºé—´ä¸æ–­ç¼©å°ï¼Œç›´åˆ°æ±‚å‡ºè§£ï¼Œé€€å‡ºwhileå¾ªç¯ï¼Œåœ¨whileå¾ªç¯è¿­ä»£çš„è¿‡ç¨‹ä¸­ç»´æŠ¤è¿™ä¸ªåŒºé—´æœ‰å¦‚ä¸‹ä¸¤ç§å¤„ç†æ‰‹æ®µï¼š\n\né—­åŒºé—´\nåŠå¼€åŒºé—´ï¼ˆå·¦é—­å³å¼€,å³rightå€¼ä¸åœ¨æœç´¢ç©ºé—´å†…ï¼‰\n\n\nCONDITIONè¡¨ç¤ºleftä¸rightä¹‹é—´çš„å¤§å°å…³ç³»è§„åˆ™ï¼Œç”¨äºæ§åˆ¶whileå¾ªç¯çš„é€€å‡ºæ—¶æœºï¼Œæœ‰ä¸¤ç§é€‰æ‹©\n\nleft&lt;right\nleft&lt;=right\n\n\nMIDæ˜¯æ ¹æ®leftå’Œrightç”Ÿæˆä¸­å€¼midçš„è§„åˆ™ï¼Œä¸€èˆ¬æœ‰ä¸¤ç§é€‰æ‹©ï¼š\n\nä¸Šå–ä¸­(upper-mid):mid=left+(right-left+1)/2\nä¸‹å–ä¸­(lower-mid):mid=left+(right-left)/2\n\n\nå•è°ƒè°“è¯Pæ˜¯ä¸€ä¸ªå…³äºæ•°ç»„ä¸‹æ ‡iå•è°ƒçš„å¸ƒå°”å‡½æ•°(å­˜åœ¨jä½¿å¾—i \\leq j,P(i)=1,i&gt;j,P(i)=0 \\text{æˆ–} i \\leq j P(i)=0,i&gt;j,P(i)=1ï¼Œç”±å®é™…é—®é¢˜å†³å®š\nUPDATE_LEFTæ˜¯äºŒåˆ†ç¼©å°æœç´¢èŒƒå›´æ—¶æ›´æ–°leftçš„è§„åˆ™ï¼Œä¸€èˆ¬æœ‰å¦‚ä¸‹é€‰æ‹©ï¼š\n\nleft=mid\nleft=mid+1\n\n\nUPDATE_RIGHTæ˜¯äºŒåˆ†ç¼©å°æœç´¢èŒƒå›´æ—¶æ›´æ–°rightçš„è§„åˆ™ï¼Œä¸€èˆ¬æœ‰å¦‚ä¸‹é€‰æ‹©ï¼š\n\nright=mid\nright=mid-1\n\n\nCHOICE:whileå¾ªç¯é€€å‡ºï¼Œå®Œæˆæœç´¢åï¼Œæ ¹æ®ä¸åŒçš„é—®é¢˜ï¼Œæœ€ç»ˆéœ€è¦çš„æœç´¢ç»“æœå¯èƒ½åœ¨leftï¼Œmid,rightæ‰€æŒ‡å‘çš„ä½ç½®ï¼Œæ ¹æ®å®é™…é—®é¢˜é€‰æ‹©\n\nä¸‹è¡¨æ­ç¤ºäº†ç”±ä¸Šè¿°å…³é”®ç‚¹æè¿°çš„äºŒåˆ†æ³•é—®é¢˜çš„æ±‚è§£æ€è·¯\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nå•è°ƒè°“è¯å½¢æ€åŒºé—´è¯­ä¹‰å¾ªç¯æ¡ä»¶mid å–æ³•æ›´æ–°è§„åˆ™ï¼ˆçœŸ / å‡ï¼‰é€€å‡ºè¿”å›å¤‡æ³¨000111ï¼ˆç¬¬ä¸€ä¸ªä¸ºçœŸ / First Trueï¼‰[l, r)l &lt; rä¸‹å–ä¸­P(mid) çœŸ â†’ r = midï¼› å¦åˆ™ l = mid + 1è¿”å› læ¨èï¼šæ ‡å‡† lower_bound / upper_bound æ”¹æ¡ä»¶å³ç”¨000111ï¼ˆç¬¬ä¸€ä¸ªä¸ºçœŸï¼‰[l, r]l &lt; rä¸‹å–ä¸­P(mid) çœŸ â†’ r = midï¼› å¦åˆ™ l = mid + 1è¿”å› lï¼ˆä¸ r ç›¸ç­‰ï¼‰ä¹Ÿå¯ç”¨ï¼›é—­åŒºé—´å†™æ³•ï¼Œè¯­ä¹‰æ¸…æ™°111000ï¼ˆæœ€åä¸€ä¸ªä¸ºçœŸ / Last Trueï¼‰[l, r]l &lt; rä¸Šå–ä¸­P(mid) çœŸ â†’ l = midï¼› å¦åˆ™ r = mid - 1è¿”å› lï¼ˆ=rï¼‰æ¨èï¼šæ‰¾â€œæœ€åä¸€ä¸ªæ»¡è¶³â€çš„æ ‡å‡†æ¨¡æ¿111000ï¼ˆæœ€åä¸€ä¸ªä¸ºçœŸï¼‰[l, r)l &lt; rä¸‹å–ä¸­P(mid) çœŸ â†’ l = mid + 1ï¼› å¦åˆ™ r = midè¿”å› l - 1ç­‰ä»·äºâ€œæ‰¾ç¬¬ä¸€ä¸ªå‡å†å‡ä¸€â€ï¼›åŒæ ·ç¨³\nleft&lt;rightè¶³ä»¥æè¿°ç»å¤§å¤šæ•°äºŒåˆ†æ³•é—®é¢˜ï¼Œæ‰€ä»¥è¿™å¥—æ±‚è§£æ–¹æ¡ˆæ²¡æœ‰æ¶‰åŠå¾ªç¯æ¡ä»¶ä¸ºleft&lt;=rightçš„é€‰é¡¹ï¼Œä½†åœ¨æŸäº›ç‰¹å®šæƒ…å½¢ä¸‹ï¼Œå°äºç­‰äºå¯èƒ½æ›´ç®€æ´ã€‚\nä¸¾ä¾‹\n000111 Ã— åŠå¼€åŒºé—´ [l, r)ï¼ˆFirst True / ä¸‹ç•Œ lower_boundï¼‰\né—®é¢˜ï¼šåœ¨éé™åºæ•°ç»„ä¸­ï¼Œæ‰¾ç¬¬ä¸€ä¸ª â‰¥ x çš„ä½ç½®ï¼ˆä¸‹ç•Œï¼‰ã€‚\nP(i)ï¼ša[i] â‰¥ xï¼ˆå½¢å¦‚ 000111ï¼‰ã€‚\nåŒºé—´ï¼š[l, r)ï¼›\nå¾ªç¯ï¼šl &lt; rï¼›\nå–ä¸­ï¼šä¸‹å–ä¸­ï¼›\næ›´æ–°ï¼šP(mid) çœŸ â†’ r = midï¼› å¦åˆ™ â†’ l = mid + 1ï¼›è¿”å›ï¼šlã€‚\nç¤ºä¾‹ï¼ša = [1,2,2,3,5]ï¼Œx=2 â†’ æœŸæœ›è¿”å› 1ã€‚\næç«¯ï¼šx=4 â†’ è¿”å› 4ï¼›x=6 â†’ è¿”å› 5(=n)ã€‚\nint lower_bound(int *a, int n, int x){\n    int l = 0, r = n;                    // [l, r)\n    while (l &lt; r){\n        int mid = l + (r - l) / 2;       // ä¸‹å–ä¸­\n        if (a[mid] &lt; x) l = mid +1;        // P(mid) çœŸ\n        else             r = mid;\n    }\n    return l;\n}\n000111 Ã— é—­åŒºé—´ [l, r]ï¼ˆFirst True çš„é—­åŒºé—´å†™æ³•ï¼‰\né—®é¢˜ï¼šLeetCode 278ã€Œç¬¬ä¸€ä¸ªé”™è¯¯ç‰ˆæœ¬ã€â€”â€”æ‰¾ç¬¬ä¸€ä¸ª isBadVersion(i)=true çš„ç‰ˆæœ¬å·ã€‚\nP(i)ï¼šisBadVersion(i)ï¼ˆ000111ï¼‰ã€‚\nåŒºé—´ï¼š[l, r]ï¼›\nå¾ªç¯ï¼šl &lt; rï¼›\nå–ä¸­ï¼šä¸‹å–ä¸­ï¼›\næ›´æ–°ï¼šP(mid) çœŸ â†’ r = midï¼› å¦åˆ™ â†’ l = mid + 1ï¼›è¿”å›ï¼šl(=r)ã€‚\nç¤ºä¾‹ï¼šn=7ï¼Œé”™è¯¯ä» 4 å¼€å§‹ â†’ è¿”å› 4ã€‚\nint first_bad(int n){\n    int l = 1, r = n;                    // ç‰ˆæœ¬å·ä» 1 å¼€å§‹\n    while (l &lt; r){\n        int mid = l + (r - l) / 2;       // ä¸‹å–ä¸­\n        if (isBadVersion(mid)) r = mid;  // P(mid) çœŸ\n        else                    l = mid + 1;\n    }\n    return l;\n}\n111000 Ã— é—­åŒºé—´ [l, r]ï¼ˆLast True / æœ€åä¸€ä¸ª â‰¤ xï¼‰\né—®é¢˜ï¼šåœ¨éé™åºæ•°ç»„ä¸­ï¼Œæ‰¾æœ€åä¸€ä¸ª â‰¤ x çš„ä½ç½®ï¼ˆç­‰ä»·äº upper_bound(x)-1ï¼‰ã€‚\nP(i)ï¼ša[i] â‰¤ xï¼ˆ111000ï¼‰ã€‚\nåŒºé—´ï¼š[l, r]ï¼›å¾ªç¯ï¼šl &lt; rï¼›å–ä¸­ï¼šä¸Šå–ä¸­ï¼›\næ›´æ–°ï¼šP(mid) çœŸ â†’ l = midï¼› å¦åˆ™ â†’ r = mid - 1ï¼›è¿”å›ï¼šl(=r)ã€‚\nç¤ºä¾‹ï¼ša = [1,2,2,3,5]ï¼Œx=2 â†’ è¿”å› 2ï¼›x=4 â†’ è¿”å› 3ï¼›x=0 â†’ è¿”å› -1ï¼ˆéœ€é¢å¤–åˆ¤ç©ºï¼‰ã€‚\nint last_leq(int *a, int n, int x){\n    if (n == 0) return -1;\n    int l = 0, r = n - 1;\n    // å¦‚æœæœ€å°å€¼éƒ½ &gt; xï¼Œå¯æå‰è¿”å› -1ï¼ˆçœç•¥ä¹Ÿè¡Œï¼Œæœ€ååˆ¤æ–­ï¼‰\n    if (a[l] &gt; x) return -1;\n    while (l &lt; r){\n        int mid = l + (r - l + 1) / 2;   // ä¸Šå–ä¸­\n        if (a[mid] &lt;= x) l = mid;        // P(mid) çœŸ\n        else             r = mid - 1;\n    }\n    return l;\n}\n111000 Ã— åŠå¼€åŒºé—´ [l, r)ï¼ˆLast True çš„åŠå¼€åŒºé—´å†™æ³•ï¼šè¿”å› l-1ï¼‰\né—®é¢˜ï¼šæ—‹è½¬å‡åºæ•°ç»„ï¼ˆæ— é‡å¤ï¼‰ä¸­æ‰¾æœ€å¤§å€¼ä¸‹æ ‡ï¼ˆpivotï¼‰ã€‚\nP(i)ï¼ša[i] â‰¥ a[0]ï¼ˆ111000ï¼‰ã€‚\nåŒºé—´ï¼š[l, r)ï¼›å¾ªç¯ï¼šl &lt; rï¼›å–ä¸­ï¼šä¸‹å–ä¸­ï¼›\næ›´æ–°ï¼šP(mid) çœŸ â†’ l = mid + 1ï¼› å¦åˆ™ â†’ r = midï¼›\nè¿”å›ï¼šl - 1ï¼ˆå› ä¸º l ä¼šåœåœ¨â€œç¬¬ä¸€ä¸ªå‡â€çš„ä½ç½®ï¼‰ã€‚\nç¤ºä¾‹ï¼ša=[4,5,6,7,0,1,2] â†’ è¿”å› 3ï¼›æœªæ—‹è½¬ a=[1,2,3] â†’ è¿”å› 2ã€‚\nint pivot_max(int *a, int n){\n    int l = 0, r = n;                    // [l, r)\n    while (l &lt; r){\n        int mid = l + (r - l) / 2;       // ä¸‹å–ä¸­\n        if (a[mid] &gt;= a[0]) l = mid + 1; // P(mid) çœŸ\n        else                r = mid;\n    }\n    return l - 1;                        // æœ€åä¸€ä¸ªä¸ºçœŸ\n}\n\nå°ç»“\n\n\nFirst Trueï¼ˆ000111ï¼‰ï¼š\n\n\nåŠå¼€æ¨¡æ¿ï¼š[l,r) + ä¸‹å–ä¸­ + r=mid / l=mid+1 â†’ è¿”å› lã€‚\n\n\né—­åŒºæ¨¡æ¿ï¼š[l,r] + ä¸‹å–ä¸­ + r=mid / l=mid+1 â†’ è¿”å› l(=r)ã€‚\n\n\n\n\nLast Trueï¼ˆ111000ï¼‰ï¼š\n\n\né—­åŒºæ¨¡æ¿ï¼š[l,r] + ä¸Šå–ä¸­ + l=mid / r=mid-1 â†’ è¿”å› lã€‚\n\n\nåŠå¼€æ¨¡æ¿ï¼š[l,r) + ä¸‹å–ä¸­ + l=mid+1 / r=mid â†’ è¿”å› l-1ã€‚\n\n\n\n"},"æ•°ç†ç»Ÿè®¡2/å›å½’/ä¸€å…ƒçº¿æ€§å›å½’/1.åŸºæœ¬å‡è®¾":{"slug":"æ•°ç†ç»Ÿè®¡2/å›å½’/ä¸€å…ƒçº¿æ€§å›å½’/1.åŸºæœ¬å‡è®¾","filePath":"æ•°ç†ç»Ÿè®¡2/å›å½’/ä¸€å…ƒçº¿æ€§å›å½’/1.åŸºæœ¬å‡è®¾.md","title":"1.åŸºæœ¬å‡è®¾","links":[],"tags":[],"content":"è§£é‡Šå˜é‡x_,\\cdots,x_pééšæœºå˜é‡ï¼Œæ ·æœ¬\\{(y_i,X_i) \\mid 1\\leq i\\leq n\\}è§‚æµ‹å€¼x_{i1},\\cdots ,x_{ip}ä¸ºå¸¸æ•°\nè¯¯å·®é¡¹éšæœºå˜é‡\\epsilon æ»¡è¶³\nE[\\epsilon_i]=0,i=1\\cdots ,n \n\\begin{cases}\n\\text{Var}(\\epsilon_i) = \\sigma^2, &amp; i = 1, \\cdots, n \\\\\n\\text{Cov}(\\epsilon_i, \\epsilon_j) = 0, &amp; i \\neq j\n\\end{cases}\nå³å„æ ·æœ¬ç‚¹ä¸Šçš„è¯¯å·®é¡¹å‡å€¼ä¸ºé›¶ã€æ–¹å·®ç›¸åŒä¸”ç›¸äº’ç‹¬ç«‹ã€‚"},"æ•°ç†ç»Ÿè®¡2/å›å½’/ä¸€å…ƒçº¿æ€§å›å½’/2.æœ€å°äºŒä¹˜ä¼°è®¡OLSE":{"slug":"æ•°ç†ç»Ÿè®¡2/å›å½’/ä¸€å…ƒçº¿æ€§å›å½’/2.æœ€å°äºŒä¹˜ä¼°è®¡OLSE","filePath":"æ•°ç†ç»Ÿè®¡2/å›å½’/ä¸€å…ƒçº¿æ€§å›å½’/2.æœ€å°äºŒä¹˜ä¼°è®¡OLSE.md","title":"2.æœ€å°äºŒä¹˜ä¼°è®¡OLSE","links":[],"tags":[],"content":"æ±‚è§£ä¸€å…ƒçº¿æ€§å›å½’æ¨¡å‹ï¼Œå°±æ˜¯è¦ç»™å‡ºçœŸå®å›å½’æ¨¡å‹y=\\beta_1x+\\beta_0ä¸­\\beta_0,\\beta_1çš„ä¼°è®¡\\hat{\\beta_0},\\hat{\\beta_1}.ä½†ç”±äºæ®‹å·®é¡¹\\epsilonçš„åˆ†å¸ƒç±»å‹æ˜¯æœªçŸ¥çš„ï¼Œæ— æ³•æ¨ç†å‡ºyçš„åˆ†å¸ƒç±»å‹ï¼Œè¿›è€Œä¼°è®¡ï¼Œäºæ˜¯é‡‡ç”¨æœ€å°äºŒä¹˜æ³•ä¼°è®¡\\beta_0,\\beta_1.\næœ€å°äºŒä¹˜ä¼°è®¡æ±‚å‡ºçš„å›å½’æ–¹ç¨‹ï¼Œæˆä¸ºä¸€å…ƒçº¿æ€§ç»éªŒå›å½’æ–¹ç¨‹ã€‚\n\\hat{y}=\\hat{\\beta_1}x+\\hat{\\beta_0}\nç®—æ³•\nç›®çš„ä¸ºæœ€å°åŒ–æ€»æ‹Ÿåˆè¯¯å·®\\left|y_i-\\hat{\\beta_1}x-\\hat{\\beta_0}\\right|.\næ„é€ ç›®æ ‡å‡½æ•°\nQ(\\gamma_0,\\gamma_1)=\\Sigma_{i=1}^n(y_i-\\gamma_0-\\gamma_1x)^2\nQæ˜¯å‡¸å‡½æ•°ï¼Œ\n\\left\\{\n\\begin{aligned}\n\\frac{\\partial{Q}}{\\partial{\\gamma_0}} &amp;= 0 \\\\\n\\frac{\\partial{Q}}{\\partial{\\gamma_1}} &amp;= 0 \n\\end{aligned}\n\\right.\næ»¡è¶³ä¸Šè¿°æ–¹ç¨‹ç»„çš„\\gamma_0,\\gamma_1å³ä¸ºæœ€å°äºŒä¹˜ä¼°è®¡\\hat{\\beta_0},\\hat{\\beta_1}\n\\left\\{\n\\begin{aligned}\n\\hat{\\beta_1} &amp;= \\frac{L_{xy}}{L_{xx}} \\\\\n\\hat{\\beta_0} &amp;= \\bar{y}-\\hat{\\beta_1}x\n\\end{aligned}\n\\right.\nå…¶ä¸­\n\\left\\{\n\\begin{aligned}\nL_{xx}&amp;=\\Sigma(x_i-\\bar{x})^2 \\\\\nL_{xy}&amp;=\\Sigma(x_i-\\bar{x})(y_i-\\bar{y})\n\\end{aligned}\n\\right."},"æ•°ç†ç»Ÿè®¡2/å›å½’/ä¸€å…ƒçº¿æ€§å›å½’/3.å›å½’ç³»æ•°çš„æ€§è´¨":{"slug":"æ•°ç†ç»Ÿè®¡2/å›å½’/ä¸€å…ƒçº¿æ€§å›å½’/3.å›å½’ç³»æ•°çš„æ€§è´¨","filePath":"æ•°ç†ç»Ÿè®¡2/å›å½’/ä¸€å…ƒçº¿æ€§å›å½’/3.å›å½’ç³»æ•°çš„æ€§è´¨.md","title":"3.å›å½’ç³»æ•°çš„æ€§è´¨","links":[],"tags":[],"content":"çº¿æ€§æ€§\n\\hat{\\beta_1},\\hat{\\beta_0}æ˜¯ éšæœºå˜é‡y_içš„çº¿æ€§å‡½æ•°\næ— åæ€§\n\\begin{aligned}\nE\\hat{\\beta_1} &amp;=E[\\frac{\\Sigma_{i=1}^n (x_i-\\bar{x})y_i}{\\Sigma_{i=1}^n(x_i-\\bar{x})^2}] \\\\\n\t\t\t   \n\t\t\t   &amp;=\\frac{\\Sigma_{i=1}^n (x_i-\\bar{x})E[y_i]}{\\Sigma_{i=1}^n(x_i-\\bar{x})^2} \\\\\n\t\t\t   \n\t\t\t   &amp;=\\frac{\\Sigma_{i=1}^n (x_i-\\bar{x})(\\beta_1x_i+\\beta_0)}{\\Sigma_{i=1}^n(x_i-\\bar{x})^2} \\\\\n\t\t\t   \n\t\t\t   &amp;=\\frac{\\Sigma_{i=1}^n (x_i-\\bar{x})x_i}{\\Sigma_{i=1}^n(x_i-\\bar{x})^2}\\beta_1 \\\\\n\t\t\t   \n\\end{aligned}\nå…¶ä¸­\\frac{\\Sigma_{i=1}^n (x_i-\\bar{x})x_i}{\\Sigma_{i=1}^n(x_i-\\bar{x})^2}=1 \næ•…E\\hat{\\beta_1}=\\beta_1,åŒç†å¯è¯E\\hat{\\beta_0}=\\beta_0\næ–¹å·®\nç”±äºy_1,\\cdots,y_nç‹¬ç«‹ï¼Œvar(y_i)=\\sigma^2\næ•…$$\n\\begin{aligned}\nVar(\\hat{\\beta_1}) &amp;= \\Sigma_{i=1}^{n} [\\frac{x_i - \\bar{x}}{\\Sigma_{i=1}^n (x_i-\\bar{x})^2}]^2 Var(y_i)\\\n&amp;= \\frac{\\sigma^2}{L_{xx}}\n\\end{aligned}\n\nVar(\\hat{\\beta_0})=[\\frac{1}{n}+\\frac{\\bar{x}^2}{L_{xx}}]\\sigma\n"},"æ•°ç†ç»Ÿè®¡2/å›å½’/ä¸€å…ƒçº¿æ€§å›å½’/4.è¯¯å·®éšæœºå˜é‡æ–¹å·®çš„ä¼°è®¡":{"slug":"æ•°ç†ç»Ÿè®¡2/å›å½’/ä¸€å…ƒçº¿æ€§å›å½’/4.è¯¯å·®éšæœºå˜é‡æ–¹å·®çš„ä¼°è®¡","filePath":"æ•°ç†ç»Ÿè®¡2/å›å½’/ä¸€å…ƒçº¿æ€§å›å½’/4.è¯¯å·®éšæœºå˜é‡æ–¹å·®çš„ä¼°è®¡.md","title":"4.è¯¯å·®éšæœºå˜é‡æ–¹å·®çš„ä¼°è®¡","links":[],"tags":[],"content":"\\hat{\\sigma}^2 = \\frac{1}{n-2} \\sum (y_i - \\hat{y}_i)^2\nå…¶ä¸­\n\\hat{y}_i = \\hat{\\beta}_0 + \\hat{\\beta}_1 x_i"},"æ•°ç†ç»Ÿè®¡2/å›å½’/ä¸€å…ƒçº¿æ€§å›å½’/5.æ˜¾è‘—æ€§æ£€éªŒ":{"slug":"æ•°ç†ç»Ÿè®¡2/å›å½’/ä¸€å…ƒçº¿æ€§å›å½’/5.æ˜¾è‘—æ€§æ£€éªŒ","filePath":"æ•°ç†ç»Ÿè®¡2/å›å½’/ä¸€å…ƒçº¿æ€§å›å½’/5.æ˜¾è‘—æ€§æ£€éªŒ.md","title":"5.æ˜¾è‘—æ€§æ£€éªŒ","links":[],"tags":[],"content":"H_0: \\beta_1 = 0 \\quad\\text{vs.}\\quad H_1: \\beta_1 \\neq 0\ntæ£€éªŒ\nåœ¨å‡å®šè¯¯å·®é¡¹æ»¡è¶³ç‹¬ç«‹åŒåˆ†å¸ƒï¼Œä¸” \\varepsilon_i \\sim N(0, \\sigma^2) çš„æ¡ä»¶ä¸‹ï¼š\nå›å½’ç³»æ•°ä¼°è®¡çš„åˆ†å¸ƒ\nå‡è®¾\\epsilon_i \\sim N(0,\\sigma^2ï¼‰ åˆ™\\hat{\\beta}_1 \\sim N\\left(\\beta_1, \\dfrac{\\sigma^2}{L_{xx}}\\right)  ï¼Œå…¶ä¸­  L_{xx} = \\sum (x_i - \\bar{x})^2\nåœ¨ H_0 ä¸‹ï¼Œæœ‰\nt = \\frac{\\hat{\\beta}_1 - 0}{\\sqrt{\\hat{\\sigma}^2 / L_{xx}}} \\sim t_{n-2}\nFæ£€éªŒï¼šç›´æ¥ä»å›å½’æ•ˆæœæ£€éªŒæ˜¾è‘—æ€§\nå¹³æ–¹å’Œåˆ†è§£å¼\n\\sum_{i=1}^{n} (y_i - \\bar{y})^2 = \\sum_{i=1}^{n} (\\hat{y}_i - \\bar{y})^2 + \\sum_{i=1}^{n} (y_i - \\hat{y}_i)^2\n\nç§° \\sum_{i=1}^{n} (y_i - \\bar{y})^2 ä¸ºæ€»ç¦»å·®å¹³æ–¹å’Œ (SST)ï¼Œæè¿°è§‚æµ‹å€¼ y æœ¬èº«çš„æ–¹å·®\nç§° \\sum_{i=1}^{n} (\\hat{y}_i - \\bar{y})^2 ä¸ºå›å½’å¹³æ–¹å’Œ (SSR)\nç§° \\sum_{i=1}^{n} (y_i - \\hat{y}_i)^2 ä¸ºæ®‹å·®å¹³æ–¹å’Œ (SSE)\n\nSST = SSR + SSE\nè¯æ˜:\nå³è¯\n\\sum_{i=1}^{n} (y_i - \\hat{y}_i + \\hat{y}_i - \\bar{y})^2 = \\sum_{i=1}^{n} (y_i - \\bar{y})^2 + \\sum_{i=1}^{n} (y_i - \\hat{y}_i)^2\nå³è¯\n\\sum_{i=1}^{n} (y_i - \\hat{y}_i)(\\hat{y}_i - \\bar{y}) = 0\nè®°æ®‹å·® e_i = y_i - \\hat{y}_i\n\\frac{\\partial Q}{\\partial \\beta_1} = 2 \\sum x_i (y_i - \\hat{\\beta_1}x_i-\\hat{\\beta_0}) = 0, \\quad \\frac{\\partial Q}{\\partial \\beta_0} = 2 \\sum (y_i - \\beta_0 - \\beta_1 x_i) = 0\n\\Rightarrow e_i = y_i - \\hat{y}_i = y_i - \\hat{\\beta}_0 - \\hat{\\beta}_1 x_i \n\n\\Rightarrow \\sum x_i e_i = \\sum e_i = 0.\n\\begin{aligned}\n&amp;\\sum_{i=1}^{n} (y_i - \\hat{y}_i)(\\hat{y}_i - \\bar{y}) \\\\ \n=&amp;\\sum e_i (\\hat{y}_i - \\bar{y}) =\\sum e_i\\hat{y_i}+\\bar{y}\\sum e_i \\\\\n=&amp;\\sum e_i (\\hat{\\beta}_0 + \\hat{\\beta}_1 x_i) \\\\\n=&amp; \\hat{\\beta}_0 \\sum e_i + \\hat{\\beta}_1 \\sum (e_i x_i) \\\\\n=&amp; 0\n\\end{aligned}\nè¯æ¯•\næ„é€ Fåˆ†å¸ƒè¿›è¡Œæ£€éªŒ\nSSR è¶Šå¤§ï¼ŒSSE è¶Šå°è¯´æ˜å›å½’è¶Šå¥½\nH_0: \\beta_1 = 0 \\leftrightarrow H_1: \\beta_1 \\neq 0\nåœ¨ H_0 ä¸‹ï¼ŒF = \\frac{SSR/1}{SSE/(n-2)}ï¼Œ\\frac{SSE}{n-2} \\sim \\chi^2(n-2)ï¼ŒSSR \\sim \\chi^2(1)\n\\Rightarrow F \\xrightarrow{H_0} F(1, n-2)\nçš®å°”é€Šç›¸å…³ç³»æ•°æ£€éªŒ\nr = \\frac{\\sum_{i=1}^{n} (x_i - \\bar{x})(y_i - \\bar{y})}{\\sqrt{\\sum (x_i - \\bar{x})^2 \\sum (y_i - \\bar{y})^2}} = \\frac{l_{xy}}{\\sqrt{l_{xx} l_{yy}}}\nrè¶Šæ¥è¿‘ 1 æ‹Ÿåˆè¶Šå¥½"},"æ•°ç†ç»Ÿè®¡2/å›å½’/ä¸€å…ƒçº¿æ€§å›å½’/6.æ®‹å·®åˆ†æ":{"slug":"æ•°ç†ç»Ÿè®¡2/å›å½’/ä¸€å…ƒçº¿æ€§å›å½’/6.æ®‹å·®åˆ†æ","filePath":"æ•°ç†ç»Ÿè®¡2/å›å½’/ä¸€å…ƒçº¿æ€§å›å½’/6.æ®‹å·®åˆ†æ.md","title":"6.æ®‹å·®åˆ†æ","links":[],"tags":[],"content":"æ®‹å·®åˆ†æï¼šåˆ¤æ–­çœŸå®æ¨¡å‹æ˜¯å¦ä¸ºçº¿æ€§æ¨¡å‹\nè‹¥ä¸ºçº¿æ€§æ¨¡å‹åˆ™å¿…æ»¡è¶³ Ee_i = Ex_i \\cdot e_i = 0\næ®‹å·®åº”åœ¨ 0 é™„è¿‘éšæœºæ³¢åŠ¨\næ®‹å·® e_i çš„æ–¹å·®\n\\begin{aligned}\nVar(e_i) &amp;= Var(y_i - \\hat{y}_i) \\\\\n&amp;= Var(y_i) + Var(\\hat{y}_i) - 2Cov(y_i, \\hat{y}_i)\n\\end{aligned}\n(1) Var(y_i) = \\sigma^2\n(2)\n\\begin{aligned}\nVar(\\hat{y}_i) &amp;= Var(\\hat{\\beta}_0 + \\hat{\\beta}_1 x_i) \\\\\n&amp;= Var(\\hat{\\beta}_0) + Var(\\hat{\\beta}_1 x_i) + 2Cov(\\hat{\\beta}_0, \\hat{\\beta}_1 x_i) \\\\\n\\end{aligned}\nå…¶ä¸­\n\\begin{aligned}\nVar(\\hat{\\beta}_0) &amp;= \\left(\\frac{1}{n} + \\frac{\\bar{x}^2}{L_{xx}}\\right)\\sigma^2 \\\\\n\\\\\nVar(\\hat{\\beta}_1 x_i) &amp;= x_i^2 \\frac{\\sigma^2}{L_{xx}}\\\\\n\\\\\nCov(\\hat{\\beta}_0, \\hat{\\beta}_1) &amp;= Cov(\\bar{y} - \\hat{\\beta}_1 \\bar{x}, \\hat{\\beta}_1) \\\\\n&amp;= Cov(-\\hat{\\beta}_1 \\bar{x}, \\hat{\\beta}_1) + Cov(\\bar{y}, \\hat{\\beta}_1) \\\\\n&amp;= -\\bar{x} Var(\\hat{\\beta}_1) + \\frac{Var(y_i)}{n \\sum (x_i - \\bar{x})^2} \\cdot \\sum (x_i - \\bar{x}) \\\\\n&amp;= -\\bar{x} \\frac{\\sigma^2}{L_{xx}} + 0 \\\\\n\\end{aligned}\næ•…Cov(\\hat{\\beta}_0, \\hat{\\beta}_1 x_i) = -\\bar{x} x_i \\frac{\\sigma^2}{L_{xx}}\næ•…\n\\begin{aligned}\nVar(\\hat{y}_i) &amp;= \\left(\\frac{1}{n} + \\frac{\\bar{x}^2}{L_{xx}}\\right)\\sigma^2 + x_i^2 \\frac{\\sigma^2}{L_{xx}} - 2\\bar{x} x_i \\frac{\\sigma^2}{L_{xx}} \\\\\n&amp;= \\left(\\frac{1}{n} + \\frac{(x_i - \\bar{x})^2}{L_{xx}}\\right)\\sigma^2\n\\end{aligned}\n(3)\n\\begin{aligned}\nCov(y_i, \\hat{y}_i) &amp;= Cov(y_i, \\hat{\\beta}_1 x_i + \\bar{y} - \\hat{\\beta}_1 \\bar{x})\\\\\n&amp;= Cov(y_i, \\hat{\\beta}_1 x_i) + (x_i - \\bar{x}) Cov(y_i, \\hat{\\beta}_1) \\\\\n&amp;= \\frac{1}{n} Var(y_i) + (x_i - \\bar{x}) Cov(y_i, \\frac{\\sum (x_i - \\bar{x}) y_i}{L_{xx}}) \\\\\n&amp;= \\frac{1}{n} Var(y_i) + \\frac{(x_i - \\bar{x})^2}{L_{xx}} Var(y_i) \\\\\n&amp;= \\left(\\frac{1}{n} + \\frac{(x_i - \\bar{x})^2}{L_{xx}}\\right)\\sigma^2\n\\end{aligned}\nç»¼ä¸Šï¼šVar(e_i) = \\sigma^2 + \\left(\\frac{1}{n} + \\frac{(x_i - \\bar{x})^2}{L_{xx}}\\right)\\sigma^2 - 2\\left(\\frac{1}{n} + \\frac{(x_i - \\bar{x})^2}{L_{xx}}\\right)\\sigma^2 = (1 - \\frac{1}{n} - \\frac{(x_i - \\bar{x})^2}{L_{xx}})\\sigma^2 = (1 - \\hat{h}_i)\\sigma^2"},"æ•°ç†ç»Ÿè®¡2/å›å½’/å›å½’æ¨¡å‹":{"slug":"æ•°ç†ç»Ÿè®¡2/å›å½’/å›å½’æ¨¡å‹","filePath":"æ•°ç†ç»Ÿè®¡2/å›å½’/å›å½’æ¨¡å‹.md","title":"å›å½’æ¨¡å‹","links":[],"tags":[],"content":"å˜é‡x_1,\\cdots,x_pä¸éšæœºå˜é‡yå­˜åœ¨ç›¸å…³å…³ç³»ï¼Œå³ç¡®å®šx_1,\\cdots,x_pçš„å–å€¼åå¯ä»¥ç¡®å®šyçš„åˆ†å¸ƒï¼Œyä¸x_1,\\cdots,x_pä¹‹é—´çš„æ¦‚ç‡æ¨¡å‹ä¸ºy=f(x_i,\\cdots,x_p)+\\epsilonå½“fä¸ºçº¿æ€§å‡½æ•°æ—¶ï¼Œç§°æ¨¡å‹ä¸ºçº¿æ€§å›å½’æ¨¡å‹ã€‚"},"æ•°ç†ç»Ÿè®¡2/æ¦‚ç‡è®ºä¸æ•°ç†ç»Ÿè®¡åŸºç¡€/å¸¸ç”¨åˆ†å¸ƒ":{"slug":"æ•°ç†ç»Ÿè®¡2/æ¦‚ç‡è®ºä¸æ•°ç†ç»Ÿè®¡åŸºç¡€/å¸¸ç”¨åˆ†å¸ƒ","filePath":"æ•°ç†ç»Ÿè®¡2/æ¦‚ç‡è®ºä¸æ•°ç†ç»Ÿè®¡åŸºç¡€/å¸¸ç”¨åˆ†å¸ƒ.md","title":"å¸¸ç”¨åˆ†å¸ƒ","links":[],"tags":[],"content":"tåˆ†å¸ƒ\nè‹¥\\epsilon \\sim N(0,1),\\etaæœä»è‡ªç”±åº¦ä¸ºnçš„\\chi^2åˆ†å¸ƒ\\eta \\sim \\chi^2(n),åˆ™ç§°éšæœºå˜é‡T=\\frac{\\epsilon}{\\sqrt{\\frac{\\eta}{n}}}æœä»è‡ªç”±åº¦ä¸ºnçš„tåˆ†å¸ƒï¼ŒT \\sim t(n).\nF åˆ†å¸ƒ\nè®¾\\epsilon,\\etaæ˜¯è‡ªç”±åº¦ä¸ºm,nçš„ç‹¬ç«‹çš„\\chi^2éšæœºå˜é‡ï¼Œåˆ™ç§°éšæœºå˜é‡F=\\frac{\\epsilon/m}{\\eta/n}æ‰€æœä»çš„åˆ†å¸ƒä¸ºFåˆ†å¸ƒï¼Œè‡ªç”±åº¦ä¸º(m,n),è®°ä½œF \\sim F(m,n)."},"æ•°ç†ç»Ÿè®¡2/æ¦‚ç‡è®ºä¸æ•°ç†ç»Ÿè®¡åŸºç¡€/æ–¹å·®ã€åæ–¹å·®çš„æ€§è´¨":{"slug":"æ•°ç†ç»Ÿè®¡2/æ¦‚ç‡è®ºä¸æ•°ç†ç»Ÿè®¡åŸºç¡€/æ–¹å·®ã€åæ–¹å·®çš„æ€§è´¨","filePath":"æ•°ç†ç»Ÿè®¡2/æ¦‚ç‡è®ºä¸æ•°ç†ç»Ÿè®¡åŸºç¡€/æ–¹å·®ã€åæ–¹å·®çš„æ€§è´¨.md","title":"æ–¹å·®ã€åæ–¹å·®çš„æ€§è´¨","links":[],"tags":[],"content":"å¼•ç†\nX,Yç‹¬ç«‹åˆ™å¯¹ä»»ä½•å‡½æ•°h,gæˆç«‹\n E[g(X)g(Y)]=E[g(X)] \\cdot E[h(Y)]\næ–¹å·®ä¸åæ–¹å·®å¸¸ç”¨å…¬å¼\n\nåæ–¹å·®çš„å®šä¹‰Cov(X,Y)=E[(X-EX)(Y-EY)]=E[XY]-EX \\cdot EY\näº¤æ¢æ€§ï¼šCov(X,Y)=Cov(Y,X)\nçº¿æ€§æ€§:Coc(aX,Y)=aCov(X,Y) Cov(\\Sigma_{i=1}^nX_i,\\Sigma_{j=1}^mY_j)=\\Sigma_{i=1}^n\\Sigma_{j=1}^m Cov(X_i,Y_j)\næ–¹å·®å±•å¼€å¼ï¼šVar(\\Sigma_{i=1}^nX_i)=\\Sigma_{i=1}^nVar(X_i)+2\\Sigma_{i&lt;j}Cov(X_i,X_j)\n"},"æ·±åº¦å­¦ä¹ /CNN/1.å·ç§¯":{"slug":"æ·±åº¦å­¦ä¹ /CNN/1.å·ç§¯","filePath":"æ·±åº¦å­¦ä¹ /CNN/1.å·ç§¯.md","title":"1.å·ç§¯","links":[],"tags":[],"content":""},"æ·±åº¦å­¦ä¹ /CNN/2.æ± åŒ–":{"slug":"æ·±åº¦å­¦ä¹ /CNN/2.æ± åŒ–","filePath":"æ·±åº¦å­¦ä¹ /CNN/2.æ± åŒ–.md","title":"2.æ± åŒ–","links":[],"tags":[],"content":""},"æ·±åº¦å­¦ä¹ /CNN/3.å½’ä¸€åŒ–":{"slug":"æ·±åº¦å­¦ä¹ /CNN/3.å½’ä¸€åŒ–","filePath":"æ·±åº¦å­¦ä¹ /CNN/3.å½’ä¸€åŒ–.md","title":"3.å½’ä¸€åŒ–","links":[],"tags":[],"content":""},"æ·±åº¦å­¦ä¹ /CNN/4.å…¨è¿æ¥":{"slug":"æ·±åº¦å­¦ä¹ /CNN/4.å…¨è¿æ¥","filePath":"æ·±åº¦å­¦ä¹ /CNN/4.å…¨è¿æ¥.md","title":"4.å…¨è¿æ¥","links":[],"tags":[],"content":""},"æ·±åº¦å­¦ä¹ /deeplearning-basics/1.Kè¿‘é‚»":{"slug":"æ·±åº¦å­¦ä¹ /deeplearning-basics/1.Kè¿‘é‚»","filePath":"æ·±åº¦å­¦ä¹ /deeplearning basics/1.Kè¿‘é‚».md","title":"1.Kè¿‘é‚»","links":[],"tags":[],"content":"è¿‘é‚»ç®—æ³•\né¦–å…ˆç»™å‡ºä¸€ç»„æ•°æ®X_{\\mathbf{N} \\times \\mathbf{D}}ä»¥åŠå¯¹åº”çš„åˆ†ç±»æ ‡ç­¾Y_\\mathbf{N}ä½œä¸ºè®­ç»ƒæ•°æ®ï¼Œæ•°æ®é‡ä¸ºN,ç‰¹å¾æ•°ä¸ºD,ç±»åˆ«æ•°mä¸ºYä¸­å„ä¸ç›¸åŒçš„æ•°å­—çš„ä¸ªæ•°ã€‚ä¸€èˆ¬æ¥è¯´N&gt;mã€‚\næ¨ç†æ—¶ç»™å‡ºéœ€è¦æ¨ç†çš„Dç»´å‘é‡X_{0}ï¼Œè®¡ç®—å®ƒä¸æ‰€æœ‰å·²çŸ¥æ ‡ç­¾çš„å‘é‡(å³Xè¡Œå‘é‡)çš„L1è·ç¦»ã€‚\nå‘é‡X_0ä¸å‘é‡X_jçš„L1è·ç¦»å®šä¹‰ä¸ºï¼š\nd_{L1}=\\sum_{i=1}^{D} |X_0^i-X_j^i|\næ‰¾å‡ºå…¶ä¸­d_{L1}æœ€å°çš„j,å¯¹åº”çš„Y_jå³ä¸ºX_0çš„åˆ†ç±»æ ‡ç­¾ã€‚\nä»£ç å¦‚ä¸‹ï¼š\nclass NeraestNeibour:\n\tdef __init__(self):\n\t\tpass\n\tdef train(self,Xtr,Ytr):\n\t\tself.Xtr=Xtr\n\t\tself.Ytr=Ytr\n\tdef predict(self,X):\n\t\tnum_test=X.shape[0]\n\t\tYpred=np.zeros(num_test,dtype=self.Xtr.dtype)\n\t\tfor i in range(num_test):\n\t\t\td_L1_vec=np.sum(np.abs(self.Xtr-X[i:]),axis=1)\n\t\t\t# d_L1_vecæ˜¯ä¸€ä¸ªNç»´å‘é‡ï¼Œè®°å½•äº†X[i]åˆ°æ‰€æœ‰å·²çŸ¥æ ‡ç­¾å‘é‡Xçš„L1è·ç¦»\n\t\t\t# è¿™è¡Œä»£ç åˆ©ç”¨äº†numpyçš„æ•°ç»„å¹¿æ’­ï¼Œæ±‚å’Œæ—¶axis=1è¡¨ç¤ºæ²¿ç€åˆ—å·å¢å¤§çš„æ–¹å‘æ±‚å’Œ\n\t\t\tmin_index=np.argmin(d_L1_vec)\n\t\t\tYpred=self.Ytr[min_index]\n\t\treturn Ypred\nKè¿‘é‚»ç®—æ³•\nKè¿‘é‚»ç®—æ³•æ˜¯è¿‘é‚»ç®—æ³•çš„æ‰©å±•ï¼Œè¿‘é‚»ç®—æ³•åªå…³å¿ƒæœ€è¿‘çš„ä¸€ä¸ªç‚¹çš„æ ‡ç­¾ï¼Œè€ŒKè¿‘é‚»åˆ™ç”¨æœ€è¿‘çš„Kä¸ªç‚¹çš„æ ‡ç­¾è¿›è¡ŒæŠ•ç¥¨å†³å®šæœªçŸ¥ç‚¹çš„åˆ†ç±»æ ‡ç­¾é¢„æµ‹å€¼ã€‚è®¡ç®—å‡ºd_L1_vecåï¼Œå–å‡ºå…¶ä¸­æœ€å°çš„å‰Kåï¼Œæ‰¾å‡ºå‰Kåå¯¹åº”çš„æ ‡ç­¾ï¼Œä»¥å…¶ä¸­å ä¼—æ•°çš„æ ‡ç­¾ä¸ºæœªçŸ¥ç‚¹çš„é¢„æµ‹å€¼ã€‚\nä»£ç å¦‚ä¸‹ï¼š\nclass KNearestNeighbor:\n    def __init__(self):\n        pass\n    \n    def train(self, Xtr, Ytr):\n        self.Xtr = Xtr\n        self.Ytr = Ytr\n    \n    def predict(self, X, k=1):\n        num_test = X.shape[0]\n        Ypred = np.zeros(num_test, dtype=self.Ytr.dtype)\n        \n        for i in range(num_test):\n            # è®¡ç®—æµ‹è¯•ç‚¹X[i]ä¸æ‰€æœ‰è®­ç»ƒç‚¹çš„L1è·ç¦»\n            d_L1_vec = np.sum(np.abs(self.Xtr - X[i]), axis=1)\n            # d_L1_vecæ˜¯ä¸€ä¸ªNç»´å‘é‡ï¼Œè®°å½•äº†X[i]åˆ°æ‰€æœ‰å·²çŸ¥æ ‡ç­¾å‘é‡Xçš„L1è·ç¦»\n            \n            # æ‰¾å‡ºè·ç¦»æœ€å°çš„kä¸ªç‚¹çš„ç´¢å¼•\n            min_indices = np.argsort(d_L1_vec)[:k]\n            \n            # è·å–è¿™kä¸ªæœ€è¿‘é‚»çš„æ ‡ç­¾\n            k_nearest_labels = self.Ytr[min_indices]\n            \n            # æ‰¾å‡ºå‡ºç°é¢‘ç‡æœ€é«˜çš„æ ‡ç­¾ï¼ˆä¼—æ•°ï¼‰\n            unique_labels, counts = np.unique(\n\t            k_nearest_labels,return_counts=True\n\t            )\n            most_frequent_label = unique_labels[np.argmax(counts)]\n            \n            Ypred[i] = most_frequent_label\n            \n        return Ypred\nç”±æ­¤å¯è§ï¼Œè¿‘é‚»ç®—æ³•æœ¬è´¨ä¸Šå°±æ˜¯K=1çš„Kè¿‘é‚»ç®—æ³•\nè·ç¦»çš„å®šä¹‰\nä¸Šè¿°ç®—æ³•ä¸­ä½¿ç”¨çš„L1è·ç¦»åœ¨æ•°å­¦ä¸Šç§°ä¸ºæ›¼å“ˆé¡¿è·ç¦»ï¼Œå¸¸ç”¨çš„è¿˜æœ‰æ¬§å¼è·ç¦»å’Œä½™å¼¦è·ç¦»ã€‚\næ›¼å“ˆé¡¿è·ç¦» (L1è·ç¦»)\nd_{L1} = \\sum_{i=1}^{D} |X_0^i - X_j^i|\næ¬§å¼è·ç¦» (L2è·ç¦»)\nd_{L2} = \\sqrt{\\sum_{i=1}^{D} (X_0^i - X_j^i)^2}\nä½™å¼¦è·ç¦»\nd_{\\cos} = 1 - \\frac{X_0 \\cdot X_j}{||X_0||_2 \\cdot ||X_j||_2}\nå…¶ä¸­ï¼š\n\nX_0 å’Œ X_j åˆ†åˆ«æ˜¯ä¸¤ä¸ªDç»´å‘é‡\n||X||_2 = \\sqrt{\\sum_{i=1}^{D} X_i^2} æ˜¯å‘é‡çš„L2èŒƒæ•°\n\nå„è·ç¦»çš„ç‰¹ç‚¹kï¼š\n\næ›¼å“ˆé¡¿è·ç¦»ï¼šè®¡ç®—è·¯å¾„é•¿åº¦ï¼Œå¯¹å¼‚å¸¸å€¼ç›¸å¯¹ä¸æ•æ„Ÿ\næ¬§å¼è·ç¦»ï¼šæœ€ç›´è§‚çš„è·ç¦»åº¦é‡ï¼Œåœ¨æ¬§å‡ é‡Œå¾—ç©ºé—´ä¸­ä¸¤ç‚¹é—´ç›´çº¿è·ç¦»\nä½™å¼¦è·ç¦»ï¼šå…³æ³¨å‘é‡çš„æ–¹å‘è€Œéå¤§å°ï¼Œé€‚ç”¨äºæ–‡æœ¬åˆ†ç±»ç­‰åœºæ™¯\n\nå‚æ•°Kçš„é€‰æ‹©\nä¸Šè¿°Kè¿‘é‚»ç®—æ³•å¹¶ä¸æ˜¯æ ‡å‡†æ„ä¹‰ä¸Šçš„æ·±åº¦å­¦ä¹ ï¼Œå› ä¸ºå®ƒæ˜¯ä¸€å¥—å›ºå®šçš„è¿ç®—æœºåˆ¶ï¼Œåªèƒ½ç®—ä½œä¸€ç§ç¨‹åºç®—æ³•ã€‚\nåœ¨Kè¿‘é‚»ç®—æ³•ä¸­ï¼Œå‚æ•°KåŸæœ¬æ˜¯ä¸€ä¸ªéœ€è¦æ‰‹åŠ¨é€‰æ‹©çš„è¶…å‚æ•°ï¼Œä½†åœ¨æ·±åº¦å­¦ä¹ ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥è€ƒè™‘è®©æ¨¡å‹æ¥è‡ªåŠ¨é€‰æ‹©è¶…å‚æ•°ï¼Œå¯¹è¶…å‚æ•°çš„è‡ªåŠ¨é€‰æ‹©æ˜¯æ·±åº¦å­¦ä¹ çš„å…³é”®ã€‚\nå°†è®­ç»ƒæ•°æ®åˆ†ä¸ºäº’ä¸ç›¸äº¤çš„ä¸‰ä¸ªéƒ¨åˆ†ï¼šè®­ç»ƒé›†(training)ã€éªŒè¯é›†(validation)ã€æµ‹è¯•é›†(test)\næ³¨ï¼šä¸¥æ ¼æ¥è®²ï¼Œæ•°æ®çš„ä¸‰éƒ¨åˆ†ä¸ä»…éœ€è¦ä¸ç›¸äº¤ï¼Œä»–ä»¬éœ€è¦åœ¨æ¦‚ç‡æ„ä¹‰ä¸Šç‹¬ç«‹ã€‚\nåœ¨æœºå™¨å­¦ä¹ å’Œæ·±åº¦å­¦ä¹ ä¸­ï¼Œå¦‚æœæ•°æ®é‡è¾ƒå°ï¼Œå¾€å¾€é‡‡ç”¨å„ç§é‡æŠ½æ ·çš„æ–¹å¼å¯¹æ•°æ®è¿›è¡Œå¢å¼ºï¼Œå°†é‡æŠ½æ ·çš„æ•°æ®è¿›è¡Œè®­ç»ƒé›†ã€éªŒè¯é›†ã€æµ‹è¯•é›†åˆ’åˆ†æ˜¯é”™è¯¯çš„ï¼Œå› ä¸ºå°½ç®¡æ¯æ¡æ•°æ®ä¹‹é—´å„ä¸ç›¸åŒï¼Œä½†å®ƒä»¬åœ¨æ¦‚ç‡æ„ä¹‰ä¸Šä¸ç‹¬ç«‹ã€‚æ­£ç¡®çš„åšæ³•æ˜¯å…ˆåˆ’åˆ†å†é‡æŠ½æ ·å¢å¼ºã€‚\nç®—æ³•éµå¾ªä»¥ä¸‹æ­¥éª¤ï¼š\n\n1.æˆ‘é—¨ä»¬å…ˆç»™å®šK\n2.åœ¨è®­ç»ƒé›†ä¸Šå¾—åˆ°åˆ†ç±»æ¨¡å‹\n3.åœ¨éªŒè¯é›†ä¸Šè¿›è¡Œæ¨ç†\n4.æ¯”å¯¹æ¨ç†ç»“æœä¸éªŒè¯é›†æ ‡ç­¾å¹¶è®¡ç®—æ­£ç¡®ç‡\n5.è°ƒèŠ‚å‚æ•°Kå¹¶é‡å¤æ­¥éª¤2è‡³5ç›´åˆ°å¾—åˆ°æ»¡æ„çš„è¶…å‚æ•°K\n6.åœ¨æµ‹è¯•é›†ä¸Šæ¨ç†å¹¶è®¡ç®—æœ€ç»ˆæ¨¡å‹çš„å‡†ç¡®ç‡\n\næ³¨æ„ï¼šä¸€ä¸ªå¸¸è§çš„è¯¯åŒºæ˜¯ï¼Œåªå°†æ•°æ®åˆ†ä¸ºè®­ç»ƒé›†å’Œæµ‹è¯•é›†ï¼Œåœ¨æµ‹è¯•é›†ä¸Šè°ƒèŠ‚å‚æ•°K,æœ€ç»ˆåœ¨æµ‹è¯•é›†ä¸Šè®¡ç®—æ¨¡å‹å‡†ç¡®ç‡ï¼Œè¿™ç§æ–¹æ³•æ˜¯é”™è¯¯çš„ã€‚æµ‹è¯•é›†ç›¸å½“äºä¸€åœºè€ƒè¯•ï¼ŒéªŒè¯é›†æ˜¯æ¨¡æ‹Ÿè€ƒè¯•ï¼Œå¦‚æœæ¨¡æ‹Ÿè€ƒè¯•å’ŒçœŸå®çš„è€ƒè¯•é¢˜ç›®ä¸€æ ·ï¼Œé‚£ä¹ˆå°±å¤±å»äº†å­¦ä¹ å’Œè€ƒè¯•çš„æ„ä¹‰ã€‚è¿™æ ·å¾—åˆ°çš„æ¨¡å‹å‡†ç¡®ç‡æ˜¯è™šé«˜çš„ã€‚"},"æ·±åº¦å­¦ä¹ /deeplearning-basics/2.çº¿æ€§åˆ†ç±»å™¨":{"slug":"æ·±åº¦å­¦ä¹ /deeplearning-basics/2.çº¿æ€§åˆ†ç±»å™¨","filePath":"æ·±åº¦å­¦ä¹ /deeplearning basics/2.çº¿æ€§åˆ†ç±»å™¨.md","title":"2.çº¿æ€§åˆ†ç±»å™¨","links":["æ·±åº¦å­¦ä¹ /deeplearning-basics/3.softmaxæŸå¤±","æ·±åº¦å­¦ä¹ /deeplearning-basics/4.SVMæŸå¤±"],"tags":[],"content":"åŸºæœ¬æ€æƒ³\nçº¿æ€§åˆ†ç±»å™¨æ˜¯ä¸€ç±»é€šè¿‡ è¾“å…¥ç‰¹å¾çš„çº¿æ€§ç»„åˆ æ¥è¿›è¡Œåˆ†ç±»çš„æ¨¡å‹ã€‚\nå…¶æ ¸å¿ƒæ€æƒ³æ˜¯ç”¨ä¸€ä¸ªè¶…å¹³é¢å°†ä¸åŒç±»åˆ«çš„æ•°æ®åˆ†å¼€ã€‚\næ•°å­¦å½¢å¼\nç»™å®šè¾“å…¥å‘é‡ x \\in \\mathbb{R}^dï¼Œæƒé‡çŸ©é˜µ W \\in \\mathbb{R}^{d \\times K}ï¼Œåç½®å‘é‡ b \\in \\mathbb{R}^Kï¼Œ\nçº¿æ€§åˆ†ç±»å™¨çš„è¾“å‡ºï¼ˆlogitsï¼‰ä¸ºï¼š\ns = W^\\top x + b\nå…¶ä¸­ s \\in \\mathbb{R}^Kï¼Œè¡¨ç¤ºå¯¹ K ä¸ªç±»åˆ«çš„æ‰“åˆ†ã€‚\né¢„æµ‹ç±»åˆ«ä¸ºï¼š\n\\hat{y} = \\arg\\max_j s_j\nå¸¸è§çš„çº¿æ€§åˆ†ç±»å™¨\n\n\næ„ŸçŸ¥æœºï¼ˆPerceptronï¼‰\n\nä½¿ç”¨ç¬¦å·å‡½æ•°ä½œä¸ºåˆ†ç±»ä¾æ®\nä»…èƒ½å¤„ç†çº¿æ€§å¯åˆ†çš„æ•°æ®\n\n\n\né€»è¾‘å›å½’ï¼ˆLogistic Regressionï¼‰\n\nä½¿ç”¨ sigmoid/softmax3.softmaxæŸå¤± å°†çº¿æ€§è¾“å‡ºè½¬ä¸ºæ¦‚ç‡\næŸå¤±å‡½æ•°ï¼šå¯¹æ•°ä¼¼ç„¶ï¼ˆäº¤å‰ç†µï¼‰\n\n\n\næ”¯æŒå‘é‡æœºï¼ˆSVMï¼‰\n\né€šè¿‡æœ€å¤§åŒ–é—´éš”æ¥å¯»æ‰¾æœ€ä¼˜è¶…å¹³é¢\næŸå¤±å‡½æ•°ï¼šåˆé¡µæŸå¤±ï¼ˆhinge lossï¼‰4.SVMæŸå¤±\n\n\n"},"æ·±åº¦å­¦ä¹ /deeplearning-basics/3.softmaxæŸå¤±":{"slug":"æ·±åº¦å­¦ä¹ /deeplearning-basics/3.softmaxæŸå¤±","filePath":"æ·±åº¦å­¦ä¹ /deeplearning basics/3.softmaxæŸå¤±.md","title":"3.softmaxæŸå¤±","links":[],"tags":[],"content":"1. ç†µï¼ˆEntropyï¼‰\nç†µæ˜¯ä¿¡æ¯è®ºä¸­çš„æ¦‚å¿µï¼Œç”¨æ¥åº¦é‡ä¸€ä¸ªéšæœºå˜é‡çš„ä¸ç¡®å®šæ€§ã€‚\nè®¾ç¦»æ•£éšæœºå˜é‡ X å¯èƒ½çš„å–å€¼ä¸º {x_1, x_2, \\dots, x_n}ï¼Œæ¦‚ç‡åˆ†å¸ƒä¸º\nP(X=x_i) = p_i, \\quad \\sum_{i=1}^n p_i = 1  \nç†µçš„å®šä¹‰æ˜¯ï¼š\nH(P) = -\\sum_{i=1}^n p_i \\log p_i  \næ„ä¹‰ï¼šæ¦‚ç‡åˆ†å¸ƒè¶Šå‡åŒ€ï¼Œç†µè¶Šå¤§ï¼ˆä¸ç¡®å®šæ€§é«˜ï¼‰ã€‚æ¦‚ç‡åˆ†å¸ƒè¶Šé›†ä¸­ï¼Œç†µè¶Šå°ã€‚\n\n2. äº¤å‰ç†µï¼ˆCross-Entropyï¼‰\näº¤å‰ç†µç”¨æ¥åº¦é‡ä¸¤ä¸ªåˆ†å¸ƒ (P) å’Œ (Q) ä¹‹é—´çš„å·®å¼‚ï¼Œå…¶ä¸­ï¼š\n\n\nP = (p_1, p_2, \\dots, p_n) è¡¨ç¤ºçœŸå®åˆ†å¸ƒï¼ˆground truthï¼‰\n\n\nQ = (q_1, q_2, \\dots, q_n) è¡¨ç¤ºé¢„æµ‹åˆ†å¸ƒï¼ˆæ¨¡å‹è¾“å‡ºï¼‰\n\n\näº¤å‰ç†µå®šä¹‰ä¸ºï¼š\nH(P, Q) = -\\sum_{i=1}^n p_i \\log q_i  \nåœ¨åˆ†ç±»é—®é¢˜ä¸­ï¼ŒçœŸå®æ ‡ç­¾é€šå¸¸æ˜¯ one-hot å‘é‡ï¼Œæ¯”å¦‚çœŸå®ç±»åˆ«æ˜¯ç¬¬ (k) ç±»ï¼Œåˆ™ï¼š\nH(P, Q) = - \\log q_k  \nè¿™å°±æ˜¯å¸¸ç”¨çš„åˆ†ç±»æŸå¤±å‡½æ•° äº¤å‰ç†µæŸå¤±ï¼ˆCross-Entropy Lossï¼‰ã€‚\n3. Softmax\nSoftmax ç”¨äºå°†æ¨¡å‹è¾“å‡ºçš„ å®æ•°å‘é‡ è½¬æ¢ä¸º æ¦‚ç‡åˆ†å¸ƒã€‚\nè®¾æ¨¡å‹è¾“å‡ºçš„ logits å‘é‡ä¸ºï¼š\nz = (z_1, z_2, \\dots, z_n)  \nSoftmax å…¬å¼ä¸ºï¼š\n\\text{softmax}(z_i) = \\frac{e^{z_i}}{\\sum_{j=1}^n e^{z_j}}, \\quad i=1,\\dots,n  \næ€§è´¨ï¼š\n\n\nè¾“å‡ºç»“æœæ»¡è¶³ q_i \\geq 0ï¼Œä¸” \\sum_i q_i = 1ã€‚\n\n\nå¸¸ä½œä¸ºåˆ†ç±»ä»»åŠ¡æœ€åä¸€å±‚ï¼ŒæŠŠ logits å˜æˆæ¦‚ç‡åˆ†å¸ƒ Q = (q_1, \\dots, q_n)ã€‚\n\n\n4. Softmax æŸå¤±ï¼ˆSoftmax Lossï¼‰\nåœ¨åˆ†ç±»ä»»åŠ¡é‡Œï¼ŒSoftmax å‡½æ•°é€šå¸¸å’Œ äº¤å‰ç†µæŸå¤± ç»“åˆä½¿ç”¨ï¼Œè¿™ä¸ªç»„åˆæœ‰æ—¶å°±è¢«ç§°ä¸º Softmax æŸå¤±ã€‚\nå‡è®¾æœ‰kç±»ï¼Œå¯¹äºä¸€ä¸ªæ ·æœ¬ï¼Œè®¾çœŸå®æ ‡ç­¾ä¸º (y)ï¼Œåˆ™è¯¥æ ·æœ¬åœ¨å„ç±»çš„æ¦‚ç‡åˆ†å¸ƒ\\{p_1, \\cdots,p_k\\}å¹¶ç”¨ one-hot å‘é‡è¡¨ç¤ºï¼š\np_i =\n\\left\\{\n\\begin{array}{ll}\n1, &amp; i = y \\\\\n0, &amp; i \\neq y\n\\end{array}\n\\right.\né¢„æµ‹åˆ†å¸ƒæ˜¯ q_i = \\text{softmax}(z_i)ã€‚\näº¤å‰ç†µæŸå¤±æ˜¯ï¼š\nL = -\\sum_{i=1}^n p_i \\log q_i  \nç”±äº one-hot çš„æ€§è´¨ï¼Œåªæœ‰æ­£ç¡®ç±»åˆ«çš„é‚£ä¸€é¡¹ä¿ç•™ä¸‹æ¥ï¼Œæ‰€ä»¥ï¼š\nL = - \\log q_y  \nå†æŠŠ q_y å±•å¼€ï¼š\nq_y = \\frac{e^{z_y}}{\\sum_{j=1}^n e^{z_j}}  \næœ€ç»ˆ å•ä¸ªæ ·æœ¬çš„Softmax æŸå¤±å‡½æ•°ä¸ºï¼š\nL = - \\log \\frac{e^{z_y}}{\\sum_{j=1}^n e^{z_j}}  \n= - z_y + \\log \\left( \\sum_{j=1}^n e^{z_j} \\right)  \nå¯¹äºæ•´ä¸ªè¾“å…¥batchï¼Œå°†å„ä¸ªæ ·æœ¬çš„SoftmaxæŸå¤±å–å¹³å‡ï¼Œä½œä¸ºè¯¥batchçš„æ€»ä½“æŸå¤±ã€‚\n\n3. æ€»ç»“\n\n\nSoftmaxï¼šæŠŠ logits è½¬ä¸ºæ¦‚ç‡åˆ†å¸ƒã€‚\n\n\nCross-Entropyï¼šåº¦é‡é¢„æµ‹åˆ†å¸ƒå’ŒçœŸå®åˆ†å¸ƒçš„å·®å¼‚ã€‚\n\n\nSoftmax Lossï¼šå°±æ˜¯â€œSoftmax + äº¤å‰ç†µâ€çš„ç»„åˆå…¬å¼ï¼š\nL = - z_y + \\log \\left( \\sum_{j=1}^n e^{z_j} \\right)  \n\n\nç¤ºä¾‹\nclass SoftmaxClassifier:\n    &quot;&quot;&quot;\n    è¿™æ˜¯ä¸€ä¸ªåŸºäºsoftmaxæŸå¤±å‡½æ•°çš„çº¿æ€§åˆ†ç±»å™¨\n    &quot;&quot;&quot;\n \n    def __init__(self, Xtr, Ytr):\n        self.Xtr = Xtr\n        self.Ytr = Ytr\n        self.feature_dim = Xtr.shape[1]\n        self.num_classes = len(torch.unique(Ytr))\n        self.W = torch.randn(\n\t        self.feature_dim, self.num_classes, requires_grad=True\n\t        )\n        self.b = torch.zeros(1, self.num_classes, requires_grad=True)\n \n    @staticmethod\n    def softmax(X):\n        X_exp = torch.exp(X)\n        partition = X_exp.sum(1, keepdim=True)\n        return X_exp / partition\n \n    def loss(self, X, Y, reg):\n        num_train = X.shape[0]\n        scores = X.mm(self.W) + self.b\n        probs = self.softmax(scores)\n        correct_logprobs = -torch.log(probs[range(num_train), Y])\n        data_loss = correct_logprobs.mean()\n        reg_loss = 0.5 * reg * (self.W**2).sum()\n        loss = data_loss + reg_loss\n        return loss\n "},"æ·±åº¦å­¦ä¹ /deeplearning-basics/4.SVMæŸå¤±":{"slug":"æ·±åº¦å­¦ä¹ /deeplearning-basics/4.SVMæŸå¤±","filePath":"æ·±åº¦å­¦ä¹ /deeplearning basics/4.SVMæŸå¤±.md","title":"4.SVMæŸå¤±","links":[],"tags":[],"content":"1. åŸå§‹äºŒåˆ†ç±» SVMï¼ˆHinge Lossï¼‰\n\nè¾“å…¥ï¼šlogit åˆ†æ•°\ns = w^\\top x + b\næ ‡ç­¾ï¼šy \\in \\{-1, +1\\}\næŸå¤±å‡½æ•°ï¼š\nL = \\max(0, 1 - y \\cdot s)\n\nè¯´æ˜ï¼š\n\nåˆ†ç±»æ­£ç¡®ä¸”ç¦»è¾¹ç•Œå¤§äº 1ï¼ŒæŸå¤±ä¸º 0\nåˆ†ç±»æ­£ç¡®ä½†é è¿‘è¾¹ç•Œï¼ŒæŸå¤± &gt; 0\nåˆ†ç±»é”™è¯¯ï¼ŒæŸå¤±å¾ˆå¤§\n\n2. æ·±åº¦å­¦ä¹ è¯­å¢ƒä¸‹çš„å¤šåˆ†ç±» SVMï¼ˆMulti-class Hinge Lossï¼‰\n\næ¨¡å‹è¾“å‡ºï¼šlogits\ns = (s_1, s_2, \\dots, s_K)\nçœŸå®ç±»åˆ«ï¼šy \\in \\{1,2,\\dots,K\\}\næŸå¤±å‡½æ•°ï¼š\nL = \\sum_{j \\neq y} \\max(0, s_j - s_y + \\Delta), \\quad \\Delta = 1\n\nè¯´æ˜ï¼š\n\nè¦æ±‚æ­£ç¡®ç±»åˆ«å¾—åˆ† s_y æ¯”é”™è¯¯ç±»åˆ«å¾—åˆ†è‡³å°‘å¤§ä¸€ä¸ª margin \\Delta\nä¸ä¾èµ– softmaxï¼Œä¸éœ€è¦æ¦‚ç‡è§£é‡Š\n"},"æ·±åº¦å­¦ä¹ /deeplearning-basics/5.æ­£åˆ™åŒ–":{"slug":"æ·±åº¦å­¦ä¹ /deeplearning-basics/5.æ­£åˆ™åŒ–","filePath":"æ·±åº¦å­¦ä¹ /deeplearning basics/5.æ­£åˆ™åŒ–.md","title":"5.æ­£åˆ™åŒ–","links":[],"tags":[],"content":"é€šè¿‡å°†æ¨¡å‹çš„æ€»å¤æ‚ç¨‹åº¦åŠ åˆ°æŸå¤±å‡½æ•°ä¸­ï¼Œå¯ä»¥é™åˆ¶æ¨¡å‹çš„å¤æ‚ç¨‹åº¦ï¼Œé¿å…è¿‡æ‹Ÿåˆã€‚\næ€»ä½“å½¢å¼ä¸ºï¼š\nL = L_{\\text{data}} + \\lambda \\, \\Omega(\\theta)\nå…¶ä¸­ï¼š\n\nL_{\\text{data}} ï¼šåŸå§‹æŸå¤±ï¼ˆå¦‚äº¤å‰ç†µã€MSEï¼‰\n\\Omega(\\theta) ï¼šæ­£åˆ™é¡¹ï¼Œç”¨äºè¡¡é‡æ¨¡å‹çš„å¤æ‚ç¨‹åº¦\n\\lambda ï¼šæ­£åˆ™åŒ–å¼ºåº¦ï¼ˆè¶…å‚æ•°ï¼‰\n\n\nå¸¸è§çš„æ­£åˆ™é¡¹\n1. L2 æ­£åˆ™åŒ–ï¼ˆRidge, æƒé‡è¡°å‡ï¼‰\n\nå®šä¹‰ï¼š\n\\Omega(\\theta) = \\frac{1}{2}\\|\\theta\\|_2^2 = \\frac{1}{2}\\sum_i \\theta_i^2\nç‰¹ç‚¹ï¼š\n\næƒ©ç½šæƒé‡çš„å¹³æ–¹\nå€¾å‘äºä½¿æƒé‡æ•´ä½“è¾ƒå°ã€åˆ†å¸ƒå‡åŒ€\nåœ¨æ·±åº¦å­¦ä¹ ä¸­å¸¸ç§°ä¸º weight decay\n\n\n\n2. L1 æ­£åˆ™åŒ–ï¼ˆLassoï¼‰\n\nå®šä¹‰ï¼š\n\\Omega(\\theta) = \\|\\theta\\|_1 = \\sum_i |\\theta_i|\nç‰¹ç‚¹ï¼š\n\nå€¾å‘äºäº§ç”Ÿç¨€ç–è§£ï¼ˆå¾ˆå¤šå‚æ•°å˜ä¸º 0ï¼‰\nå¯ç”¨äºç‰¹å¾é€‰æ‹©\n\n\n\n3. å¼¹æ€§ç½‘ç»œï¼ˆElastic Netï¼‰\n\nå®šä¹‰ï¼š\n\\Omega(\\theta) = \\alpha \\|\\theta\\|_1 + (1-\\alpha)\\frac{1}{2}\\|\\theta\\|_2^2\nç‰¹ç‚¹ï¼š\n\nL1 ä¸ L2 çš„ç»“åˆ\næ—¢èƒ½ç¨€ç–åŒ–ï¼Œåˆèƒ½ä¿æŒç¨³å®šæ€§\n\n\n"},"æ·±åº¦å­¦ä¹ /deeplearning-basics/6.ä¼˜åŒ–å™¨":{"slug":"æ·±åº¦å­¦ä¹ /deeplearning-basics/6.ä¼˜åŒ–å™¨","filePath":"æ·±åº¦å­¦ä¹ /deeplearning basics/6.ä¼˜åŒ–å™¨.md","title":"6.ä¼˜åŒ–å™¨","links":[],"tags":[],"content":""},"æ·±åº¦å­¦ä¹ /deeplearning-basics/7.ç¥ç»ç½‘ç»œ":{"slug":"æ·±åº¦å­¦ä¹ /deeplearning-basics/7.ç¥ç»ç½‘ç»œ","filePath":"æ·±åº¦å­¦ä¹ /deeplearning basics/7.ç¥ç»ç½‘ç»œ.md","title":"7.ç¥ç»ç½‘ç»œ","links":[],"tags":[],"content":""},"æ·±åº¦å­¦ä¹ /deeplearning-basics/8.æ¢¯åº¦å›ä¼ ":{"slug":"æ·±åº¦å­¦ä¹ /deeplearning-basics/8.æ¢¯åº¦å›ä¼ ","filePath":"æ·±åº¦å­¦ä¹ /deeplearning basics/8.æ¢¯åº¦å›ä¼ .md","title":"8.æ¢¯åº¦å›ä¼ ","links":[],"tags":[],"content":""},"æ·±åº¦å­¦ä¹ /deeplearning-basics/index":{"slug":"æ·±åº¦å­¦ä¹ /deeplearning-basics/index","filePath":"æ·±åº¦å­¦ä¹ /deeplearning basics/index.md","title":"deeplearning basics","links":["æ·±åº¦å­¦ä¹ /deeplearning-basics/1.Kè¿‘é‚»","æ·±åº¦å­¦ä¹ /deeplearning-basics/2.çº¿æ€§åˆ†ç±»å™¨","æ·±åº¦å­¦ä¹ /deeplearning-basics/3.softmaxæŸå¤±","æ·±åº¦å­¦ä¹ /deeplearning-basics/4.SVMæŸå¤±","æ·±åº¦å­¦ä¹ /deeplearning-basics/5.æ­£åˆ™åŒ–","æ·±åº¦å­¦ä¹ /deeplearning-basics/6.ä¼˜åŒ–å™¨","æ·±åº¦å­¦ä¹ /deeplearning-basics/7.ç¥ç»ç½‘ç»œ","æ·±åº¦å­¦ä¹ /deeplearning-basics/8.æ¢¯åº¦å›ä¼ "],"tags":[],"content":"æœ¬ç« èŠ‚ä»å›¾ç‰‡åˆ†ç±»ä»»åŠ¡å…¥æ‰‹ï¼Œä»¥æœ€åŸºæœ¬çš„æ¨¡å‹ä¸ºä¾‹ä»‹ç»äº†æ·±åº¦å­¦ä¹ æ¨¡å‹çš„åŸºæœ¬ç»“æ„ã€‚\n\nåˆ†ç±»å™¨ 1.Kè¿‘é‚» 2.çº¿æ€§åˆ†ç±»å™¨\næŸå¤±å‡½æ•° 3.softmaxæŸå¤± 4.SVMæŸå¤±\næ­£åˆ™åŒ– 5.æ­£åˆ™åŒ–\nä¼˜åŒ–å™¨ 6.ä¼˜åŒ–å™¨\nç¥ç»ç½‘ç»œ7.ç¥ç»ç½‘ç»œ\næ¢¯åº¦å›ä¼ 8.æ¢¯åº¦å›ä¼ \n"}}